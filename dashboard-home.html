<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ThriftMap</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Index page global styles to match navbar -->
    <link rel="stylesheet" href="./assets/css/style-prefix.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: #f8fafc;
        }
        
        .sidebar {
            transition: all 0.3s ease;
        }
        
        .sidebar-collapsed {
            width: 70px;
        }
        
        .sidebar-collapsed .sidebar-text {
            display: none;
        }
        
        .main-content {
            transition: all 0.3s ease;
        }
        
        .main-content-expanded {
            margin-left: 70px;
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Remove black outline */
        * {
            outline: none !important;
        }
        
        button:focus, button:hover, button:active { outline: none !important; }

    /* Shopping app pieces */
    .chip { padding: 0.5rem 1rem; border-radius: 9999px; background: #fff; border: 1px solid #e5e7eb; color: #374151; cursor: pointer; transition: all .2s ease; white-space: nowrap; display: inline-flex; align-items: center; }
    .chip:hover { border-color: #10b981; color: #047857; }
    .chip-active { background: #ecfdf5; border-color: #10b981; color: #047857; }
        .carousel { scroll-snap-type: x mandatory; }
        .carousel > * { scroll-snap-align: start; }
        .banner-gradient-1 { background: linear-gradient(135deg,#d1fae5,#a7f3d0); }
        .banner-gradient-2 { background: linear-gradient(135deg,#e0e7ff,#c7d2fe); }
        .banner-gradient-3 { background: linear-gradient(135deg,#fee2e2,#fecaca); }
        .badge-sale {
            position: absolute;
            top: 14px;
            left: 14px;
            background: #fee2e2;
            color: #b91c1c;
            padding: 0.35rem 0.65rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.18);
        }
        .btn { transition: all .25s ease; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(16,185,129,.25); }
    .h-scroll { overflow-x: auto; overflow-y: hidden; -webkit-overflow-scrolling: touch; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    /* Better pointer behavior for horizontal scroll area */
    #categoryChips { touch-action: pan-x; }
    #categoryChips.dragging { cursor: grabbing; }

        /* Chips scroll arrows */
        .chips-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 36px;
            height: 36px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            border: 1px solid #e5e7eb;
            color: #374151;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            z-index: 5;
            transition: all .2s ease;
        }
        .chips-arrow:hover { background: #ecfdf5; color: #047857; border-color: #10b981; }
        .chips-arrow:disabled { opacity: .35; cursor: default; pointer-events: none; }
        .chips-arrow--left { left: 6px; }
        .chips-arrow--right { right: 6px; }

        /* Hero carousel enhancements */
        .hero-slide {
            position: relative;
            min-width: 100%;
            border-radius: 1.5rem;
            padding: clamp(1.75rem, 4vw, 2.75rem);
            color: #0f172a;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
            background: var(--hero-bg, var(--hero-fallback, linear-gradient(135deg,#ecfdf5,#d1fae5)));
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            overflow: hidden;
            box-shadow: 0 16px 45px rgba(15, 118, 110, 0.12);
        }

        .hero-slide::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(120deg, rgba(255,255,255,0.92) 0%, rgba(255,255,255,0.58) 60%, rgba(255,255,255,0.25) 100%);
            backdrop-filter: blur(1.5px);
        }

        .hero-slide--loaded::before {
            background: linear-gradient(115deg, rgba(255,255,255,0.92) 0%, rgba(255,255,255,0.5) 55%, rgba(255,255,255,0.18) 100%);
        }

        .hero-slide-content,
        .hero-slide-media {
            position: relative;
            z-index: 1;
        }

        .hero-slide-content h2 {
            color: #0f172a;
        }

        .hero-slide-content p {
            color: rgba(51, 65, 85, 0.95);
        }

        .hero-slide-media {
            display: none;
            color: rgba(22, 101, 52, 0.9);
        }

        .hero-slide-media i { text-shadow: 0 12px 25px rgba(15, 118, 110, 0.25); }

        @media (min-width: 640px) {
            .hero-slide-media {
                display: block;
                font-size: clamp(3.5rem, 6vw, 5.5rem);
            }
        }

        .hero-slide-actions .btn {
            box-shadow: 0 10px 25px rgba(22, 163, 74, 0.25);
        }

        /* STYLE PRODUK MIRIP INDEX.HTML */
        .showcase {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: 360px;
        }

        .showcase:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }

        .showcase-banner {
            position: relative;
            overflow: hidden;
            padding: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(145deg, rgba(236, 253, 245, 0.8), rgba(209, 250, 229, 0.65));
        }

        .showcase-img {
            width: 100%;
            height: 100%;
            max-height: 190px;
            object-fit: contain;
            transition: transform 0.3s ease;
            background: #ffffff;
            border-radius: 18px;
            box-shadow: 0 12px 24px rgba(15, 118, 110, 0.12);
        }

        .showcase:hover .showcase-img {
            transform: scale(1.03);
        }

        .showcase-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            opacity: 0;
            transform: translateX(50px);
            transition: all 0.3s ease;
        }

        .showcase:hover .showcase-actions {
            opacity: 1;
            transform: translateX(0);
        }

        .btn-action {
            width: 35px;
            height: 35px;
            background: white;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-action:hover {
            background: #27ae60;
            color: white;
            transform: scale(1.1);
        }

        .showcase-content { padding: 15px; display: flex; flex-direction: column; flex: 1; }

        .showcase-category {
            color: #27ae60;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
            display: block;
        }

        .showcase-title {
            color: #2c3e50;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .showcase-title:hover {
            color: #27ae60;
        }

        .showcase-desc {
            font-size: 0.8rem;
            line-height: 1.5;
            color: #4b5563;
            margin-bottom: 0.75rem;
            display: block;
            display: -webkit-box;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
            overflow: hidden;
        }

        .condition-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
            padding: 0.35rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 10px;
            width: fit-content;
            max-width: 100%;
        }

        .condition-excellent,
        .condition-very-good {
            background: #dcfce7;
            color: #166534;
        }

        .condition-good {
            background: #fef3c7;
            color: #92400e;
        }

        .condition-like-new {
            background: #e0f2fe;
            color: #075985;
        }

        .condition-fair {
            background: #fff1f2;
            color: #be123c;
        }

        .wishlist-btn.is-active {
            background: #fee2e2;
            color: #dc2626;
        }

        .wishlist-btn.is-active:hover {
            background: #fecaca;
            color: #b91c1c;
        }

        .price-box {
            display: flex;
            align-items: baseline;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .price {
            font-size: 1.25rem;
            font-weight: 700;
            color: #27ae60;
        }

        .price-box del {
            font-size: 0.9rem;
            color: #999;
        }

        .discount-percentage {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #fb7185;
            color: white;
            padding: 2px 6px;
            border-radius: 5px;
            font-size: 0.62rem;
            font-weight: 600;
            letter-spacing: 0.04em;
            box-shadow: 0 6px 14px rgba(248, 113, 113, 0.18);
        }

        .add-cart-btn {
            width: 100%;
            background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
            margin-top: auto;
        }

        .add-cart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }

        /* FOOTER: use the exact tweaks from index.html so styles match */
        /* PERBAIKAN FOOTER SOCIAL MEDIA */
        .social-link {
          display: flex !important;
          gap: 15px;
          margin-top: 15px;
          flex-wrap: wrap;
        }
        .social-link .footer-nav-item { margin: 0 !important; }
        .social-link .footer-nav-link {
          display: flex !important;
          align-items: center;
          justify-content: center;
          width: 40px;
          height: 40px;
          border-radius: 50%;
          background: #f8f9fa;
          color: #2c3e50;
          transition: all 0.3s ease;
          text-decoration: none;
        }
        .social-link .footer-nav-link:hover {
          background: #27ae60;
          color: white;
          transform: translateY(-3px);
        }
        .social-link .footer-nav-link ion-icon { font-size: 20px; }
        /* Pastikan footer nav list tampil dengan benar */
        .footer-nav-list { display: block !important; }

        /* HEADER IMPROVEMENTS */
        /* HAPUS GARIS PUTIH NAVBAR - match index.html */
        header, header *, .header-main, .header-main *,
        .desktop-navigation-menu, .desktop-navigation-menu * {
            border: none !important;
        }
        /* Give the header a little breathing space top & bottom */
        .header-main { padding: 12px 0 12px !important; margin-bottom: 0 !important; }
        .desktop-navigation-menu { padding-top: 0 !important; margin-top: 0 !important; }
        header { background: #fff !important; box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important; }
        .header-user-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Kill global margin coming from style-prefix.css (main { margin-top: 180px }) */
        main { margin-top: 0 !important; }

        .action-btn {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f8f9fa;
            color: #2c3e50;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: #27ae60;
            color: white;
        }

        .action-btn .count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }

        /* PRODUCT GRID LAYOUT */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 320px));
            gap: 25px;
            margin-top: 30px;
            justify-content: center;
        }
        .product-grid > * {
            width: 100%;
            max-width: 320px;
        }
        /* Ensure inner content has bottom breathing room (override theme rule) */
        .product-grid .showcase-content { padding: 15px 16px 16px !important; }
        /* Keep the CTA button from touching the card edge */
        .add-cart-btn { margin-bottom: 4px; }

        /* Align dropdown panel to right in header */
        .tm-nav-dropdown { position: relative; }
        .tm-nav-dropdown .tm-dropdown-panel {
            right: 0;
            left: auto;
        }

        /* Sustainability badge */
        .sustainability-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #e8f5e9;
            color: #2e7d32;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 10px;
        }

        .sustainability-badge ion-icon {
            font-size: 16px;
        }

        /* Auto-hide sticky header (converted to fixed) */
        .tm-auto-hide-header {
            position: fixed !important;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1300;
            background: #fff;
            transform: translateY(0);
            transition: transform .25s ease, box-shadow .2s ease;
            will-change: transform;
        }
        .tm-auto-hide-header.header--hidden {
            transform: translateY(-100%);
        }
        .tm-auto-hide-header.header--scrolled {
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
        }

        /* Leaderboard bespoke styling */
        .tm-leaderboard {
            position: relative;
            border-radius: 32px;
            overflow: hidden;
            color: #f9fafb;
            background: radial-gradient(120% 160% at 50% -20%, rgba(124, 58, 237, 0.4) 0%, rgba(12, 74, 110, 0.35) 25%, rgba(8, 47, 73, 0.92) 60%, #030712 100%);
            box-shadow: 0 32px 60px -25px rgba(6, 95, 70, 0.75);
        }
        .tm-leaderboard::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(70% 90% at 20% 0%, rgba(250, 204, 21, 0.35), transparent 70%);
            pointer-events: none;
            mix-blend-mode: screen;
        }
        .tm-leaderboard::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(148, 163, 184, 0.1), rgba(16, 185, 129, 0.08));
            mix-blend-mode: overlay;
            pointer-events: none;
        }
        .tm-leaderboard__content {
            position: relative;
            padding: 2rem 2.5rem 2.5rem;
        }
        .tm-leaderboard-header {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .tm-leaderboard-subtitle {
            margin-top: 0.2rem;
            color: rgba(255, 255, 255, 0.88);
            font-weight: 500;
            letter-spacing: 0.01em;
        }
        .tm-leaderboard-header h3 {
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.65rem;
        }
        .tm-leaderboard-header p {
            color: rgba(226, 232, 240, 0.75);
            font-size: 0.9rem;
        }
        .tm-leaderboard-topbar {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        @media (min-width: 640px) {
            .tm-leaderboard-topbar {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        .tm-leaderboard-tabs {
            display: inline-flex;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 9999px;
            padding: 0.25rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
            gap: 0.35rem;
        }
        .tm-leaderboard-tab {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border-radius: 9999px;
            padding: 0.45rem 1.1rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: rgba(226, 232, 240, 0.8);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all .2s ease;
        }
        .tm-leaderboard-tab:hover {
            color: #f8fafc;
        }
        .tm-leaderboard-tab.tm-active {
            background: rgba(255, 255, 255, 0.16);
            color: #fff;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.25);
        }
        .tm-leaderboard-showall {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 0.85rem;
            border-radius: 9999px;
            background: rgba(148, 163, 184, 0.16);
            color: rgba(226, 232, 240, 0.85);
            font-size: 0.75rem;
            border: 1px solid rgba(148, 163, 184, 0.2);
            cursor: pointer;
            transition: transform .2s ease, box-shadow .2s ease;
        }
        .tm-leaderboard-showall:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px -12px rgba(148, 163, 184, 0.45);
        }
        .tm-podium {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 1.2rem;
            align-items: end;
            margin-bottom: 2rem;
        }
        .tm-podium-slot {
            display: flex;
            justify-content: center;
            align-items: flex-end;
        }
        .tm-podium-card {
            position: relative;
            width: 100%;
            max-width: 210px;
            background: linear-gradient(145deg, rgba(255,255,255,0.08), rgba(15,23,42,0.65));
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 24px 24px 18px 18px;
            padding: 1.6rem 1rem 2.8rem;
            text-align: center;
            box-shadow: 0 30px 50px -35px rgba(8, 47, 73, 0.95);
            overflow: hidden;
        }
        .tm-podium-card--1 {
            max-width: 240px;
            transform: translateY(-12px);
            background: linear-gradient(145deg, rgba(234, 179, 8, 0.25), rgba(14, 116, 144, 0.6));
            border-color: rgba(250, 204, 21, 0.4);
        }
        .tm-podium-card--2 {
            background: linear-gradient(145deg, rgba(226, 232, 240, 0.2), rgba(30, 41, 59, 0.7));
            border-color: rgba(148, 163, 184, 0.35);
        }
        .tm-podium-card--3 {
            background: linear-gradient(145deg, rgba(251, 191, 36, 0.18), rgba(21, 94, 117, 0.6));
            border-color: rgba(249, 115, 22, 0.35);
        }
        .tm-podium-card--empty {
            opacity: 0.55;
        }
        .tm-podium-medal {
            font-size: 1.5rem;
        }
        .tm-podium-name {
            font-weight: 600;
            font-size: 1rem;
            margin-top: 0.75rem;
        }
        .tm-podium-level {
            font-size: 0.78rem;
            color: rgba(226, 232, 240, 0.7);
        }
        .tm-podium-xp {
            margin-top: 0.75rem;
            font-weight: 700;
            color: #fde68a;
        }
        .tm-podium-rank {
            position: absolute;
        bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
        font-size: 0.85rem;
        font-weight: 700;
        letter-spacing: 0.16em;
        color: rgba(255, 255, 255, 0.85);
        }
        .tm-podium-base {
            position: absolute;
            bottom: 0;
            left: 12%;
            right: 12%;
            height: 55px;
            border-radius: 20px 20px 0 0;
            background: rgba(15, 23, 42, 0.75);
            border-top: 1px solid rgba(255, 255, 255, 0.12);
        }
        .tm-podium-base--1 { background: rgba(250, 204, 21, 0.18); }
        .tm-podium-base--2 { background: rgba(148, 163, 184, 0.18); }
        .tm-podium-base--3 { background: rgba(249, 115, 22, 0.18); }
        .tm-podium-empty {
            margin-top: 1.25rem;
            font-size: 0.85rem;
            color: rgba(226, 232, 240, 0.55);
        }
        .tm-podium-slot img {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            object-fit: cover;
            margin: 1.4rem auto 0;
            display: block;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        .tm-leaderboard-table-wrap {
            background: rgba(15, 23, 42, 0.45);
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 1rem 1.2rem 0.6rem;
        }
        .tm-leaderboard-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
        }
        .tm-leaderboard-table thead th {
            font-size: 0.75rem;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            color: rgba(226, 232, 240, 0.55);
            padding-bottom: 0.6rem;
        }
        .tm-leaderboard-table tbody tr {
            background: rgba(255, 255, 255, 0.04);
            border-radius: 12px;
            transition: transform .2s ease, background .2s ease;
        }
        .tm-leaderboard-table tbody td {
            padding: 0.8rem 1rem;
            font-size: 0.9rem;
            color: rgba(226, 232, 240, 0.92);
        }
        .tm-leaderboard-table tbody tr:hover {
            transform: translateY(-2px);
            background: rgba(148, 163, 184, 0.12);
        }
        .tm-leaderboard-row--top {
            background: rgba(250, 204, 21, 0.12) !important;
        }
        .tm-leaderboard-row--me {
            box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.7), 0 12px 28px -18px rgba(16, 185, 129, 0.55);
        }
        .tm-leaderboard-user {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }
        .tm-leaderboard-user img {
            width: 42px;
            height: 42px;
            object-fit: cover;
            border-radius: 9999px;
            border: 2px solid rgba(255, 255, 255, 0.25);
        }
        .tm-leaderboard-user .name {
            font-weight: 600;
        }
        .tm-leaderboard-user .meta {
            font-size: 0.72rem;
            color: rgba(226, 232, 240, 0.6);
        }
        .tm-leaderboard-empty {
            margin-top: 1rem;
            background: rgba(148, 163, 184, 0.12);
            border-radius: 16px;
            padding: 0.9rem 1.1rem;
            font-size: 0.85rem;
            color: rgba(226, 232, 240, 0.72);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }
        .tm-leaderboard-rank {
            font-weight: 600;
            font-size: 0.85rem;
            color: rgba(226, 232, 240, 0.7);
        }
        .tm-leaderboard-score {
            font-weight: 700;
            color: #fde68a;
        }
        @media (max-width: 768px) {
            .tm-leaderboard__content {
                padding: 1.6rem 1.4rem 2rem;
            }
            .tm-podium {
                grid-template-columns: repeat(1, minmax(0, 1fr));
                justify-items: center;
            }
            .tm-podium-slot {
                width: 100%;
            }
            .tm-podium-card {
                max-width: 100%;
            }
            .tm-leaderboard-table-wrap {
                padding: 0.75rem;
            }
            .tm-leaderboard-table tbody td {
                padding: 0.7rem 0.75rem;
            }
        }

    </style>
</head>
<body class="bg-gray-50">
    <!-- Sidebar -->
    <div class="sidebar fixed inset-y-0 left-0 z-50 w-64 bg-green-800 text-white sidebar-collapsed hidden">
        <div class="flex items-center justify-between p-4 border-b border-green-700">
            <div class="flex items-center space-x-3">
                <img src="./assets/images/logo/logo.svg" alt="ThriftMap" class="h-8 w-8">
            </div>
            <button id="toggleSidebar" class="text-white hover:text-green-200">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        
        <nav class="mt-6">
            <div class="px-4 space-y-2">
                <a href="dashboard-home.html" class="nav-item block py-2 px-4 rounded-lg bg-green-700 text-white">
                    <i class="fas fa-home mr-3"></i>
                    <span class="sidebar-text">Dashboard</span>
                </a>
                
                <a href="dashboard-profile.html" class="nav-item block py-2 px-4 rounded-lg hover:bg-green-700 text-green-100">
                    <i class="fas fa-user mr-3"></i>
                    <span class="sidebar-text">Profil</span>
                </a>
                
                <a href="dashboard-products.html" class="nav-item block py-2 px-4 rounded-lg hover:bg-green-700 text-green-100">
                    <i class="fas fa-tshirt mr-3"></i>
                    <span class="sidebar-text">Produk</span>
                </a>
                
                <a href="dashboard-orders.html" class="nav-item block py-2 px-4 rounded-lg hover:bg-green-700 text-green-100">
                    <i class="fas fa-shopping-bag mr-3"></i>
                    <span class="sidebar-text">Pesanan</span>
                </a>
                
                <a href="dashboard-tracking.html" class="nav-item block py-2 px-4 rounded-lg hover:bg-green-700 text-green-100">
                    <i class="fas fa-map-marker-alt mr-3"></i>
                    <span class="sidebar-text">Lacak Pesanan</span>
                </a>
                
                <a href="dashboard-payment.html" class="nav-item block py-2 px-4 rounded-lg hover:bg-green-700 text-green-100">
                    <i class="fas fa-credit-card mr-3"></i>
                    <span class="sidebar-text">Pembayaran</span>
                </a>
                
                <a href="dashboard-settings.html" class="nav-item block py-2 px-4 rounded-lg hover:bg-green-700 text-green-100">
                    <i class="fas fa-cog mr-3"></i>
                    <span class="sidebar-text">Pengaturan</span>
                </a>
            </div>
        </nav>
        
        <div class="absolute bottom-0 w-full p-4 border-t border-green-700">
            <a href="index.html" class="flex items-center space-x-3 text-green-100 hover:text-white">
                <i class="fas fa-sign-out-alt"></i>
                <span class="sidebar-text">Keluar</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content ml-0">
        <!-- Index-style Header/Navbar -->
    <header class="tm-auto-hide-header">
            <div class="header-main">
                <div class="container">
                    <a href="dashboard-home.html" class="header-logo">
                        <img src="./assets/images/logo/logo.svg" alt="ThriftMap logo" width="120" height="36">
                    </a>
                                        <div class="header-search-container">
                        <input id="globalSearch" type="search" name="search" class="search-field" placeholder="Cari produk preloved...">
                        <button class="search-btn" id="globalSearchBtn">
                            <ion-icon name="search-outline"></ion-icon>
                        </button>
                    </div>
                                        <div class="header-user-actions" style="margin-left:auto">
                                                <!-- Order: account -> bag -> dropdown (far right) -->
                                                <a href="dashboard-profile.html" class="action-btn" title="Akun">
                                                        <ion-icon name="person-outline"></ion-icon>
                                                </a>
                                                <a href="dashboard-cart.html" class="action-btn" title="Keranjang">
                                                        <ion-icon name="bag-handle-outline"></ion-icon>
                                                        <span class="count cart-count" style="display:none">0</span>
                                                </a>
                                                <button type="button" class="action-btn" data-open-wishlist title="Wishlist">
                                                        <ion-icon name="heart-outline"></ion-icon>
                                                        <span class="count wish-count" style="display:none">0</span>
                                                </button>
                                                <div class="tm-nav-dropdown">
                                                    <button class="action-btn" id="globalMenuBtn" aria-haspopup="true" aria-expanded="false" title="Menu">
                                                        <ion-icon name="menu-outline"></ion-icon>
                                                    </button>
                                                    <div class="tm-dropdown-panel hidden" id="globalMenu">
                                                        <a href="dashboard-home.html"><span class="label"><ion-icon name="home-outline"></ion-icon> Beranda</span></a>
                                                        <a href="dashboard-products.html"><span class="label"><ion-icon name="storefront-outline"></ion-icon> Produk</span></a>
                                                        <a href="dashboard-orders.html"><span class="label"><ion-icon name="bag-check-outline"></ion-icon> Pesanan</span><span class="badge orders-count" style="display:none">0</span></a>
                                                        <a href="dashboard-tracking.html"><span class="label"><ion-icon name="location-outline"></ion-icon> Lacak</span></a>
                                                        <a href="dashboard-payment.html"><span class="label"><ion-icon name="card-outline"></ion-icon> Pembayaran</span></a>
                                                        <a href="dashboard-settings.html"><span class="label"><ion-icon name="settings-outline"></ion-icon> Pengaturan</span></a>
                                                        <a href="#" data-open-wishlist><span class="label"><ion-icon name="heart-outline"></ion-icon> Wishlist</span><span class="badge wish-count" style="display:none">0</span></a>
                                                    </div>
                                                </div>
                                        </div>
                </div>
            </div>
        </header>

        <br>
        <!-- Page Content -->
        <main class="max-w-7xl mx-auto px-4 pb-24">
            <!-- Hero Banner Carousel -->
            <section class="mb-6">
                <div id="heroCarousel" class="relative">
                    <div class="h-scroll no-scrollbar flex gap-4 carousel" id="heroTrack">
                        <div class="hero-slide" data-hero-query="thrift fashion" style="--hero-fallback: linear-gradient(135deg,#d1fae5,#a7f3d0);">
                            <div class="hero-slide-content">
                                <h2 class="text-2xl sm:text-3xl font-extrabold mb-2 flex items-center gap-2"><i class="fas fa-bolt text-yellow-500"></i> Flash Sale Serba 50%</h2>
                                <p class="mb-4 flex items-center gap-2"><i class="fas fa-hourglass-half text-amber-500"></i> Produk pilihan hari ini, stok terbatas!</p>
                                <div class="hero-slide-actions">
                                    <a href="dashboard-products.html" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg btn"><i class="fas fa-cart-plus mr-2"></i> Belanja Sekarang</a>
                                </div>
                            </div>
                            <div class="hero-slide-media">
                                <i class="fas fa-tags"></i>
                            </div>
                        </div>
                        <div class="hero-slide" data-hero-query="vintage clothing boutique" style="--hero-fallback: linear-gradient(135deg,#e0e7ff,#c7d2fe);">
                            <div class="hero-slide-content">
                                <h2 class="text-2xl sm:text-3xl font-extrabold mb-2 flex items-center gap-2"><i class="fas fa-location-dot text-indigo-500"></i> Near You Picks</h2>
                                <p class="mb-4 flex items-center gap-2"><i class="fas fa-location-crosshairs text-indigo-400"></i> Temukan barang thrift dekat lokasimu.</p>
                                <div class="hero-slide-actions">
                                    <a href="dashboard-products.html" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg btn"><i class="fas fa-map-location-dot mr-2"></i> Lihat di Peta</a>
                                </div>
                            </div>
                            <div class="hero-slide-media">
                                <i class="fas fa-map-marked-alt"></i>
                            </div>
                        </div>
                        <div class="hero-slide" data-hero-query="sustainable fashion store" style="--hero-fallback: linear-gradient(135deg,#fee2e2,#fecaca);">
                            <div class="hero-slide-content">
                                <h2 class="text-2xl sm:text-3xl font-extrabold mb-2 flex items-center gap-2"><i class="fas fa-gem text-rose-500"></i> Koleksi Vintage Pilihan</h2>
                                <p class="mb-4 flex items-center gap-2"><i class="fas fa-shirt text-rose-400"></i> Jaket, kemeja, dan dress kualitas terbaik.</p>
                                <div class="hero-slide-actions">
                                    <a href="dashboard-products.html" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg btn"><i class="fas fa-compass mr-2"></i> Jelajahi</a>
                                </div>
                            </div>
                            <div class="hero-slide-media">
                                <i class="fas fa-tshirt"></i>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-center gap-3 mt-3" id="heroDots"></div>
                </div>
            </section>

            <!-- Category Chips with edge fades -->
            <section class="mb-6">
                <div class="relative">
                <div id="categoryChips" class="h-scroll no-scrollbar flex flex-nowrap gap-2 px-6 cursor-grab">
                    <button class="px-4 py-2 rounded-full bg-green-600 text-white" data-cat="">Semua</button>
                    <!-- Kategori Utama -->
                    <button class="chip" data-cat="Pakaian Wanita">Pakaian Wanita</button>
                    <button class="chip" data-cat="Pakaian Pria">Pakaian Pria</button>
                    <button class="chip" data-cat="Anak & Bayi">Anak & Bayi</button>
                    <button class="chip" data-cat="Barang & Peralatan">Barang & Peralatan</button>

                    <!-- Subkategori Pakaian Wanita -->
                    <button class="chip" data-cat="Dress & Rok">Dress & Rok</button>
                    <button class="chip" data-cat="Atasan">Atasan</button>
                    <button class="chip" data-cat="Celana">Celana</button>
                    <button class="chip" data-cat="Jaket & Sweater">Jaket & Sweater</button>
                    <button class="chip" data-cat="Sepatu">Sepatu</button>
                    <button class="chip" data-cat="Aksesoris">Aksesoris</button>

                    <!-- Subkategori Pakaian Pria -->
                    <button class="chip" data-cat="Kemeja">Kemeja</button>
                    <button class="chip" data-cat="Jaket">Jaket</button>

                    <!-- Subkategori Anak & Bayi -->
                    <button class="chip" data-cat="Pakaian Bayi">Pakaian Bayi</button>
                    <button class="chip" data-cat="Peralatan Bayi">Peralatan Bayi</button>
                    <button class="chip" data-cat="Pakaian Anak">Pakaian Anak</button>
                    <button class="chip" data-cat="Sepatu Anak">Sepatu Anak</button>
                    <button class="chip" data-cat="Mainan">Mainan</button>
                    <button class="chip" data-cat="Buku">Buku</button>

                    <!-- Subkategori Barang & Peralatan -->
                    <button class="chip" data-cat="Peralatan Rumah Tangga">Peralatan Rumah Tangga</button>
                    <button class="chip" data-cat="Peralatan Dapur">Peralatan Dapur</button>
                    <button class="chip" data-cat="Alat Tulis Kantor">Alat Tulis Kantor</button>
                    <button class="chip" data-cat="Elektronik">Elektronik</button>
                    <button class="chip" data-cat="Barang Lain">Barang Lain</button>
                </div>
                <!-- Edge fades -->
                <div id="chipsFadeLeft" class="pointer-events-none absolute left-0 top-0 h-full w-6 bg-gradient-to-r from-[#f8fafc] to-transparent transition-opacity duration-200"></div>
                <div id="chipsFadeRight" class="pointer-events-none absolute right-0 top-0 h-full w-6 bg-gradient-to-l from-[#f8fafc] to-transparent transition-opacity duration-200"></div>
                <!-- Scroll arrows -->
                <button id="chipsPrev" type="button" class="chips-arrow chips-arrow--left" aria-label="Scroll kiri"><i class="fas fa-chevron-left"></i></button>
                <button id="chipsNext" type="button" class="chips-arrow chips-arrow--right" aria-label="Scroll kanan"><i class="fas fa-chevron-right"></i></button>
                </div>
            </section>

            <!-- Flash Sale -->
            <section class="mb-8">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2"><i class="fas fa-bolt text-yellow-500"></i> Flash Sale</h3>
                    <div class="text-sm text-gray-600">Berakhir dalam <span id="fsTimer" class="font-semibold text-gray-900">--:--:--</span></div>
                </div>
                <div class="product-grid" id="flashSaleGrid"></div>
            </section>

            <!-- Recommendation Horizontal -->
            <section class="mb-8">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-xl font-bold text-gray-800">Untuk Kamu</h3>
                    <a href="dashboard-products.html" class="text-green-600 hover:text-green-800 text-sm font-medium">Lihat Semua</a>
                </div>
                <div class="product-grid" id="recommendationGrid"></div>
            </section>
        </main>

                        <!-- Leaderboard Section -->
                                <section class="max-w-7xl mx-auto px-4 pb-10">
                                    <div class="tm-leaderboard">
                                        <div class="tm-leaderboard__content">
                                            <div class="tm-leaderboard-topbar">
                                                <div class="tm-leaderboard-header">
                                                    <h3><i class="fas fa-trophy text-amber-400"></i> Leaderboard – Rise to the Top</h3>
                                                    <p class="tm-leaderboard-subtitle">Kompetisi ramah lingkungan: kumpulkan XP dari pembelian preloved dan capai peringkat teratas.</p>
                                                <br>
                                                <br>
    
                                                </div>
                                             
                                                <div class="flex items-center gap-3">
                                                    <div class="tm-leaderboard-tabs">
                                                        <button id="lbTabLevel" class="tm-leaderboard-tab tm-active"><i class="fas fa-users"></i><span>Top Level</span></button>
                                                        <button id="lbTabDaily" class="tm-leaderboard-tab"><i class="fas fa-bolt"></i><span>XP Hari Ini</span></button>
                                                    </div>
                                                    <button type="button" class="tm-leaderboard-showall" disabled><span>Lihat semua</span><i class="fas fa-arrow-right"></i></button>
                                                </div>
                                            </div>

                                            <!-- Podium top 3 -->
                                            <div id="lbPodium" class="tm-podium">
                                                <!-- filled by JS -->
                                            </div>

                                            <!-- Leaderboard table -->
                                            <div class="tm-leaderboard-table-wrap">
                                                <table class="tm-leaderboard-table" aria-label="Leaderboard pengguna">
                                                    <thead>
                                                        <tr>
                                                            <th class="text-left">Rank</th>
                                                            <th class="text-left">Pengguna</th>
                                                            <th class="text-center">Level</th>
                                                            <th id="tmLeaderboardScoreHead" class="text-right">Total XP</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="tmLeaderboardBody"></tbody>
                                                </table>
                                            </div>

                                            <div id="tmLeaderboardEmpty" class="tm-leaderboard-empty hidden">
                                                Masuk untuk melihat leaderboard global secara real-time. Saat ini ditampilkan data dari perangkatmu.
                                            </div>
                                        </div>
                                    </div>
                        </section>

        <!-- FOOTER EXACTLY LIKE index.html -->
        <footer>
            <div class="footer-nav">
                            <div class="container">
                                <ul class="footer-nav-list">
                                    <li class="footer-nav-item"><h2 class="nav-title">Kategori Populer</h2></li>
                                    <li class="footer-nav-item"><a href="#" class="footer-nav-link">Pakaian Wanita</a></li>
                                    <li class="footer-nav-item"><a href="#" class="footer-nav-link">Pakaian Pria</a></li>
                                    <li class="footer-nav-item"><a href="#" class="footer-nav-link">Anak & Bayi</a></li>
                                    <li class="footer-nav-item"><a href="#" class="footer-nav-link">Barang & Peralatan</a></li>
                                    <li class="footer-nav-item"><a href="#" class="footer-nav-link">Aksesoris</a></li>
                                </ul>

                                <ul class="footer-nav-list">
                                    <li class="footer-nav-item"><h2 class="nav-title">Produk</h2></li>
                                    <li class="footer-nav-item"><a href="#" class="footer-nav-link">Diskon</a></li>
                                    <li class="footer-nav-item"><a href="#" class="footer-nav-link">Produk Baru</a></li>
                                    <li class="footer-nav-item"><a href="#" class="footer-nav-link">Penjualan Terbaik</a></li>
                                </ul>

                                <ul class="footer-nav-list">
                                    <li class="footer-nav-item"><h2 class="nav-title">Perusahaan Kami</h2></li>
                                    <li class="footer-nav-item"><a href="#" class="footer-nav-link">Pengiriman</a></li>
                                    <li class="footer-nav-item"><a href="#" class="footer-nav-link">Pemberitahuan Hukum</a></li>
                                    <li class="footer-nav-item"><a href="#" class="footer-nav-link">Syarat dan Ketentuan</a></li>
                                    <li class="footer-nav-item"><a href="#" class="footer-nav-link">Tentang Kami</a></li>
                                    <li class="footer-nav-item"><a href="#" class="footer-nav-link">Pembayaran Aman</a></li>
                                </ul>

                                <ul class="footer-nav-list">
                                    <li class="footer-nav-item"><h2 class="nav-title">Layanan</h2></li>
                                    <li class="footer-nav-item"><a href="#" class="footer-nav-link">Bantuan</a></li>
                                    <li class="footer-nav-item"><a href="#" class="footer-nav-link">Hubungi Kami</a></li>
                                    <li class="footer-nav-item"><a href="#" class="footer-nav-link">FAQ</a></li>
                                    <li class="footer-nav-item"><a href="#" class="footer-nav-link">Pengembalian</a></li>
                                    <li class="footer-nav-item"><a href="#" class="footer-nav-link">Garansi</a></li>
                                </ul>

                                <ul class="footer-nav-list">
                                    <li class="footer-nav-item"><h2 class="nav-title">Kontak</h2></li>
                                    <li class="footer-nav-item flex">
                                        <div class="icon-box"><ion-icon name="location-outline"></ion-icon></div>
                                        <address class="content">Jl. Thrift No. 123
                                            Jakarta Selatan, 12345, Indonesia</address>
                                    </li>
                                    <li class="footer-nav-item flex">
                                        <div class="icon-box"><ion-icon name="call-outline"></ion-icon></div>
                                        <a href="tel:+62123456789" class="footer-nav-link">(021) 2345-6789</a>
                                    </li>
                                    <li class="footer-nav-item flex">
                                        <div class="icon-box"><ion-icon name="mail-outline"></ion-icon></div>
                                        <a href="mailto:hello@thriftmap.id" class="footer-nav-link">hello@thriftmap.id</a>
                                    </li>
                                </ul>

                                <ul class="footer-nav-list">
                                    <li class="footer-nav-item"><h2 class="nav-title">Ikuti Kami</h2></li>
                                    <li>
                                        <ul class="social-link">
                                            <li class="footer-nav-item"><a href="#" class="footer-nav-link"><ion-icon name="logo-facebook"></ion-icon></a></li>
                                            <li class="footer-nav-item"><a href="#" class="footer-nav-link"><ion-icon name="logo-twitter"></ion-icon></a></li>
                                            <li class="footer-nav-item"><a href="#" class="footer-nav-link"><ion-icon name="logo-linkedin"></ion-icon></a></li>
                                            <li class="footer-nav-item"><a href="#" class="footer-nav-link"><ion-icon name="logo-instagram"></ion-icon></a></li>
                                            <li class="footer-nav-item"><a href="#" class="footer-nav-link"><ion-icon name="logo-tiktok"></ion-icon></a></li>
                                            <li class="footer-nav-item"><a href="#" class="footer-nav-link"><ion-icon name="logo-youtube"></ion-icon></a></li>
                                        </ul>
                                    </li>
                                </ul>

                            </div>
            </div>

            <div class="footer-bottom">
                            <div class="container">
                <p class="copyright">Hak Cipta &copy; 2025 <a href="#">ThriftMap</a> - Style More, Spend Less.</p>
                            </div>
            </div>
        </footer>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="fixed bottom-0 inset-x-0 bg-white border-t border-gray-200 z-40 md:hidden">
        <div class="flex justify-around py-2 text-xs">
            <a data-nav href="dashboard-home.html" class="flex flex-col items-center text-gray-600 hover:text-green-600">
                <i class="fas fa-home text-base"></i>
                <span>Home</span>
            </a>
            <a data-nav href="dashboard-products.html" class="flex flex-col items-center text-gray-600 hover:text-green-600">
                <i class="fas fa-tags text-base"></i>
                <span>Produk</span>
            </a>
            <a data-nav href="dashboard-orders.html" class="flex flex-col items-center text-gray-600 hover:text-green-600">
                <i class="fas fa-shopping-bag text-base"></i>
                <span>Pesanan</span>
            </a>
            <a href="#" data-open-wishlist class="flex flex-col items-center text-gray-600 hover:text-green-600">
                <i class="fas fa-heart text-base"></i>
                <span>Wishlist</span>
                <span class="count wish-count" style="display:none">0</span>
            </a>
            <a data-nav href="dashboard-tracking.html" class="flex flex-col items-center text-gray-600 hover:text-green-600">
                <i class="fas fa-map-marker-alt text-base"></i>
                <span>Lacak</span>
            </a>
            <a data-nav href="dashboard-profile.html" class="flex flex-col items-center text-gray-600 hover:text-green-600">
                <i class="fas fa-user text-base"></i>
                <span>Profil</span>
            </a>
        </div>
    </nav>

    <script src="./assets/js/cart.js"></script>
    <script src="./assets/js/notify.js"></script>
    <script src="./assets/js/wishlist.js"></script>
    <script src="./assets/js/wishlist-panel.js"></script>
    <script src="./assets/js/products-data.js"></script>
    <script src="./assets/js/gamification.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2.45.3/dist/umd/supabase.js" integrity="sha384-VHW9FPrfFFS9R48OeoQNxhcthu3tNdWLbpSql9IH+hbuL3SOHnBRoiSOP+npNYBu" crossorigin="anonymous"></script>
    <script src="./assets/js/supabase-client.js"></script>
    <script src="./assets/js/supabase-init.js"></script>
    <!-- Ionicons for index-style UI -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <script>
        // Orders badge sync
        (function(){
            const KEY='tm_orders_count';
            function update(){
                const c = parseInt(localStorage.getItem(KEY)||'0',10)||0;
                document.querySelectorAll('.orders-count').forEach(el=>{
                    if (c>0){ el.textContent=String(c); el.style.display=''; }
                    else { el.textContent='0'; el.style.display='none'; }
                });
            }
            document.addEventListener('DOMContentLoaded', update);
            window.TMOrdersBadge = {
                set(n){ localStorage.setItem(KEY, String(Math.max(0, Number(n)||0))); update(); },
                get(){ return parseInt(localStorage.getItem(KEY)||'0',10)||0; }
            };
        })();
    </script>
    <script>
        // Ensure wishlist badges reflect stored data once page is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => window.TMWishlist?.updateBadges?.());
        } else {
            window.TMWishlist?.updateBadges?.();
        }
        // Home product renderer utilities
        const TM_HOME_CONDITIONS = {
            'sangat baik': { cls: 'condition-very-good', label: 'Kondisi Sangat Baik' },
            'baik': { cls: 'condition-good', label: 'Kondisi Baik' },
            'seperti baru': { cls: 'condition-like-new', label: 'Kondisi Seperti Baru' },
            'cukup': { cls: 'condition-fair', label: 'Kondisi Cukup' }
        };

        const TM_HOME_SAFE = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        function tmHomeEscape(value){
            return String(value ?? '').replace(/[&<>"']/g, ch => TM_HOME_SAFE[ch] || ch);
        }

        function tmHomeFormatCurrency(amount){
            try {
                return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(Number(amount) || 0);
            } catch {
                return `Rp ${Number(amount || 0).toLocaleString('id-ID')}`;
            }
        }

        function tmHomeDiscountInfo(product){
            const price = Number(product?.price) || 0;
            const original = Number(product?.originalPrice) || 0;
            if (!original || original <= price) return null;
            const pct = Math.round((1 - (price / original)) * 100);
            return { pct, original };
        }

        function tmHomeConditionInfo(condition){
            const key = String(condition || '').trim().toLowerCase();
            return TM_HOME_CONDITIONS[key] || TM_HOME_CONDITIONS['baik'];
        }

        function tmHomeShortDesc(text, maxLength = 110){
            const value = String(text || '').trim();
            if (!value) return '';
            return value.length > maxLength ? `${value.slice(0, maxLength - 3).trim()}...` : value;
        }

        function tmHomeRenderCard(product){
            const id = tmHomeEscape(product?.id ?? '');
            const name = tmHomeEscape(product?.name || 'Produk Preloved');
            const category = tmHomeEscape(product?.category || 'Produk');
            const image = tmHomeEscape(product?.image || './assets/images/products/jacket-3.jpg');
            const detailUrl = tmHomeEscape(`dashboard-product.html?id=${encodeURIComponent(product?.id ?? '')}`);
            const categoryParam = product?.category ? `?category=${encodeURIComponent(product.category)}` : '';
            const categoryUrl = tmHomeEscape(`dashboard-products.html${categoryParam}`);
            const discount = tmHomeDiscountInfo(product);
            const conditionInfo = tmHomeConditionInfo(product?.condition);
            const conditionLabel = tmHomeEscape(conditionInfo.label);
            const priceLabel = tmHomeFormatCurrency(product?.price);
            const originalLabel = discount ? tmHomeFormatCurrency(discount.original) : '';
            const description = tmHomeEscape(tmHomeShortDesc(product?.description));
            const inWishlist = !!window.TMWishlist?.has?.(String(product?.id));
            const wishClass = inWishlist ? ' wishlist-btn is-active' : ' wishlist-btn';
            const wishIcon = inWishlist ? 'heart' : 'heart-outline';
            const priceAttr = Number(product?.price) || 0;
            const imageAttr = tmHomeEscape(product?.image || './assets/images/products/jacket-3.jpg');

            return `
                <div class="showcase" data-product-id="${id}">
                    <div class="showcase-banner">
                        <a href="${detailUrl}" class="block">
                            <img src="${image}" alt="${name}" class="showcase-img">
                        </a>
                        ${discount ? `<span class="badge-sale">-${discount.pct}%</span>` : ''}
                        <div class="showcase-actions">
                            <button type="button" class="btn-action${wishClass}" data-wish-id="${id}" data-wish-name="${name}" aria-pressed="${inWishlist ? 'true' : 'false'}" title="Tambah ke Wishlist">
                                <ion-icon name="${wishIcon}"></ion-icon>
                            </button>
                            <a class="btn-action" href="${detailUrl}" title="Lihat Detail Produk">
                                <ion-icon name="eye-outline"></ion-icon>
                            </a>
                            <button type="button" class="btn-action add-cart" data-add-cart data-id="${id}" data-name="${name}" data-price="${priceAttr}" data-image="${imageAttr}" title="Tambah ke Keranjang">
                                <ion-icon name="bag-add-outline"></ion-icon>
                            </button>
                        </div>
                    </div>
                    <div class="showcase-content">
                        <a href="${categoryUrl}" class="showcase-category">${category}</a>
                        <a href="${detailUrl}">
                            <h3 class="showcase-title">${name}</h3>
                        </a>
                        <span class="condition-badge ${conditionInfo.cls}">${conditionLabel}</span>
                        ${description ? `<p class="showcase-desc">${description}</p>` : ''}
                        <div class="price-box">
                            <p class="price">${priceLabel}</p>
                            ${discount ? `<del>${originalLabel}</del><span class="discount-percentage">${discount.pct}% OFF</span>` : ''}
                        </div>
                        <button type="button" class="add-cart-btn" data-add-cart data-id="${id}" data-name="${name}" data-price="${priceAttr}" data-image="${imageAttr}">Tambah ke Keranjang</button>
                    </div>
                </div>`;
        }

        function tmHomeRenderSection(targetId, products){
            const container = document.getElementById(targetId);
            if (!container) return;
            if (!products.length){
                container.innerHTML = '<div class="text-sm text-gray-500">Produk akan segera hadir.</div>';
                return;
            }
            container.innerHTML = products.map(tmHomeRenderCard).join('');
        }

        function tmHomeCollectProducts(){
            const all = Array.isArray(window.TM_PRODUCTS) ? window.TM_PRODUCTS.slice() : [];
            if (!all.length) return { flash: [], recommend: [] };

            const withDiscount = all.filter(p => tmHomeDiscountInfo(p));
            withDiscount.sort((a, b) => (tmHomeDiscountInfo(b)?.pct || 0) - (tmHomeDiscountInfo(a)?.pct || 0));
            const flash = withDiscount.slice(0, 3);
            const used = new Set(flash.map(p => String(p.id)));
            const rest = all.filter(p => !used.has(String(p.id)));
            const recommend = rest.slice(0, 4);
            return { flash, recommend };
        }

        function tmHomeApplyWishlistState(){
            document.querySelectorAll('[data-wish-id]').forEach(btn => {
                const id = btn.getAttribute('data-wish-id');
                const active = !!window.TMWishlist?.has?.(id);
                btn.classList.toggle('is-active', active);
                btn.setAttribute('aria-pressed', active ? 'true' : 'false');
                const icon = btn.querySelector('ion-icon');
                if (icon) icon.setAttribute('name', active ? 'heart' : 'heart-outline');
            });
        }

        function tmHomeInitProducts(){
            const { flash, recommend } = tmHomeCollectProducts();
            tmHomeRenderSection('flashSaleGrid', flash);
            tmHomeRenderSection('recommendationGrid', recommend);
            tmHomeApplyWishlistState();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', tmHomeInitProducts);
        } else {
            tmHomeInitProducts();
        }
        // Global menu dropdown
        const globalMenuBtn = document.getElementById('globalMenuBtn');
        const globalMenu = document.getElementById('globalMenu');
        if (globalMenuBtn && globalMenu) {
            globalMenuBtn.addEventListener('click', () => {
                const expanded = globalMenuBtn.getAttribute('aria-expanded') === 'true';
                globalMenuBtn.setAttribute('aria-expanded', String(!expanded));
                globalMenu.classList.toggle('hidden');
            });
            document.addEventListener('click', (e) => {
                if (!globalMenu.contains(e.target) && e.target !== globalMenuBtn && !globalMenuBtn.contains(e.target)) {
                    globalMenu.classList.add('hidden');
                    globalMenuBtn.setAttribute('aria-expanded', 'false');
                }
            });
        }

        // Category chips -> navigate with ?category= on products page and persist active
        (function(){
            const wrap = document.getElementById('categoryChips');
            const fadeL = document.getElementById('chipsFadeLeft');
            const fadeR = document.getElementById('chipsFadeRight');
            if (!wrap) return;

            const prevBtn = document.getElementById('chipsPrev');
            const nextBtn = document.getElementById('chipsNext');

            function updateArrows(){
                if (!prevBtn || !nextBtn) return;
                const maxScroll = wrap.scrollWidth - wrap.clientWidth;
                if (maxScroll <= 0){ prevBtn.disabled = true; nextBtn.disabled = true; return; }
                prevBtn.disabled = !(wrap.scrollLeft > 0);
                nextBtn.disabled = !(wrap.scrollLeft < maxScroll - 1);
            }

            function updateFades(){
                const maxScroll = wrap.scrollWidth - wrap.clientWidth;
                if (maxScroll <= 0){
                    fadeL.style.opacity = '0';
                    fadeR.style.opacity = '0';
                    updateArrows();
                    return;
                }
                fadeL.style.opacity = wrap.scrollLeft > 0 ? '1' : '0';
                fadeR.style.opacity = wrap.scrollLeft < maxScroll - 1 ? '1' : '0';
                updateArrows();
            }
            wrap.addEventListener('scroll', updateFades);
            window.addEventListener('resize', updateFades);
            setTimeout(updateFades, 50);

            // Arrow click handlers
            function scrollByAmount(dir){
                const amount = Math.round(wrap.clientWidth * 0.7);
                wrap.scrollTo({ left: wrap.scrollLeft + dir * amount, behavior: 'smooth' });
            }
            if (prevBtn) prevBtn.addEventListener('click', () => scrollByAmount(-1));
            if (nextBtn) nextBtn.addEventListener('click', () => scrollByAmount(1));

            // Desktop mouse wheel -> horizontal scroll
            wrap.addEventListener('wheel', (e) => {
                // If the user scrolls vertically over the chips, translate to horizontal
                if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
                    e.preventDefault();
                    wrap.scrollLeft += e.deltaY;
                }
            }, { passive: false });

            // Click & drag to scroll (desktop)
            let isDown = false, startX = 0, startLeft = 0;
            wrap.addEventListener('mousedown', (e) => {
                isDown = true;
                wrap.classList.add('dragging');
                startX = e.pageX;
                startLeft = wrap.scrollLeft;
            });
            wrap.addEventListener('mouseleave', () => {
                isDown = false;
                wrap.classList.remove('dragging');
            });
            wrap.addEventListener('mouseup', () => {
                isDown = false;
                wrap.classList.remove('dragging');
            });
            wrap.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const dx = e.pageX - startX;
                wrap.scrollLeft = startLeft - dx;
            });

            // Restore active chip
            const lastCat = localStorage.getItem('tm_last_category') || '';
            if (lastCat){
                wrap.querySelectorAll('button[data-cat]').forEach(b=>{
                    b.classList.toggle('chip-active', b.getAttribute('data-cat')===lastCat && lastCat !== '');
                });
            }

            wrap.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-cat]');
                if (!btn) return;
                const cat = btn.getAttribute('data-cat') || '';
                localStorage.setItem('tm_last_category', cat);
                const url = new URL(location.origin + (location.pathname.replace(/[^\/]+$/, '') + 'dashboard-products.html'));
                if (cat) url.searchParams.set('category', cat);
                location.href = url.toString();
            });
        })();

        // Bottom nav active state
        document.querySelectorAll('a[data-nav]').forEach(a => {
            try {
                const href = a.getAttribute('href') || '';
                if (location.pathname.endsWith(href)) {
                    a.classList.add('text-green-600');
                }
            } catch {}
        });
        // Hero carousel logic
        const heroTrack = document.getElementById('heroTrack');
    const heroDots = document.getElementById('heroDots');
    const heroSlideNodes = heroTrack ? heroTrack.querySelectorAll('.hero-slide') : [];
    const HERO_PEXELS_QUERIES = ['thrift fashion', 'vintage clothing boutique', 'sustainable fashion store'];
    // Set window.PEXELS_API_KEY = 'YOUR_REAL_KEY' (https://www.pexels.com/api/) to enable dynamic hero backgrounds
    const PEXELS_API_KEY = window.PEXELS_API_KEY || 'YOUR_PEXELS_API_KEY';
        let heroIndex = 0;
        const heroSlides = heroTrack ? heroTrack.children.length : 0;

        async function loadHeroBackgrounds(){
            if (!heroSlideNodes.length) return;
            if (!PEXELS_API_KEY || PEXELS_API_KEY === 'YOUR_PEXELS_API_KEY') return;
            let page = 1;
            for (const slide of heroSlideNodes){
                const query = slide.getAttribute('data-hero-query') || HERO_PEXELS_QUERIES[(page-1) % HERO_PEXELS_QUERIES.length];
                try {
                    const response = await fetch(`https://api.pexels.com/v1/search?per_page=1&orientation=landscape&query=${encodeURIComponent(query)}&page=${page}`, {
                        headers: { Authorization: PEXELS_API_KEY }
                    });
                    if (!response.ok) throw new Error(`Pexels API returned ${response.status}`);
                    const payload = await response.json();
                    const photo = payload?.photos?.[0];
                    const url = photo?.src?.landscape || photo?.src?.large || photo?.src?.original;
                    if (url){
                        slide.style.setProperty('--hero-bg', `linear-gradient(0deg, rgba(15,23,42,0.18), rgba(15,23,42,0.18)), url('${url}')`);
                        slide.classList.add('hero-slide--loaded');
                    }
                } catch (error) {
                    console.warn('Tidak dapat memuat background hero dari Pexels:', error);
                }
                page += 1;
            }
        }

        function renderDots(){
            if (!heroDots) return;
            heroDots.innerHTML = '';
            for(let i=0;i<heroSlides;i++){
                const b = document.createElement('button');
                b.className = 'h-2 w-2 rounded-full ' + (i===heroIndex? 'bg-green-600':'bg-gray-300');
                b.addEventListener('click', ()=>{ heroIndex=i; updateHero(); });
                heroDots.appendChild(b);
            }
        }
        function updateHero(){
            if (!heroTrack) return;
            heroTrack.scrollTo({ left: heroIndex * heroTrack.clientWidth, behavior: 'smooth' });
            renderDots();
        }
        function autoHero(){ heroIndex = (heroIndex+1) % heroSlides; updateHero(); }
        if (heroSlides>0){
            renderDots();
            loadHeroBackgrounds();
            setInterval(autoHero, 4000);
        }

        // Flash sale countdown (1 hour from load)
        const fsTimer = document.getElementById('fsTimer');
        const fsEnd = Date.now() + 60*60*1000;
        function tick(){
            const diff = Math.max(0, fsEnd - Date.now());
            const h = Math.floor(diff/3600000).toString().padStart(2,'0');
            const m = Math.floor((diff%3600000)/60000).toString().padStart(2,'0');
            const s = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
            if (fsTimer) fsTimer.textContent = `${h}:${m}:${s}`;
        }
        setInterval(tick, 1000); tick();

        // Wishlist toggle (cards): any element with data-wish-id toggles wishlist
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('[data-wish-id]');
            if (!btn) return;
            e.preventDefault();
            const id = btn.getAttribute('data-wish-id');
            const name = btn.getAttribute('data-wish-name') || 'Produk';
            window.TMWishlist?.toggle?.(id, name);
            tmHomeApplyWishlistState();
        });

        window.addEventListener('storage', (event) => {
            if (event.key === 'tm_wishlist_items' || event.key === 'tm_wishlist_count') {
                tmHomeApplyWishlistState();
                window.TMWishlist?.updateBadges?.();
            }
        });

        // Auto-hide header on scroll (hide on scroll down, show on scroll up or when scrolling stops)
        (function(){
            const header = document.querySelector('header.tm-auto-hide-header');
            const main = document.querySelector('main');
            if (!header || !main) return;

            function setMainOffset(){
                // Prevent content from going under the fixed header (exact number, no gap)
                const rect = header.getBoundingClientRect();
                const styles = window.getComputedStyle(header);
                const marginBottom = parseFloat(styles.marginBottom) || 0;
                const h = Math.round(rect.height + marginBottom);
                main.style.paddingTop = h + 'px';
            }

            let lastY = window.pageYOffset || 0;
            let ticking = false;
            let stopTimer;

            function onScroll(){
                const y = window.pageYOffset || 0;
                header.classList.toggle('header--scrolled', y > 2);

                // If the global menu dropdown is open, keep header visible
                const menu = document.getElementById('globalMenu');
                const menuOpen = menu && !menu.classList.contains('hidden');
                if (!menuOpen){
                    if (y > lastY + 5 && y > 50){
                        header.classList.add('header--hidden');
                    } else if (y < lastY - 5){
                        header.classList.remove('header--hidden');
                    }
                } else {
                    header.classList.remove('header--hidden');
                }

                lastY = y;

                // Show header shortly after scrolling stops
                clearTimeout(stopTimer);
                stopTimer = setTimeout(() => {
                    header.classList.remove('header--hidden');
                }, 180);
            }

            window.addEventListener('load', setMainOffset);
            window.addEventListener('resize', setMainOffset);
            setMainOffset();

            window.addEventListener('scroll', () => {
                if (!ticking){
                    window.requestAnimationFrame(() => {
                        onScroll();
                        ticking = false;
                    });
                    ticking = true;
                }
            }, { passive: true });
        })();
    </script>
        <script>
            // Leaderboard renderer (Supabase-backed with graceful fallback)
            (async function(){
                const tableBody = document.getElementById('tmLeaderboardBody');
                const scoreHead = document.getElementById('tmLeaderboardScoreHead');
                const emptyEl = document.getElementById('tmLeaderboardEmpty');
                const podiumEl = document.getElementById('lbPodium');
                const tabLevel = document.getElementById('lbTabLevel');
                const tabDaily = document.getElementById('lbTabDaily');
                if (!tableBody) return;

                const ACTIVE_USER_KEY = 'tm_active_user';
                const AVATAR_MALE = 'https://avatar.iran.liara.run/public/boy';
                const AVATAR_FEMALE = 'https://avatar.iran.liara.run/public/girl';
                const SAMPLE_LEADERS = [
                    { id: 'lb-eco-1', full_name: 'Rani Arista', username: 'rani.eco', level: 4, exp: 1860, daily: 240, gender: 'female' },
                    { id: 'lb-eco-2', full_name: 'Dimas Rahadian', username: 'dimas.resell', level: 3, exp: 1120, daily: 180, gender: 'male' },
                    { id: 'lb-eco-3', full_name: 'Salsa Anindya', username: 'salvage.salsa', level: 5, exp: 2350, daily: 320, gender: 'female' },
                    { id: 'lb-eco-4', full_name: 'Maya Putri', username: 'maya.green', level: 3, exp: 980, daily: 150, gender: 'female' },
                    { id: 'lb-eco-5', full_name: 'Bagas Firmansyah', username: 'bagascycle', level: 2, exp: 610, daily: 120, gender: 'male' }
                ];

                const LEVEL_NAMES = {1:'Pemula Hijau',2:'Sahabat Bumi',3:'Pahlawan Daur Ulang',4:'Guardian Keberlanjutan',5:'Top 1% Penyelamat Lingkungan'};

                function levelNameById(id){
                    try {
                        const match = (window.TMGami?.LEVELS||[]).find(l=>l.id===id);
                        if (match) return match.name;
                    } catch {}
                    return LEVEL_NAMES[id] || `Level ${id}`;
                }
                function guessGenderFromName(name){
                    const lookupName = (name || '').trim().toLowerCase();
                    if (!lookupName) return 'male';
                    const femaleEndings = ['a','i','y','e'];
                    if (femaleEndings.some(end => lookupName.endsWith(end))) return 'female';
                    return 'male';
                }
                function placeholderAvatar(name, gender){
                    const safeName = encodeURIComponent((name || 'User').trim() || 'User');
                    const normalizedGender = gender === 'female' ? 'female' : (gender === 'male' ? 'male' : guessGenderFromName(name));
                    const base = normalizedGender === 'female' ? AVATAR_FEMALE : AVATAR_MALE;
                    return `${base}?name=${safeName}`;
                }
                function avatarUrl(name, custom, gender){
                    if (custom) return custom;
                    return placeholderAvatar(name, gender);
                }
                function formatNumber(v){
                    return (Number(v)||0).toLocaleString('id-ID');
                }
                function scoreDisplay(mode, value){
                    const formatted = formatNumber(value);
                    return mode === 'daily' ? `+${formatted} XP` : `${formatted} XP`;
                }
                function rowTpl(user, rank, mode){
                    const score = Number(mode === 'daily' ? user?.score : user?.exp);
                    const topClass = rank <= 3 ? ' tm-leaderboard-row--top' : '';
                    return `
                        <tr data-user-id="${user?.id||''}" class="tm-leaderboard-row${topClass}">
                            <td class="tm-leaderboard-rank">#${String(rank).padStart(2,'0')}</td>
                            <td>
                                <div class="tm-leaderboard-user">
                                    <img src="${avatarUrl(user?.full_name||user?.username||'User', user?.avatar_url, user?.gender)}" alt="${user?.full_name||user?.username||'User'}">
                                    <div>
                                        <div class="name">${user?.full_name||user?.username||'User'}</div>
                                        <div class="meta">${levelNameById(Number(user?.level)||1)}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center">Lv ${Number(user?.level)||1}</td>
                            <td class="text-right tm-leaderboard-score">${scoreDisplay(mode, score)}</td>
                        </tr>`;
                }
                function podiumTpl(user, rank, slot, mode){
                    const medal = slot==='1' ? '🥇' : (slot==='2' ? '🥈' : '🥉');
                    if (!user){
                        return `
                            <div class="tm-podium-slot tm-podium-slot--${slot}">
                                <div class="tm-podium-card tm-podium-card--${slot} tm-podium-card--empty">
                                    <div class="tm-podium-medal">${medal}</div>
                                    <div class="tm-podium-empty">Menunggu Pahlawan</div>
                                    <div class="tm-podium-rank">#${String(rank).padStart(2,'0')}</div>
                                    <div class="tm-podium-base tm-podium-base--${slot}"></div>
                                </div>
                            </div>`;
                    }
                    const score = Number(mode==='daily' ? user.score : user.exp)||0;
                    return `
                        <div class="tm-podium-slot tm-podium-slot--${slot}">
                            <div class="tm-podium-card tm-podium-card--${slot}">
                                <div class="tm-podium-medal">${medal}</div>
                                <img src="${avatarUrl(user.full_name||user.username||'User', user.avatar_url, user.gender)}" alt="${user.full_name||user.username||'User'}">
                                <div class="tm-podium-name">${user.full_name||user.username||'User'}</div>
                                <div class="tm-podium-level">${levelNameById(Number(user.level)||1)}</div>
                                <div class="tm-podium-xp">${scoreDisplay(mode, score)}</div>
                                <div class="tm-podium-rank">#${String(rank).padStart(2,'0')}</div>
                                <div class="tm-podium-base tm-podium-base--${slot}"></div>
                            </div>
                        </div>`;
                }

                function draw(mode, data, highlightId, { forceEmptyMessage=false } = {}){
                    const items = Array.isArray(data) ? data.slice(0,10) : [];
                    if (scoreHead) scoreHead.textContent = mode === 'daily' ? 'XP Hari Ini' : 'Total XP';

                    if (podiumEl){
                        const slots = [
                            { user: items[1] || null, rank: 2, slot: '2' },
                            { user: items[0] || null, rank: 1, slot: '1' },
                            { user: items[2] || null, rank: 3, slot: '3' }
                        ];
                        podiumEl.innerHTML = slots.map(s => podiumTpl(s.user, s.rank, s.slot, mode)).join('');
                    }

                    const rows = items.map((u, i)=> rowTpl(u, i+1, mode)).join('');
                    tableBody.innerHTML = rows;

                    if (highlightId){
                        const row = tableBody.querySelector(`[data-user-id="${highlightId}"]`);
                        if (row) row.classList.add('tm-leaderboard-row--me');
                    }

                    if (emptyEl){
                        if (items.length === 0 || forceEmptyMessage){
                            emptyEl.classList.remove('hidden');
                        } else {
                            emptyEl.classList.add('hidden');
                        }
                    }
                }

                function getActiveUserSnapshot(){
                    const sources = [];
                    try { sources.push(sessionStorage.getItem(ACTIVE_USER_KEY)); } catch {}
                    try { sources.push(localStorage.getItem(ACTIVE_USER_KEY)); } catch {}
                    for (const raw of sources){
                        if (!raw) continue;
                        try {
                            const parsed = JSON.parse(raw);
                            if (parsed && typeof parsed === 'object') return parsed;
                        } catch {}
                    }
                    return null;
                }

                function buildCurrentUser(){
                    const snapshot = getActiveUserSnapshot();
                    const name = (snapshot?.fullname || snapshot?.full_name || '').trim() || 'Sobat Thrift';
                    const email = snapshot?.email || '';
                    const username = email ? email.split('@')[0] : name.toLowerCase().split(/\s+/)[0] || 'guest';
                    const totalXp = Number(window.TMGami?.getXP ? window.TMGami.getXP() : 0) || 0;
                    const lvlInfo = window.TMGami?.getLevel ? window.TMGami.getLevel(totalXp) : null;
                    const level = Number(lvlInfo?.id || lvlInfo?.level || 1) || 1;
                    return {
                        id: snapshot?.id || 'local-user',
                        full_name: name,
                        username,
                        email,
                        exp: totalXp,
                        level,
                        avatar_url: snapshot?.avatar_url || placeholderAvatar(name, snapshot?.gender),
                        gender: snapshot?.gender || guessGenderFromName(name)
                    };
                }

                function buildSamplePlayers(mode){
                    return SAMPLE_LEADERS.map(player => ({
                        id: player.id,
                        full_name: player.full_name,
                        username: player.username,
                        level: player.level,
                        exp: player.exp,
                        score: player.daily,
                        gender: player.gender,
                        avatar_url: placeholderAvatar(player.full_name, player.gender)
                    })).map(player => {
                        if (mode === 'daily') return { ...player, score: Number(player.score)||0 };
                        return { ...player, exp: Number(player.exp)||0 };
                    });
                }

                function computeDailyXp(){
                    const key = 'tm_orders_history_v1';
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    let orders = [];
                    try { orders = JSON.parse(localStorage.getItem(key)||'[]'); } catch { orders = []; }
                    return orders.filter(order => {
                        if (!order?.ts) return false;
                        const ts = new Date(order.ts);
                        if (Number.isNaN(ts.getTime())) return false;
                        ts.setHours(0,0,0,0);
                        return ts.getTime() === today.getTime();
                    }).reduce((sum, order) => sum + (Number(order?.xpEarned)||0), 0);
                }

                async function renderSupabase(mode){
                    try {
                        if (!window.TMSupa || !TMSupa.getClient || !TMSupa.getClient()) return false;
                        const me = await TMSupa.getCurrentUser().catch(()=>null);
                        const client = TMSupa.getClient();
                        let data = [];
                        if (mode === 'daily'){
                            const since = new Date(); since.setHours(0,0,0,0);
                            const { data: orders, error } = await client
                                .from('orders')
                                .select('user_id, shipping_address, created_at')
                                .gte('created_at', since.toISOString());
                            if (error) throw error;
                            const aggregate = new Map();
                            (orders||[]).forEach(order => {
                                const xp = Number(order?.shipping_address?.xp_earned)||0;
                                if (!order.user_id || xp <= 0) return;
                                aggregate.set(order.user_id, (aggregate.get(order.user_id)||0) + xp);
                            });
                            const ids = Array.from(aggregate.keys());
                            if (ids.length){
                                const { data: profiles, error: e2 } = await client
                                    .from('profiles')
                                    .select('id, full_name, username, avatar_url, level, exp')
                                    .in('id', ids);
                                if (e2) throw e2;
                                data = profiles.map(p => ({ ...p, score: aggregate.get(p.id)||0 }))
                                    .filter(p => (p.score||0) > 0)
                                    .sort((a,b)=> (b.score||0) - (a.score||0));
                            }
                        } else {
                            const { data: profiles, error } = await client
                                .from('profiles')
                                .select('id, full_name, username, avatar_url, exp, level')
                                .order('level', { ascending: false })
                                .order('exp', { ascending: false })
                                .limit(10);
                            if (error) throw error;
                            data = profiles || [];
                        }
                        draw(mode, data, me?.user?.id || null);
                        return true;
                    } catch(e){
                        console.warn('Leaderboard Supabase error:', e?.message||e);
                        return false;
                    }
                }

                function renderLocal(mode){
                    let dataset = [];
                    const me = buildCurrentUser();
                    try {
                        if (mode === 'daily'){
                            const todayXp = computeDailyXp();
                            const myDaily = { ...me, score: todayXp };
                            const sample = buildSamplePlayers('daily');
                            dataset = [...sample, myDaily]
                                .filter(entry => typeof entry.score === 'number')
                                .map(entry => ({ ...entry, score: Number(entry.score)||0 }))
                                .sort((a,b) => (b.score||0) - (a.score||0));
                            draw(mode, dataset, myDaily.id, { forceEmptyMessage: dataset.length === 0 });
                        } else {
                            const sample = buildSamplePlayers('level');
                            const myTotal = { ...me, exp: Number(me.exp)||0 };
                            dataset = [...sample, myTotal]
                                .filter(entry => typeof entry.exp === 'number')
                                .map(entry => ({ ...entry, exp: Number(entry.exp)||0, level: Number(entry.level)||1 }))
                                .sort((a,b) => (b.level||0) === (a.level||0)
                                    ? (b.exp||0) - (a.exp||0)
                                    : (b.level||0) - (a.level||0));
                            draw(mode, dataset, myTotal.id, { forceEmptyMessage: dataset.length === 0 });
                        }
                    } catch {
                        dataset = [];
                        draw(mode, dataset, me.id, { forceEmptyMessage: true });
                    }

                    if (!emptyEl) return;
                    if (!dataset.length){
                        emptyEl.classList.remove('hidden');
                        emptyEl.textContent = 'Masuk untuk melihat leaderboard global secara real-time. Saat ini ditampilkan data dari perangkatmu.';
                    } else {
                        emptyEl.classList.add('hidden');
                        emptyEl.textContent = '';
                    }
                }

                async function render(mode){
                    tabLevel?.classList.toggle('tm-active', mode !== 'daily');
                    tabDaily?.classList.toggle('tm-active', mode === 'daily');
                    const ok = await renderSupabase(mode);
                    if (!ok) renderLocal(mode);
                }

                tabLevel?.addEventListener('click', ()=> render('level'));
                tabDaily?.addEventListener('click', ()=> render('daily'));
                render('level');
            })();
        </script>
</body>
</html>