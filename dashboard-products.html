<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produk - ThriftMap</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Leaflet CSS for Map View -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Index page global styles to match navbar and product grid -->
    <link rel="stylesheet" href="./assets/css/style-prefix.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com"> 
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --tm-primary: #16a34a;
            --tm-primary-dark: #15803d;
            --tm-secondary: #0f766e;
            --tm-bg: #f1f5f9;
            --tm-page: linear-gradient(180deg, #f8fafc 0%, #eefdf6 45%, #f8fafc 100%);
            --tm-surface: rgba(255, 255, 255, 0.94);
            --tm-border: rgba(15, 118, 110, 0.14);
            --tm-muted: #64748b;
            --tm-text: #0f172a;
            --tm-radius-lg: 22px;
            --tm-radius-md: 16px;
            --tm-radius-sm: 12px;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--tm-page);
            color: var(--tm-text);
        }

        header, header *, .header-main, .header-main *,
        .desktop-navigation-menu, .desktop-navigation-menu * {
            border: none !important;
        }

        header {
            position: sticky;
            top: 0;
            z-index: 1300;
            background: #fff !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1) !important;
        }

        .header-main { padding: 12px 0 !important; margin-bottom: 0 !important; }

        .header-main .container {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .header-user-actions {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: auto;
        }

        .action-btn {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f8f9fa;
            color: #2c3e50;
            transition: all 0.3s ease;
        }

        .action-btn:hover,
        .action-btn:focus-visible {
            background: #27ae60;
            color: #fff;
        }

        .action-btn .count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff6b6b;
            color: #fff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: grid;
            place-items: center;
            font-size: 11px;
            font-weight: 700;
        }

        .showcase:hover .showcase-actions .btn-action {
            width: min(200px, 72vw);
            padding-inline: 0.85rem;
        }

        .tm-nav-dropdown { position: relative; }

        .tm-nav-dropdown .tm-dropdown-panel {
            right: 0;
            left: auto;
        }

        .showcase-category {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 0.9rem;
            border-radius: 999px;
            background: rgba(14, 165, 233, 0.12);
            color: #0369a1;
            font-weight: 600;
            font-size: 0.8rem;
            letter-spacing: 0.01em;
        }

        .showcase-title {
            font-weight: 700;
            font-size: 1.15rem;
            color: #0f172a;
            margin: 0.7rem 0 0.4rem;
        }

        .showcase-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .map-popup-store {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.78rem;
            font-weight: 600;
            color: var(--tm-primary-dark);
            margin-bottom: 0.15rem;
        }

        .filters-wrap .chip {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.8rem;
            border-radius: 999px;
            background: rgba(22, 163, 74, 0.12);
            color: var(--tm-primary-dark);
            font-size: 13px;
            font-weight: 600;
        }

        .filters-wrap button {
            padding: 0.4rem 0.85rem;
            border-radius: 999px;
            border: 1px solid rgba(22, 163, 74, 0.24);
            background: rgba(22, 163, 74, 0.08);
            color: var(--tm-primary-dark);
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .filters-wrap button:hover {
            background: rgba(22, 163, 74, 0.18);
            box-shadow: 0 12px 24px rgba(22, 163, 74, 0.18);
        }

        .geo-status {
            font-size: 13px;
            color: var(--tm-muted);
        }

        .map-layout {
            display: grid;
            gap: 1.5rem;
        }

        @media (min-width: 1024px) {
            .map-layout {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }

        .glass-panel {
            background: var(--tm-surface);
            border-radius: var(--tm-radius-lg);
            border: 1px solid var(--tm-border);
            box-shadow: 0 26px 46px rgba(15, 118, 110, 0.16);
        }

        .map-results {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .map-results-header {
            padding: 1.1rem 1.25rem 0.75rem;
            border-bottom: 1px solid rgba(15, 118, 110, 0.1);
            display: grid;
            gap: 1rem;
        }

        .map-results-search {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .map-results-search .field-wrapper {
            position: relative;
            flex: 1;
        }

        .map-results-search .field-wrapper i {
            position: absolute;
            left: 0.85rem;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(100, 116, 139, 0.6);
        }

        .map-results-search input {
            width: 100%;
            padding: 0.65rem 0.85rem 0.65rem 2.4rem;
            border-radius: var(--tm-radius-sm);
            border: 1px solid var(--tm-border);
            background: rgba(250, 253, 251, 0.9);
            transition: border-color 0.2s ease;
        }

        .map-results-search input:focus {
            border-color: rgba(22, 163, 74, 0.5);
            box-shadow: 0 0 0 4px rgba(22, 163, 74, 0.15);
        }

        .map-results-search button {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            border: 1px solid rgba(22, 163, 74, 0.22);
            color: var(--tm-primary-dark);
            background: rgba(236, 253, 245, 0.9);
            transition: all 0.2s ease;
        }

        .map-results-search button:hover {
            background: rgba(209, 250, 229, 0.95);
            box-shadow: 0 12px 28px rgba(22, 163, 74, 0.18);
        }

        .map-slider {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 0.75rem;
            align-items: center;
            font-size: 14px;
            color: var(--tm-muted);
        }

        .map-slider label {
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            font-weight: 500;
            width: 100%;
        }

        .map-slider input[type="range"] {
            accent-color: var(--tm-primary);
            flex: 1;
        }

        .map-slider span {
            justify-self: end;
            font-weight: 600;
            color: var(--tm-primary-dark);
        }

        .map-container {
            height: 72vh;
            min-height: 520px;
            border-radius: var(--tm-radius-lg);
            overflow: hidden;
            border: 1px solid var(--tm-border);
            box-shadow: 0 30px 55px rgba(15, 118, 110, 0.18);
        }

        .results-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 0.25rem 0;
        }

        .results-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .results-scroll::-webkit-scrollbar-thumb {
            background: rgba(15, 118, 110, 0.24);
            border-radius: 999px;
        }

        .results-item {
            padding: 1rem 1.25rem;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
            display: block;
        }

        .results-item:hover {
            background: rgba(22, 163, 74, 0.08);
        }

        .results-item.is-active {
            background: rgba(22, 163, 74, 0.16);
            border-left-color: var(--tm-primary);
        }

        .results-item .card-top {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .results-item .thumbnail {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            object-fit: cover;
            box-shadow: 0 14px 24px rgba(15, 118, 110, 0.18);
        }

        .results-item .title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.15rem;
        }

        .results-item .title-row p {
            font-weight: 600;
            color: var(--tm-text);
        }

        .results-item .stats {
            font-size: 13px;
            color: var(--tm-muted);
            display: flex;
            align-items: center;
            gap: 0.45rem;
            flex-wrap: wrap;
        }

        .results-item .stats i {
            color: var(--tm-primary-dark);
        }

        .results-item .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.35rem;
        }

        .results-item .price {
            font-weight: 700;
            color: var(--tm-primary-dark);
        }

        .results-item .distance {
            font-size: 12px;
            color: var(--tm-muted);
        }

        .results-item .distance i {
            color: var(--tm-primary);
            margin-right: 0.35rem;
        }

        .results-empty {
            padding: 1.25rem;
            text-align: center;
            font-weight: 500;
            color: var(--tm-muted);
        }

        .product-main {
            margin-top: 2.5rem;
        }

        .product-main .title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--tm-text);
        }

        .product-main .title::after {
            content: '';
            height: 4px;
            width: 54px;
            border-radius: 999px;
            background: linear-gradient(135deg, rgba(22, 163, 74, 0.35), rgba(20, 184, 166, 0.4));
        }

        .product-grid {
            display: grid;
            gap: 1.8rem;
        }

        .product-grid-wrap {
            margin-top: 1.75rem;
            padding: 2rem 2rem 2.4rem;
            border-radius: var(--tm-radius-lg);
            border: 1px solid var(--tm-border);
            background: var(--tm-surface);
            box-shadow: 0 26px 50px rgba(15, 118, 110, 0.16);
        }

        @media (min-width: 768px) {
            .product-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }

        .showcase {
            position: relative;
            border-radius: 28px;
            background: rgba(255, 255, 255, 0.96);
            border: 1px solid rgba(15, 118, 110, 0.08);
            box-shadow: 0 24px 46px rgba(15, 118, 110, 0.12);
            overflow: hidden;
            transition: transform 0.35s ease, box-shadow 0.35s ease;
        }

        .showcase::before {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: radial-gradient(circle at 20% -20%, rgba(45, 212, 191, 0.18), transparent 55%),
                        radial-gradient(circle at 80% 0%, rgba(14, 165, 233, 0.16), transparent 50%);
            opacity: 0;
            transition: opacity 0.35s ease;
            pointer-events: none;
        }

        .showcase:hover {
            transform: translateY(-10px) scale(1.01);
            box-shadow: 0 32px 60px rgba(15, 118, 110, 0.18);
        }

        .showcase:hover::before {
            opacity: 1;
        }

        .showcase-banner {
            position: relative;
            padding: 1.4rem 1.4rem 1.2rem;
        }

        .showcase-banner::before {
            content: "";
            position: absolute;
            inset: 1.1rem;
            border-radius: 24px;
            background: linear-gradient(140deg, rgba(45, 212, 191, 0.22), rgba(16, 185, 129, 0.2));
            filter: blur(18px);
            z-index: 0;
        }

        .showcase-banner img {
            position: relative;
            z-index: 1;
            border-radius: 24px;
            width: 100%;
            aspect-ratio: 4 / 3;
            object-fit: cover;
            display: block;
            height: auto !important;
            box-shadow: 0 22px 35px rgba(14, 116, 144, 0.18);
            transition: transform 0.35s ease, opacity 0.35s ease;
        }

        .showcase:hover .showcase-banner img {
            transform: translateY(-6px) scale(1.01);
            opacity: 0.08;
        }

        .showcase-actions {
            position: absolute;
            top: 50%;
            left: 50%;
            display: grid;
            gap: 0.65rem;
            justify-items: stretch;
            padding: 0.55rem;
            border-radius: 24px;
            background: linear-gradient(160deg, rgba(15, 118, 110, 0.28), rgba(14, 165, 233, 0.12));
            border: 1px solid rgba(255, 255, 255, 0.35);
            backdrop-filter: blur(16px) saturate(160%);
            box-shadow: 0 20px 38px rgba(15, 118, 110, 0.22);
            transform: translate3d(-52%, -54%, 0) scale(0.9);
            z-index: 2;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.35s ease, transform 0.35s ease, padding 0.35s ease, gap 0.35s ease, box-shadow 0.35s ease;
        }

        .showcase:hover .showcase-actions {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transform: translate3d(-52%, -52%, 0) scale(1);
            padding: 1.15rem 1.25rem;
            gap: 0.85rem;
            box-shadow: 0 28px 52px rgba(15, 118, 110, 0.3);
        }

        .showcase-actions .btn-action {
            position: relative;
            width: 44px;
            height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            padding: 0;
            border-radius: 16px;
            background: linear-gradient(140deg, rgba(255, 255, 255, 0.75), rgba(241, 253, 249, 0.58));
            color: #0f172a;
            border: 1px solid rgba(15, 118, 110, 0.16);
            box-shadow: 0 12px 24px rgba(15, 118, 110, 0.16);
            transition: transform 0.25s ease, box-shadow 0.25s ease, color 0.2s ease, background 0.2s ease, border-color 0.25s ease, width 0.35s ease, padding 0.35s ease;
            backdrop-filter: blur(6px);
            overflow: hidden;
            white-space: nowrap;
        }

        .showcase-actions .btn-action::after {
            content: "";
            position: absolute;
            inset: -9px;
            border-radius: 22px;
            background: radial-gradient(circle at 50% 50%, rgba(16, 185, 129, 0.32), transparent 68%);
            opacity: 0;
            transition: opacity 0.32s ease;
            z-index: -1;
        }

        .showcase-actions .btn-action ion-icon {
            font-size: 1.05rem;
            color: inherit;
            flex-shrink: 0;
            transition: transform 0.35s ease;
        }

        .showcase-actions .btn-action span {
            font-size: 0.84rem;
            font-weight: 600;
            color: #0f172a;
            opacity: 0;
            transform: translateX(-12px);
            transition: opacity 0.2s ease 0.06s, transform 0.3s ease 0.06s, color 0.2s ease;
        }

        .showcase-actions .btn-action:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 24px 38px rgba(15, 118, 110, 0.28);
            color: var(--tm-primary-dark);
            background: linear-gradient(140deg, rgba(16, 185, 129, 0.25), rgba(14, 165, 233, 0.16));
            border-color: rgba(16, 185, 129, 0.4);
        }

        .showcase:hover .showcase-actions .btn-action ion-icon {
            transform: translateX(0);
        }

        .showcase:hover .showcase-actions .btn-action span {
            opacity: 1;
            transform: translateX(0);
            color: var(--tm-primary-dark);
        }

        .showcase-actions .btn-action:hover::after {
            opacity: 1;
        }

        .showcase-content {
            padding: 1.35rem 1.6rem 1.6rem;
            position: relative;
        }

        .showcase-category {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 0.9rem;
            border-radius: 999px;
            background: rgba(14, 165, 233, 0.12);
            color: #0369a1;
            font-weight: 600;
            font-size: 0.8rem;
            letter-spacing: 0.01em;
        }

        .showcase-title {
            font-weight: 700;
            font-size: 1.15rem;
            color: #0f172a;
            margin: 0.7rem 0 0.4rem;
        }

        .showcase-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: rgba(15, 23, 42, 0.55);
        }

        .showcase-meta span {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        .showcase-meta .store-indicator {
            color: var(--tm-primary-dark);
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .detail-store-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            border-radius: 999px;
            padding: 0.4rem 0.8rem;
            background: rgba(16, 185, 129, 0.12);
            color: var(--tm-primary-dark);
            font-weight: 600;
            font-size: 0.85rem;
        }

        .price-box {
            position: relative;
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 0.85rem;
            z-index: 2;
        }

        .price-box .price {
            font-size: 1.45rem;
            font-weight: 700;
            color: var(--tm-primary-dark);
        }

        .price-box del {
            color: rgba(15, 23, 42, 0.35);
        }

        .showcase-footer-accent {
            display: none;
        }

        .detail-panel {
            border-radius: var(--tm-radius-lg);
            background: var(--tm-surface);
            border: 1px solid var(--tm-border);
            box-shadow: 0 28px 46px rgba(15, 118, 110, 0.18);
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1.1rem;
            border-bottom: 1px solid rgba(15, 118, 110, 0.08);
            padding-bottom: 1.4rem;
        }

        .detail-header h2 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .detail-close {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.55rem 0.95rem;
            border-radius: var(--tm-radius-sm);
            border: 1px solid var(--tm-border);
            background: rgba(255, 255, 255, 0.92);
            color: var(--tm-muted);
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .detail-close:hover {
            color: var(--tm-primary-dark);
            border-color: rgba(22, 163, 74, 0.3);
            box-shadow: 0 12px 26px rgba(22, 163, 74, 0.18);
        }

        .detail-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.4rem 0.75rem;
            border-radius: 999px;
            background: rgba(22, 163, 74, 0.12);
            color: var(--tm-primary-dark);
            font-weight: 600;
            font-size: 13px;
        }

        .detail-price-group {
            display: flex;
            align-items: baseline;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .detail-price-group .primary {
            font-size: 2rem;
            font-weight: 700;
            color: var(--tm-primary-dark);
        }

        .detail-price-group del {
            color: rgba(15, 23, 42, 0.35);
        }

        .detail-price-group .badge {
            padding: 0.35rem 0.75rem;
            border-radius: 999px;
            background: rgba(248, 113, 113, 0.18);
            color: #b91c1c;
            font-weight: 600;
        }

        .quantity-control {
            display: inline-flex;
            align-items: center;
            border-radius: var(--tm-radius-sm);
            border: 1px solid var(--tm-border);
            background: rgba(248, 250, 252, 0.85);
            overflow: hidden;
        }

        .quantity-control button {
            width: 44px;
            height: 44px;
            background: transparent;
            font-weight: 600;
            border: none;
            color: var(--tm-muted);
            transition: color 0.2s ease;
        }

        .quantity-control span {
            display: inline-block;
            width: 48px;
            text-align: center;
            font-weight: 600;
        }

        .quantity-control button:hover {
            color: var(--tm-primary);
        }

        .detail-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .detail-actions .primary-btn {
            flex: 1;
            min-width: 200px;
            background: var(--tm-primary);
            color: #fff;
            border-radius: var(--tm-radius-sm);
            padding: 0.85rem 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
        }

        .detail-actions .primary-btn:hover {
            background: var(--tm-primary-dark);
            box-shadow: 0 18px 32px rgba(22, 163, 74, 0.24);
        }

        .detail-actions .ghost-btn {
            width: 56px;
            height: 56px;
            border-radius: 18px;
            border: 1px solid var(--tm-border);
            color: var(--tm-muted);
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .detail-actions .ghost-btn:hover {
            color: var(--tm-primary);
            border-color: rgba(22, 163, 74, 0.3);
            box-shadow: 0 18px 36px rgba(22, 163, 74, 0.2);
        }

        #detailThumbnails img {
            border-radius: 16px;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        #detailThumbnails img:hover {
            transform: translateY(-2px);
        }

        #detailThumbnails img.border-2.border-green-500 {
            border-color: var(--tm-primary);
            box-shadow: 0 12px 28px rgba(22, 163, 74, 0.2);
        }

        .tm-bottom-nav {
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid var(--tm-border);
            box-shadow: 0 -18px 32px rgba(15, 118, 110, 0.12);
        }

        .tm-bottom-nav a {
            color: var(--tm-muted);
            font-weight: 600;
            transition: color 0.2s ease;
        }

        .tm-bottom-nav a.active,
        .tm-bottom-nav a:hover {
            color: var(--tm-primary-dark);
        }

        .tm-bottom-nav ion-icon {
            font-size: 1.2rem;
            margin-bottom: 0.15rem;
        }

        * {
            outline: none !important;
        }

        button:focus,
        button:hover,
        button:active {
            outline: none !important;
        }

        .btn {
            transition: all 0.25s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.25);
        }

        .leaflet-popup-content-wrapper {
            padding: 0;
            background: transparent;
            border: none;
            box-shadow: none;
        }

        .leaflet-popup-content {
            margin: 0;
        }

        .leaflet-popup-close-button {
            top: 10px !important;
            right: 12px !important;
            color: #0f172a;
        }

        .leaflet-popup-tip {
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.18);
        }

        .map-popup-card {
            width: 240px;
            border-radius: 22px;
            overflow: hidden;
            background: linear-gradient(145deg, rgba(236, 253, 245, 0.95), rgba(209, 250, 229, 0.9));
            border: 1px solid rgba(15, 118, 110, 0.15);
            box-shadow: 0 24px 46px rgba(15, 118, 110, 0.25);
        }

        .map-popup-header {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            padding: 0.65rem 0.75rem 0.55rem;
            background: linear-gradient(120deg, rgba(22, 163, 74, 0.16), rgba(14, 165, 233, 0.08));
        }

        .map-popup-image {
            width: 64px;
            height: 64px;
            border-radius: 18px;
            object-fit: cover;
            flex-shrink: 0;
            box-shadow: 0 12px 24px rgba(15, 118, 110, 0.22);
            border: 2px solid rgba(255, 255, 255, 0.85);
        }

        .map-popup-title {
            font-weight: 700;
            font-size: 0.98rem;
            color: #0f172a;
            margin-bottom: 0.1rem;
        }

        .map-popup-store {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.78rem;
            font-weight: 600;
            color: var(--tm-primary-dark);
            margin-bottom: 0.15rem;
        }

        .map-popup-price {
            font-weight: 700;
            color: var(--tm-primary-dark);
            font-size: 1.05rem;
        }

        .map-popup-distance {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.25rem 0.55rem;
            border-radius: 999px;
            background: rgba(15, 118, 110, 0.12);
            color: var(--tm-secondary);
            font-size: 0.68rem;
            font-weight: 600;
            margin-top: 0.2rem;
            white-space: nowrap;
        }

        .map-popup-body {
            padding: 0.65rem 0.75rem 0.8rem;
            background: rgba(255, 255, 255, 0.98);
        }

        .map-popup-meta {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.35rem 0.5rem;
            font-size: 0.78rem;
        }

        .condition-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.32rem 0.7rem;
            border-radius: 999px;
            font-size: 0.72rem;
            font-weight: 600;
        }

        .condition-excellent {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.18), rgba(59, 130, 246, 0.14));
            color: #0f766e;
        }

        .condition-good {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.18), rgba(14, 165, 233, 0.16));
            color: #1d4ed8;
        }

        .condition-fair {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.2), rgba(250, 204, 21, 0.18));
            color: #c2410c;
        }

        .showcase .condition-badge {
            margin: 8px 0;
        }

        .results-item .condition-badge {
            flex-shrink: 0;
        }

        .map-popup-category {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.7rem;
            border-radius: 999px;
            background: rgba(14, 165, 233, 0.12);
            color: #0369a1;
            font-weight: 600;
        }

        .map-popup-cta {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.45rem;
            width: 100%;
            padding: 0.75rem;
            border-radius: 14px;
            background: linear-gradient(135deg, #16a34a, #0ea5e9);
            color: #ffffff !important;
            font-weight: 700;
            font-size: 0.9rem;
            margin-top: 0.75rem;
            text-decoration: none;
            box-shadow: 0 16px 28px rgba(22, 163, 74, 0.28);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .map-popup-cta:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 36px rgba(14, 165, 233, 0.3);
        }

        .map-popup-cta i {
            color: inherit;
        }

        .map-popup-cta:visited {
            color: #ffffff !important;
        }

        @media (max-width: 1023px) {
            .header-main .container {
                flex-wrap: wrap;
            }

            .header-search-container {
                order: 3;
                width: 100%;
                min-width: 100%;
            }

            .header-user-actions {
                order: 2;
            }

            .map-layout {
                grid-template-columns: 1fr;
            }

            .map-container {
                height: 420px;
            }

            .product-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (max-width: 640px) {
            .header-search-container {
                box-shadow: none;
            }

            .view-toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .view-toggle {
                width: 100%;
            }

            .toggle-btn {
                flex: 1;
                justify-content: center;
            }

            .product-grid {
                grid-template-columns: 1fr;
            }

            .detail-actions {
                flex-direction: column;
            }

            .detail-actions .ghost-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
        <!-- Index-style Header/Navbar -->
        <header>
            <div class="header-main">
                <div class="container">
                    <a href="dashboard-home.html" class="header-logo">
                        <img src="./assets/images/logo/logo.svg" alt="ThriftMap logo" width="120" height="36">
                    </a>
                    <div class="header-search-container">
                        <input id="globalSearch" type="search" name="search" class="search-field" placeholder="Cari produk preloved...">
                        <button class="search-btn" id="globalSearchBtn">
                            <ion-icon name="search-outline"></ion-icon>
                        </button>
                    </div>
                                        <div class="header-user-actions">
                                                <a href="dashboard-profile.html" class="action-btn" title="Akun">
                                                    <ion-icon name="person-outline"></ion-icon>
                                                </a>
                                                <a href="dashboard-cart.html" class="action-btn" title="Keranjang">
                                                    <ion-icon name="bag-handle-outline"></ion-icon>
                                                    <span class="count cart-count" style="display:none">0</span>
                                                </a>
                                                <a href="dashboard-wishlist.html" class="action-btn" title="Wishlist">
                                                    <ion-icon name="heart-outline"></ion-icon>
                                                    <span class="count wish-count" style="display:none">0</span>
                                                </a>
                                                <div class="tm-nav-dropdown">
                                                    <button class="action-btn" id="globalMenuBtn" aria-haspopup="true" aria-expanded="false" title="Menu">
                                                        <ion-icon name="menu-outline"></ion-icon>
                                                    </button>
                                                    <div class="tm-dropdown-panel hidden" id="globalMenu">
                                                        <a href="dashboard-home.html"><span class="label"><ion-icon name="home-outline"></ion-icon> Beranda</span></a>
                                                        <a href="dashboard-products.html"><span class="label"><ion-icon name="storefront-outline"></ion-icon> Produk</span></a>
                                                        <a href="dashboard-orders.html"><span class="label"><ion-icon name="bag-check-outline"></ion-icon> Pesanan</span><span class="badge orders-count" style="display:none">0</span></a>
                                                        <a href="dashboard-tracking.html"><span class="label"><ion-icon name="location-outline"></ion-icon> Lacak</span></a>
                                                        <a href="dashboard-settings.html"><span class="label"><ion-icon name="settings-outline"></ion-icon> Pengaturan</span></a>
                                                    </div>
                                                </div>
                                        </div>
                </div>
            </div>
            
        </header>

    <!-- Page Content -->
    <main class="max-w-7xl mx-auto px-4 md:px-8 py-10 pb-28 space-y-10 mt-3">
            <!-- View Toggle + Filter Summary -->
            <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
                <div class="flex items-center gap-2">
                    <button id="btnMapView" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50 flex items-center gap-2">
                        <i class="fas fa-map"></i><span>Map View</span>
                    </button>
                    <button id="btnGridView" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50 flex items-center gap-2">
                        <i class="fas fa-th"></i><span>Grid View</span>
                    </button>
                </div>
                <div class="flex items-center gap-2">
                  <div id="activeFilters" class="hidden flex items-center gap-2 flex-wrap"></div>
                  <div class="text-sm text-gray-500 hidden sm:block" id="geoStatus"></div>
                </div>
            </div>

            <!-- MAP VIEW -->
            <div id="mapSection" class="map-layout">
                <!-- Left: Results like GMaps -->
                <aside class="glass-panel map-results lg:col-span-1">
                    <div class="map-results-header">
                        <div class="map-results-search">
                            <div class="field-wrapper">
                                <i class="fas fa-search"></i>
                                <input id="searchInput" type="text" placeholder="Cari produk, kategori, kondisi..." aria-label="Cari produk di sekitar Anda">
                            </div>
                            <button id="btnUseLocation" type="button" title="Gunakan lokasiku" aria-label="Gunakan lokasi saya">
                                <i class="fas fa-location-crosshairs"></i>
                            </button>
                        </div>
                        <div class="map-slider">
                            <label for="radiusRange">
                                <span>Radius</span>
                                <input id="radiusRange" type="range" min="1" max="20" value="5">
                            </label>
                            <span id="radiusLabel">5 km</span>
                        </div>
                    </div>
                    <div id="resultsList" class="results-scroll">
                        <!-- Results injected here -->
                    </div>
                </aside>

                <!-- Right: Map -->
                <section class="lg:col-span-2">
                    <div id="productsMap" class="map-container bg-gray-100"></div>
                </section>
            </div>

            <!-- GRID VIEW (index-style) -->
            <div id="gridSection" class="hidden">
              <section class="product-main">
                <div class="container">
                  <h2 id="productsHeading" class="title">Semua Produk</h2>
                                    <div class="product-grid-wrap">
                                        <div class="product-grid" id="productsGrid"></div>
                                    </div>
                </div>
              </section>
            </div>

            <!-- Product Detail -->
            <section id="productDetail" class="mt-12 hidden">
                <div class="detail-panel p-6 lg:p-8">
                    <div class="detail-header">
                        <div>
                            <h2 id="detailTitle">Detail Produk</h2>
                            <p class="geo-status">Informasi lengkap produk pilihan Anda</p>
                        </div>
                        <button id="closeDetail" class="detail-close">
                            <i class="fas fa-times"></i>
                            <span>Tutup</span>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                        <div>
                            <div class="mb-4 rounded-2xl overflow-hidden shadow-lg">
                                <img id="detailImage" src="" alt="Produk" class="w-full h-96 object-cover">
                            </div>
                            <div class="grid grid-cols-4 gap-3" id="detailThumbnails">
                                <!-- Thumbnails injected here -->
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span id="detailStore" class="detail-store-tag">
                                    <i class="fas fa-store"></i>
                                    <span class="detail-store-text">ThriftMap Store</span>
                                </span>
                                <span id="detailStoreInfo" class="geo-status">Partner preloved pilihan</span>
                            </div>

                            <div class="detail-price-group">
                                <span id="detailPrice" class="primary">Rp 0</span>
                                <del id="detailOriginalPrice"></del>
                                <span class="badge" id="detailDiscount"></span>
                            </div>

                            <div>
                                <h3 class="font-semibold text-lg mb-2">Deskripsi</h3>
                                <p id="detailDescription" class="text-gray-600 leading-relaxed">
                                    Pilih produk untuk melihat deskripsi lengkap.
                                </p>
                            </div>

                            <div>
                                <h3 class="font-semibold text-lg mb-2">Spesifikasi</h3>
                                <div class="grid grid-cols-2 gap-2 text-sm text-gray-600" id="detailSpecs">
                                    <!-- Specs injected here -->
                                </div>
                            </div>

                            <div class="detail-actions">
                                <div class="quantity-control">
                                    <button id="qtyMinus" type="button">-</button>
                                    <span id="detailQuantity">1</span>
                                    <button id="qtyPlus" type="button">+</button>
                                </div>
                                
                                <button class="primary-btn" type="button">
                                    <i class="fas fa-shopping-cart mr-2"></i>Tambah ke Keranjang
                                </button>
                                
                                <button class="ghost-btn" type="button">
                                    <i class="fas fa-heart"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

    <!-- Mobile Bottom Navigation -->
    <nav class="tm-bottom-nav fixed bottom-0 inset-x-0 z-40 md:hidden">
        <div class="flex justify-around py-2 text-xs">
            <a data-nav href="dashboard-home.html" class="flex flex-col items-center gap-1">
                <i class="fas fa-home text-base"></i>
                <span>Home</span>
            </a>
            <a data-nav href="dashboard-products.html" class="flex flex-col items-center gap-1">
                <i class="fas fa-tags text-base"></i>
                <span>Produk</span>
            </a>
            <a data-nav href="dashboard-orders.html" class="flex flex-col items-center gap-1">
                <i class="fas fa-shopping-bag text-base"></i>
                <span>Pesanan</span>
            </a>
            <a data-nav href="dashboard-tracking.html" class="flex flex-col items-center gap-1">
                <i class="fas fa-map-marker-alt text-base"></i>
                <span>Lacak</span>
            </a>
            <a data-nav href="dashboard-profile.html" class="flex flex-col items-center gap-1">
                <i class="fas fa-user text-base"></i>
                <span>Profil</span>
            </a>
        </div>
    </nav>

    <script src="./assets/js/cart.js"></script>
    <script src="./assets/js/notify.js"></script>
    <script src="./assets/js/wishlist.js"></script>
    <!-- Ionicons for index-style UI -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <script>
        // Wishlist badge persistence
        (function(){
            const KEY = 'tm_wishlist_count';
            function update(){
                const c = parseInt(localStorage.getItem(KEY)||'0',10)||0;
                document.querySelectorAll('.wish-count').forEach(b=>{
                    if (c>0){ b.textContent = String(c); b.style.display=''; }
                    else { b.textContent='0'; b.style.display='none'; }
                });
            }
            document.addEventListener('DOMContentLoaded', update);
            window.TMWishlist = Object.assign(window.TMWishlist||{}, {
                set(n){ localStorage.setItem(KEY, String(Math.max(0, Number(n)||0))); update(); },
                increment(){ const v=(parseInt(localStorage.getItem(KEY)||'0',10)||0)+1; localStorage.setItem(KEY, String(v)); update(); },
                decrement(){ const v=Math.max(0,(parseInt(localStorage.getItem(KEY)||'0',10)||0)-1); localStorage.setItem(KEY, String(v)); update(); }
            });
        })();
        // Global menu dropdown & bottom nav active
        (function(){
            const btn = document.getElementById('globalMenuBtn');
            const menu = document.getElementById('globalMenu');
            if (btn && menu) {
                btn.addEventListener('click', () => {
                    const expanded = btn.getAttribute('aria-expanded') === 'true';
                    btn.setAttribute('aria-expanded', String(!expanded));
                    menu.classList.toggle('hidden');
                });
                document.addEventListener('click', (e) => {
                    if (!menu.contains(e.target) && e.target !== btn && !btn.contains(e.target)) {
                        menu.classList.add('hidden');
                        btn.setAttribute('aria-expanded', 'false');
                    }
                });
                // Initial sync of badges
                try {
                  const orders = parseInt(localStorage.getItem('tm_orders_count')||'0',10);
                  const wishList = JSON.parse(localStorage.getItem('tm_wishlist')||'[]');
                  const wCount = Array.isArray(wishList)? wishList.length : 0;
                  const oEl = menu.querySelector('.orders-count');
                  const wEl = menu.querySelector('.wish-count');
                  if (oEl) { if (orders>0){ oEl.style.display='inline-block'; oEl.textContent=String(orders);} else {oEl.style.display='none';} }
                  if (wEl) { if (wCount>0){ wEl.style.display='inline-block'; wEl.textContent=String(wCount);} else {wEl.style.display='none';} }
                } catch {}
            }
            document.querySelectorAll('a[data-nav]').forEach(a => {
                const href = a.getAttribute('href') || '';
                if (location.pathname.endsWith(href)) {
                    a.classList.add('active');
                    a.setAttribute('aria-current', 'page');
                }
            });
        })();

        // View toggle
        const mapSection = document.getElementById('mapSection');
        const gridSection = document.getElementById('gridSection');
        const btnMapView = document.getElementById('btnMapView');
        const btnGridView = document.getElementById('btnGridView');
        function setToggleActive(active) {
            [btnMapView, btnGridView].forEach(btn => btn.classList.remove('is-active'));
            active.classList.add('is-active');
        }
        btnMapView.addEventListener('click', () => {
            mapSection.classList.remove('hidden');
            gridSection.classList.add('hidden');
            setToggleActive(btnMapView);
            setTimeout(() => productsMap && productsMap.invalidateSize(), 200);
        });
        btnGridView.addEventListener('click', () => {
            gridSection.classList.remove('hidden');
            mapSection.classList.add('hidden');
            setToggleActive(btnGridView);
        });
        // Set initial active state
        setToggleActive(btnMapView);

                // Global header search -> filter grid
                (function(){
                    const input = document.getElementById('globalSearch');
                    const btn = document.getElementById('globalSearchBtn');
                    function doSearch(){
                        if (!input) return;
                        const q = input.value || '';
                        // Switch to grid view for search results
                        if (btnGridView) btnGridView.click();
                        renderProducts(q);
                        const h = document.getElementById('productsHeading');
                        if (h) h.textContent = q ? `Hasil: ${q}` : 'Semua Produk';
                        renderFilterPills(q ? [q] : []);
                    }
                    if (btn) btn.addEventListener('click', (e)=>{ e.preventDefault(); doSearch(); });
                    if (input) input.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { e.preventDefault(); doSearch(); } });
                })();

                        // Make header dropdown categories filter the grid
                        (function(){
                            const panel = document.querySelector('.dropdown-panel');
                            if (!panel) return;
                            panel.addEventListener('click', (e)=>{
                                const a = e.target.closest('a');
                                if (!a) return;
                                const txt = (a.textContent || '').trim();
                                if (!txt) return;
                                // prevent following image/banner links
                                e.preventDefault();
                                if (btnGridView) btnGridView.click();
                                const keywords = getFilterKeywords(txt);
                                renderProducts(keywords);
                                const h = document.getElementById('productsHeading');
                                if (h) h.textContent = `Kategori: ${txt}`;
                                renderFilterPills([txt]);
                            });
                        })();

        const productsGrid = document.getElementById('productsGrid');
        const productDetail = document.getElementById('productDetail');
        const detailTitle = document.getElementById('detailTitle');
        const detailImage = document.getElementById('detailImage');
    const detailThumbnails = document.getElementById('detailThumbnails');
    const detailStore = document.getElementById('detailStore');
    const detailStoreText = detailStore ? detailStore.querySelector('.detail-store-text') : null;
    const detailStoreInfo = document.getElementById('detailStoreInfo');
        const detailPrice = document.getElementById('detailPrice');
        const detailOriginalPrice = document.getElementById('detailOriginalPrice');
        const detailDiscount = document.getElementById('detailDiscount');
        const detailDescription = document.getElementById('detailDescription');
        const detailSpecs = document.getElementById('detailSpecs');
        const detailQuantity = document.getElementById('detailQuantity');
        const closeDetail = document.getElementById('closeDetail');
        const qtyMinus = document.getElementById('qtyMinus');
        const qtyPlus = document.getElementById('qtyPlus');

    let currentQuantity = 1;

        const sampleProducts = [
            {
                id: 1,
                name: "Jaket Kulit Pria",
                price: 72000,
                originalPrice: 85000,
                image: "./assets/images/products/jacket-3.jpg",
                gallery: [
                    "./assets/images/products/jacket-3.jpg",
                    "./assets/images/products/jacket-4.jpg",
                    "./assets/images/products/jacket-5.jpg",
                    "./assets/images/products/jacket-6.jpg"
                ],
                category: "Pria",
                condition: "Sangat Baik",
                store: "Vintage Locker",
                rating: 4.5,
                description: "Jaket kulit pria berkualitas tinggi dengan desain klasik yang timeless. Cocok untuk musim dingin dengan bahan yang hangat dan nyaman. Kondisi masih sangat baik dengan sedikit tanda pakai.",
                specs: [
                    { label: "Kondisi", value: "Sangat Baik" },
                    { label: "Brand", value: "Vintage Co." },
                    { label: "Bahan", value: "Kulit Asli" },
                    { label: "Warna", value: "Coklat" },
                    { label: "Ukuran", value: "L" },
                    { label: "Stok", value: "1 pcs" }
                ]
            },
            {
                id: 2,
                name: "Kemeja Katun Premium",
                price: 45000,
                originalPrice: 56000,
                image: "./assets/images/products/shirt-1.jpg",
                gallery: [
                    "./assets/images/products/shirt-1.jpg",
                    "./assets/images/products/clothes-4.jpg",
                    "./assets/images/products/clothes-5.jpg"
                ],
                category: "Pria",
                condition: "Baik",
                store: "Urban Threads Outlet",
                rating: 4.2,
                description: "Kemeja katun premium dengan tekstur halus dan nyaman dipakai sepanjang hari. Cutting slim fit membuat penampilan lebih rapi.",
                specs: [
                    { label: "Kondisi", value: "Baik" },
                    { label: "Brand", value: "Urban Threads" },
                    { label: "Bahan", value: "Katun" },
                    { label: "Warna", value: "Putih" },
                    { label: "Ukuran", value: "M" },
                    { label: "Stok", value: "2 pcs" }
                ]
            },
            {
                id: 3,
                name: "Dress Floral Midi",
                price: 55000,
                originalPrice: 70000,
                image: "./assets/images/products/clothes-3.jpg",
                gallery: [
                    "./assets/images/products/clothes-3.jpg",
                    "./assets/images/products/clothes-1.jpg",
                    "./assets/images/products/clothes-2.jpg"
                ],
                category: "Wanita",
                condition: "Seperti Baru",
                store: "Bloom & Co. Boutique",
                rating: 4.8,
                description: "Dress floral midi yang feminin dengan bahan adem dan jatuh. Cocok untuk acara semi formal maupun casual brunch.",
                specs: [
                    { label: "Kondisi", value: "Seperti Baru" },
                    { label: "Brand", value: "Bloom & Co." },
                    { label: "Bahan", value: "Rayon" },
                    { label: "Warna", value: "Navy Floral" },
                    { label: "Ukuran", value: "M" },
                    { label: "Stok", value: "1 pcs" }
                ]
            },
            {
                id: 4,
                name: "Tas Mini Wanita",
                price: 42000,
                originalPrice: 55000,
                image: "./assets/images/products/bag-1.png",
                gallery: [
                    "./assets/images/products/party-wear-1.jpg",
                    "./assets/images/products/party-wear-2.jpg"
                ],
                category: "Aksesoris",
                condition: "Baik",
                store: "Minimalist Finds",
                rating: 4.3,
                description: "Tas mini wanita dengan desain chic yang mudah dipadupadankan. Tersedia tali panjang dan pendek sekaligus.",
                specs: [
                    { label: "Kondisi", value: "Baik" },
                    { label: "Brand", value: "Minimalist" },
                    { label: "Bahan", value: "Kulit Sintetis" },
                    { label: "Warna", value: "Hitam" },
                    { label: "Ukuran", value: "20 x 15 cm" },
                    { label: "Stok", value: "3 pcs" }
                ]
            },
            {
                id: 5,
                name: "Sepatu Kantor",
                price: 88000,
                originalPrice: 120000,
                image: "./assets/images/products/shoe-1.jpg",
                gallery: [
                    "./assets/images/products/shoe-1.jpg",
                    "./assets/images/products/shoe-2.jpg",
                    "./assets/images/products/shoe-3.jpg"
                ],
                category: "Sepatu",
                condition: "Cukup",
                store: "Street Step Hub",
                rating: 4.0,
                description: "Sneakers kasual yang nyaman untuk aktivitas sehari-hari. Sol masih tebal dan upper dalam kondisi baik.",
                specs: [
                    { label: "Kondisi", value: "Cukup" },
                    { label: "Brand", value: "Street Step" },
                    { label: "Bahan", value: "Canvas" },
                    { label: "Warna", value: "Putih" },
                    { label: "Ukuran", value: "42" },
                    { label: "Stok", value: "1 pasang" }
                ]
            },
            {
                id: 6,
                name: "Sweater Hoodie",
                price: 48000,
                originalPrice: 65000,
                image: "./assets/images/products/jacket-1.jpg",
                gallery: [
                    "./assets/images/products/jacket-1.jpg",
                    "./assets/images/products/jacket-2.jpg"
                ],
                category: "Unisex",
                condition: "Baik",
                store: "Cozy Club Collective",
                rating: 4.6,
                description: "Sweater hoodie unisex dengan bahan fleece lembut yang hangat namun tetap ringan dipakai.",
                specs: [
                    { label: "Kondisi", value: "Baik" },
                    { label: "Brand", value: "Cozy Club" },
                    { label: "Bahan", value: "Fleece" },
                    { label: "Warna", value: "Hijau Sage" },
                    { label: "Ukuran", value: "Free Size" },
                    { label: "Stok", value: "2 pcs" }
                ]
            }
        ];

        const getStoreName = (product) => {
            if (!product) return 'Toko ThriftMap';
            if (product.store) return product.store;
            if (product.seller) return product.seller;
            const brandSpec = (product.specs || []).find(spec => (spec.label || '').toLowerCase() === 'brand');
            return brandSpec?.value || 'Toko ThriftMap';
        };

        function renderProducts(filterInput) {
            productsGrid.innerHTML = '';
            let filtered = sampleProducts.slice();
            // Build keyword list from filterInput if provided
            if (filterInput && typeof filterInput === 'string') {
                const keywords = getFilterKeywords(filterInput);
                filtered = filtered.filter(p => matchProduct(p, keywords));
            } else if (Array.isArray(filterInput)) {
                filtered = filtered.filter(p => matchProduct(p, filterInput));
            }

                        filtered.forEach(product => {
                            const card = document.createElement('div');
                            card.className = 'showcase';
                            const condClass = (product.condition === 'Seperti Baru' || product.condition === 'Sangat Baik') ? 'condition-excellent' : (product.condition === 'Baik' ? 'condition-good' : 'condition-fair');
                            const storeName = getStoreName(product);
                            card.innerHTML = `
                                <div class="showcase-banner">
                                    <img src="${product.image}" alt="${product.name}" class="product-img default" width="300">
                                    <div class="showcase-actions">
                                        <button class="btn-action" type="button" data-wish-id="${product.id}" data-wish-name="${product.name}" aria-label="Wishlist ${product.name}">
                                            <ion-icon name="heart-outline"></ion-icon>
                                            <span>Tambah Wishlist</span>
                                        </button>
                                        <button class="btn-action" type="button" data-view-detail="${product.id}" aria-label="Lihat ${product.name}">
                                            <ion-icon name="eye-outline"></ion-icon>
                                            <span>Lihat Produk</span>
                                        </button>
                                        <button class="btn-action" type="button" data-add-cart data-id="${product.id}" data-name="${product.name}" data-price="${product.price}" data-image="${product.image}" aria-label="Tambah ke keranjang: ${product.name}">
                                            <ion-icon name="bag-add-outline"></ion-icon>
                                            <span>Masukkan Keranjang</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="showcase-content">
                                    <a href="#" class="showcase-category"><ion-icon name="pricetag-outline"></ion-icon>${product.category}</a>
                                    <a href="#"><h3 class="showcase-title">${product.name}</h3></a>
                                    <div class="showcase-meta">
                                        <span class="store-indicator"><i class="fas fa-store"></i>${storeName}</span>
                                        <span><i class="fas fa-recycle"></i>Preloved premium</span>
                                    </div>
                                    <span class="condition-badge ${condClass}" style="position:relative; z-index:3;">${product.condition}</span>
                                    <div class="price-box">
                                        <p class="price">Rp ${product.price.toLocaleString('id-ID')}</p>
                                        <del>Rp ${product.originalPrice.toLocaleString('id-ID')}</del>
                                    </div>
                                    <span class="showcase-footer-accent"></span>
                                </div>
                            `;
                            // Card click navigates to detail when clicking content area
                            card.addEventListener('click', (e) => {
                                if (e.target.closest('.btn-action') || e.target.closest('[data-add-cart]')) return;
                                location.href = `dashboard-product.html?id=${product.id}`;
                            });
                            // Prevent bubbling on action buttons
                            card.querySelectorAll('.btn-action,[data-add-cart]').forEach(btn => btn.addEventListener('click', (e)=> e.stopPropagation()));
                            // Initialize wishlist icon state
                            const wishBtn = card.querySelector('[data-wish-id]');
                            try {
                                const active = window.TMWishlist?.has?.(String(product.id));
                                const icon = wishBtn?.querySelector('ion-icon');
                                if (icon) icon.setAttribute('name', active ? 'heart' : 'heart-outline');
                            } catch {}
                            productsGrid.appendChild(card);
                        });
        }

        function matchProduct(product, keywords){
            if (!keywords || keywords.length === 0) return true;
            const hay = (product.name + ' ' + product.category + ' ' + product.condition + ' ' + getStoreName(product)).toLowerCase();
            return keywords.some(k => hay.includes(k.toLowerCase()));
        }

        function getFilterKeywords(cat){
            if (!cat) return [];
            const map = {
                'Pakaian Wanita': ['Wanita'],
                'Pakaian Pria': ['Pria'],
                'Anak & Bayi': ['Anak','Bayi'],
                'Barang & Peralatan': ['Elektronik','Peralatan','Buku','Rumah'],
                'Dress & Rok': ['Dress','Rok'],
                'Atasan': ['Atasan','Kemeja','Kaos','T-shirt'],
                'Celana': ['Celana'],
                'Jaket & Sweater': ['Jaket','Sweater','Hoodie'],
                'Sepatu': ['Sepatu'],
                'Aksesoris': ['Aksesoris','Tas','Topi','Gelang','Kalung'],
                'Kemeja': ['Kemeja'],
                'Jaket': ['Jaket'],
                'Pakaian Bayi': ['Bayi'],
                'Peralatan Bayi': ['Bayi','Peralatan'],
                'Pakaian Anak': ['Anak'],
                'Sepatu Anak': ['Sepatu','Anak'],
                'Mainan': ['Mainan'],
                'Buku': ['Buku'],
                'Peralatan Rumah Tangga': ['Peralatan','Rumah'],
                'Peralatan Dapur': ['Dapur','Peralatan'],
                'Alat Tulis Kantor': ['Alat Tulis','Kantor'],
                'Elektronik': ['Elektronik'],
                'Barang Lain': ['Barang']
            };
            return map[cat] || cat.split(/\s*&\s*|\s+/g).filter(Boolean);
        }

        function showProductDetail(product) {
            detailTitle.textContent = product.name;
            detailImage.src = product.image;
            const storeName = getStoreName(product);
            if (detailStoreText) {
                detailStoreText.textContent = storeName;
            }
            if (detailStore) {
                detailStore.setAttribute('title', `Toko: ${storeName}`);
            }
            if (detailStoreInfo) {
                detailStoreInfo.textContent = `Dijual oleh ${storeName}`;
            }
            detailPrice.textContent = `Rp ${product.price.toLocaleString('id-ID')}`;
            detailOriginalPrice.textContent = `Rp ${product.originalPrice.toLocaleString('id-ID')}`;
            const discountPercent = Math.round((1 - product.price / product.originalPrice) * 100);
            detailDiscount.textContent = `${discountPercent}% OFF`;
            detailDescription.textContent = product.description;
            detailSpecs.innerHTML = product.specs.map(spec => `<div><span class="font-medium">${spec.label}:</span> ${spec.value}</div>`).join('');
            detailThumbnails.innerHTML = product.gallery.map((image, index) => `
                <img src="${image}" alt="${product.name}" class="h-20 object-cover rounded-lg cursor-pointer ${index === 0 ? 'border-2 border-green-500' : ''}">
            `).join('');
            currentQuantity = 1;
            detailQuantity.textContent = currentQuantity;
            productDetail.classList.remove('hidden');
        }

        detailThumbnails.addEventListener('click', (event) => {
            if (event.target.tagName === 'IMG') {
                detailThumbnails.querySelectorAll('img').forEach(img => img.classList.remove('border-2', 'border-green-500'));
                event.target.classList.add('border-2', 'border-green-500');
                detailImage.src = event.target.src;
            }
        });

        closeDetail.addEventListener('click', () => {
            productDetail.classList.add('hidden');
        });

        qtyMinus.addEventListener('click', () => {
            if (currentQuantity > 1) {
                currentQuantity -= 1;
                detailQuantity.textContent = currentQuantity;
            }
        });

        qtyPlus.addEventListener('click', () => {
            currentQuantity += 1;
            detailQuantity.textContent = currentQuantity;
        });

    renderProducts();

        // =======================
        // Map View Implementation
        // =======================
        let productsMap;
        let userMarker;
        let radiusCircle;
        let markersLayer;
        const resultsList = document.getElementById('resultsList');
        const searchInput = document.getElementById('searchInput');
        const radiusRange = document.getElementById('radiusRange');
        const radiusLabel = document.getElementById('radiusLabel');
        const btnUseLocation = document.getElementById('btnUseLocation');
        const geoStatus = document.getElementById('geoStatus');

        let userLatLng = null;

        function kmToDegLat(km){ return km/110.574; }
        function kmToDegLng(km, lat){ return km/(111.320*Math.cos(lat*Math.PI/180)); }

        function haversineDistance(lat1, lon1, lat2, lon2) {
            function toRad(x){ return x * Math.PI / 180; }
            const R = 6371; // km
            const dLat = toRad(lat2-lat1);
            const dLon = toRad(lon2-lon1);
            const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function ensureProductCoords(center){
            // Assign random coords around center when missing
            sampleProducts.forEach((p, idx) => {
                if (!p.lat || !p.lng) {
                    const rKm = 1 + (idx % 5) * 0.8; // 1km..4km
                    const latOff = kmToDegLat((Math.random()-0.5)*2*rKm);
                    const lngOff = kmToDegLng((Math.random()-0.5)*2*rKm, center.lat);
                    p.lat = center.lat + latOff;
                    p.lng = center.lng + lngOff;
                }
            });
        }

        function renderMarkersAndList() {
            const query = (searchInput.value || '').toLowerCase();
            const radiusKm = parseInt(radiusRange.value, 10);
            radiusLabel.textContent = radiusKm + ' km';

            if (!markersLayer) { markersLayer = L.layerGroup().addTo(productsMap); }
            markersLayer.clearLayers();
            resultsList.innerHTML = '';

            // Draw radius circle
            if (radiusCircle) { productsMap.removeLayer(radiusCircle); }
            if (userLatLng) {
                radiusCircle = L.circle(userLatLng, { radius: radiusKm * 1000, color: '#10b981', fillColor: '#10b981', fillOpacity: 0.08 }).addTo(productsMap);
            }

            const filtered = sampleProducts
                .map(p => {
                    const distance = userLatLng ? haversineDistance(userLatLng.lat, userLatLng.lng, p.lat, p.lng) : null;
                    return { ...p, distance };
                })
                .filter(p => {
                    const textMatch = !query || (p.name + ' ' + p.category + ' ' + p.condition).toLowerCase().includes(query);
                    const radiusMatch = userLatLng ? (p.distance !== null && p.distance <= parseInt(radiusRange.value,10)) : true;
                    return textMatch && radiusMatch;
                })
                .sort((a,b) => (a.distance ?? 1e9) - (b.distance ?? 1e9));

            if (filtered.length === 0) {
                resultsList.innerHTML = '<div class="results-empty">Tidak ada produk dalam radius ini. Perbesar radius atau ubah pencarian.</div>';
            }

            filtered.forEach(product => {
                const condClass = (product.condition === 'Seperti Baru' || product.condition === 'Sangat Baik') ? 'condition-excellent' : (product.condition === 'Baik' ? 'condition-good' : 'condition-fair');
                const storeName = getStoreName(product);
                const marker = L.marker([product.lat, product.lng]).addTo(markersLayer);
                marker.bindPopup(`
                    <div class="map-popup-card">
                        <div class="map-popup-header">
                            <img src="${product.image}" alt="${product.name}" class="map-popup-image" />
                            <div>
                                <div class="map-popup-title">${product.name}</div>
                                <div class="map-popup-store"><i class='fas fa-store'></i>${storeName}</div>
                                ${product.distance !== null ? `<span class="map-popup-distance"><i class='fas fa-location-dot'></i>${product.distance.toFixed(2)} km dari Anda</span>` : ''}
                                <div class="map-popup-price">Rp ${product.price.toLocaleString('id-ID')}</div>
                            </div>
                        </div>
                        <div class="map-popup-body">
                            <div class="map-popup-meta">
                                <span class="map-popup-category"><i class='fas fa-tag'></i>${product.category}</span>
                                <span class="condition-badge ${condClass}">${product.condition}</span>
                            </div>
                            <a class="map-popup-cta" href="dashboard-product.html?id=${product.id}" data-view-detail="${product.id}">
                                <i class="fas fa-eye"></i>
                                Lihat Detail
                            </a>
                        </div>
                    </div>
                `);

                const item = document.createElement('div');
                item.className = 'results-item';
                item.innerHTML = `
                    <div class='card-top'>
                        <img src='${product.image}' class='thumbnail' alt='${product.name}'/>
                        <div class='flex-1'>
                            <div class='title-row'>
                                <p>${product.name}</p>
                                <span class='condition-badge ${condClass}'>${product.condition}</span>
                            </div>
                            <div class='stats'>
                                <span class='inline-flex items-center gap-1 text-emerald-600 font-semibold'><i class='fas fa-store'></i>${storeName}</span>
                                <span>• ${product.category}</span>
                            </div>
                            <div class='price-row'>
                                <div>
                                    <span class='price'>Rp ${product.price.toLocaleString('id-ID')}</span>
                                    <span class='text-xs text-gray-400 line-through ml-2'>Rp ${product.originalPrice.toLocaleString('id-ID')}</span>
                                </div>
                                ${product.distance!==null?`<span class='distance'><i class='fas fa-location-dot'></i> ${product.distance.toFixed(2)} km</span>`:''}
                            </div>
                        </div>
                    </div>`;
                item.addEventListener('click', () => {
                    productsMap.setView([product.lat, product.lng], Math.max(productsMap.getZoom(), 14));
                    marker.openPopup();
                    highlightSelected(item);
                });
                resultsList.appendChild(item);

                marker.on('click', () => {
                    highlightSelected(item);
                });
            });

            // No need to delegate click; anchor navigates to the new detail page

            function highlightSelected(el){
                resultsList.querySelectorAll('.results-item.is-active').forEach(n => n.classList.remove('is-active'));
                el.classList.add('is-active');
                el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function initMap(center){
            if (!productsMap) {
                productsMap = L.map('productsMap').setView([center.lat, center.lng], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(productsMap);
            } else {
                productsMap.setView([center.lat, center.lng], 12);
            }

            // user marker
            if (userMarker) { productsMap.removeLayer(userMarker); }
            userMarker = L.marker([center.lat, center.lng], { title: 'Lokasi Anda' }).addTo(productsMap);
            userMarker.bindPopup('Lokasi Anda');

            ensureProductCoords(center);
            renderMarkersAndList();
        }

        function locateUser() {
            if (!navigator.geolocation) {
                geoStatus.textContent = 'Geolocation tidak didukung browser ini.';
                geoStatus.classList.remove('text-gray-500');
                geoStatus.classList.add('text-red-500');
                // fallback to Malang
                userLatLng = { lat: -7.981894, lng: 112.626503 };
                initMap(userLatLng);
                return;
            }
            geoStatus.textContent = 'Mencari lokasi Anda…';
            geoStatus.classList.remove('text-red-500');
            geoStatus.classList.add('text-gray-500');
            navigator.geolocation.getCurrentPosition((pos) => {
                userLatLng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                geoStatus.textContent = 'Lokasi ditemukan';
                geoStatus.classList.remove('text-gray-500');
                geoStatus.classList.add('text-green-600');
                initMap(userLatLng);
            }, (err) => {
                geoStatus.textContent = 'Tidak bisa akses lokasi, gunakan fallback (Malang).';
                geoStatus.classList.remove('text-gray-500');
                geoStatus.classList.add('text-orange-600');
                userLatLng = { lat: -7.981894, lng: 112.626503 }; // Malang
                initMap(userLatLng);
            }, { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 });
        }

        // Events
        btnUseLocation.addEventListener('click', locateUser);
        radiusRange.addEventListener('input', () => renderMarkersAndList());
        searchInput.addEventListener('input', () => renderMarkersAndList());

        // Initialize map view on load
        document.addEventListener('DOMContentLoaded', () => {
            // Apply category filter from URL if present
            const params = new URLSearchParams(location.search);
            const categoryParam = params.get('category');
            if (categoryParam) {
                const keywords = getFilterKeywords(categoryParam);
                const heading = document.getElementById('productsHeading');
                if (heading) heading.textContent = `Kategori: ${categoryParam}`;
                // Set search for Map view and re-render markers
                if (typeof searchInput !== 'undefined' && searchInput) {
                    searchInput.value = keywords.join(' ');
                }
                // Switch to Grid view for a more list-friendly UX
                if (btnGridView) btnGridView.click();
                renderProducts(keywords);
                // Render filter pill
                renderFilterPills([categoryParam]);
            }
            locateUser();
        });

                // Action buttons delegation
                document.addEventListener('click', (e) => {
                    // View detail (eye button)
                    const viewBtn = e.target.closest('[data-view-detail]');
                    if (viewBtn) {
                        e.stopPropagation();
                        const id = viewBtn.getAttribute('data-view-detail');
                        if (id) location.href = `dashboard-product.html?id=${id}`;
                        return;
                    }
                });

                // Wishlist toggle delegation (grid/list hearts)
                document.addEventListener('click', (e) => {
                        const btn = e.target.closest('[data-wish-id]');
                        if (!btn) return;
                        e.stopPropagation();
                        const id = btn.getAttribute('data-wish-id');
                        const name = btn.getAttribute('data-wish-name') || 'Produk';
                        try {
                                const active = window.TMWishlist?.toggle?.(id, name);
                                const icon = btn.querySelector('ion-icon');
                                if (icon) icon.setAttribute('name', active ? 'heart' : 'heart-outline');
                        } catch {}
                });

        function renderFilterPills(filters){
            const wrap = document.getElementById('activeFilters');
            if (!wrap) return;
            if (!filters || filters.length === 0){ wrap.classList.add('hidden'); wrap.innerHTML = ''; return; }
            wrap.classList.remove('hidden');
                        wrap.innerHTML = filters.map(f => `
                            <span class="chip">
                                 <i class="fas fa-filter"></i>
                                 ${f}
                            </span>
                        `).join('') + `
                            <button id="btnClearFilters" type="button">Bersihkan</button>
                        `;
            const clearBtn = document.getElementById('btnClearFilters');
            if (clearBtn){
                clearBtn.addEventListener('click', () => {
                    const url = new URL(location.href);
                    url.searchParams.delete('category');
                    location.href = url.toString();
                });
            }
        }
    </script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Ionicons for index-style UI -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
</body>
</html>
