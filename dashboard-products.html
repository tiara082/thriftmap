<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produk - ThriftMap</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Leaflet CSS for Map View -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Index page global styles to match navbar and product grid -->
    <link rel="stylesheet" href="./assets/css/style-prefix.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com"> 
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: #f8fafc;
        }
        
        .sidebar {
            transition: all 0.3s ease;
        }
        
        .sidebar-collapsed {
            width: 70px;
        }
        
        .sidebar-collapsed .sidebar-text {
            display: none;
        }
        
        .main-content {
            transition: all 0.3s ease;
        }
        
        .main-content-expanded {
            margin-left: 70px;
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        /* Map view layout */
        .map-container {
            height: 72vh;
            min-height: 520px;
            border-radius: 12px;
            overflow: hidden;
        }
        .results-scroll {
            max-height: 72vh;
            overflow-y: auto;
        }

        * {
            outline: none !important;
        }
        
        button:focus,
        button:hover,
        button:active {
            outline: none !important;
        }

        /* Shared button micro-interaction */
        .btn { transition: all .25s ease; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(16,185,129,.25); }

    /* Leaflet popup unify look */
    .leaflet-popup-content-wrapper { border-radius: 12px; box-shadow: 0 10px 24px rgba(0,0,0,.12); }
    /* extra right space so text doesn't hide under the close (×) button */
    .leaflet-popup-content { margin: 10px 20px 12px 12px; }
    .leaflet-popup-close-button { top: 6px !important; right: 6px !important; }
    .leaflet-popup-tip { background: #fff; }
    /* make the popup action button full width without overflow */
    .leaflet-popup-content [data-view-detail] { display: block; width: 100%; box-sizing: border-box; border-radius: 12px; }

    /* Polished button styles used in popup and cards */
    .tm-btn { display: inline-flex; align-items: center; justify-content: center; gap: .5rem; padding: .625rem .875rem; border-radius: 12px; font-weight: 600; transition: all .2s ease; }
    .tm-btn-primary { background: #16a34a; color: #fff; }
    .tm-btn-primary:hover { background: #15803d; box-shadow: 0 6px 16px rgba(16,163,74,.25); }
    .tm-btn-link { color: #16a34a; }
    .tm-btn-full { width: 100%; }

    /* Condition badges for index-style cards */
    .condition-badge { padding: 4px 10px; border-radius: 9999px; font-size: 12px; font-weight: 600; }
    .condition-excellent { background: #dcfce7; color: #166534; }
    .condition-good { background: #e0f2fe; color: #075985; }
    .condition-fair { background: #fef3c7; color: #92400e; }

        /* Keep header above map and pinned to top */
        header { position: sticky; top: 0; z-index: 1300; background: #ffffff; }
    </style>
</head>
<body class="bg-gray-50">
        <!-- Index-style Header/Navbar -->
        <header>
            <div class="header-main">
                <div class="container">
                    <a href="dashboard-home.html" class="header-logo">
                        <img src="./assets/images/logo/logo.svg" alt="ThriftMap logo" width="120" height="36">
                    </a>
                    <div class="header-search-container">
                        <input id="globalSearch" type="search" name="search" class="search-field" placeholder="Cari produk preloved...">
                        <button class="search-btn" id="globalSearchBtn">
                            <ion-icon name="search-outline"></ion-icon>
                        </button>
                    </div>
                                        <div class="header-user-actions">
                                                <div class="tm-nav-dropdown">
                                                    <button class="action-btn" id="globalMenuBtn" aria-haspopup="true" aria-expanded="false" title="Menu">
                                                        <ion-icon name="menu-outline"></ion-icon>
                                                    </button>
                                                    <div class="tm-dropdown-panel hidden" id="globalMenu">
                                                        <a href="dashboard-home.html"><span class="label"><ion-icon name="home-outline"></ion-icon> Beranda</span></a>
                                                        <a href="dashboard-products.html"><span class="label"><ion-icon name="storefront-outline"></ion-icon> Produk</span></a>
                                                        <a href="dashboard-orders.html"><span class="label"><ion-icon name="bag-check-outline"></ion-icon> Pesanan</span><span class="badge orders-count" style="display:none">0</span></a>
                                                        <a href="dashboard-tracking.html"><span class="label"><ion-icon name="location-outline"></ion-icon> Lacak</span></a>
                                                        <a href="dashboard-payment.html"><span class="label"><ion-icon name="card-outline"></ion-icon> Pembayaran</span></a>
                                                        <a href="dashboard-settings.html"><span class="label"><ion-icon name="settings-outline"></ion-icon> Pengaturan</span></a>
                                                        <a href="#"><span class="label"><ion-icon name="heart-outline"></ion-icon> Wishlist</span><span class="badge wish-count" style="display:none">0</span></a>
                                                    </div>
                                                </div>
                                                <a href="dashboard-profile.html" class="action-btn" title="Akun">
                                                    <ion-icon name="person-outline"></ion-icon>
                                                </a>
                                                <a href="dashboard-cart.html" class="action-btn" title="Keranjang">
                                                    <ion-icon name="bag-handle-outline"></ion-icon>
                                                    <span class="count cart-count" style="display:none">0</span>
                                                </a>
                                        </div>
                </div>
            </div>
            
        </header>

    <!-- Page Content -->
    <main class="max-w-7xl mx-auto px-4 py-6 pb-24">
            <!-- View Toggle + Filter Summary -->
            <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
                <div class="flex items-center gap-2">
                    <button id="btnMapView" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50 flex items-center gap-2">
                        <i class="fas fa-map"></i><span>Map View</span>
                    </button>
                    <button id="btnGridView" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50 flex items-center gap-2">
                        <i class="fas fa-th"></i><span>Grid View</span>
                    </button>
                </div>
                <div class="flex items-center gap-2">
                  <div id="activeFilters" class="hidden flex items-center gap-2 flex-wrap"></div>
                  <div class="text-sm text-gray-500 hidden sm:block" id="geoStatus"></div>
                </div>
            </div>

            <!-- MAP VIEW -->
            <div id="mapSection" class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
                <!-- Left: Results like GMaps -->
                <aside class="bg-white rounded-xl shadow-sm p-0 lg:col-span-1">
                    <div class="p-4 border-b border-gray-100">
                        <div class="flex items-center gap-2">
                            <div class="relative flex-1">
                                <i class="fas fa-search text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                <input id="searchInput" type="text" placeholder="Cari produk, kategori, kondisi..." class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                            </div>
                            <button id="btnUseLocation" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50" title="Gunakan lokasiku">
                                <i class="fas fa-location-crosshairs"></i>
                            </button>
                        </div>
                        <div class="mt-3 grid grid-cols-3 gap-2 text-sm">
                            <div class="col-span-2 flex items-center gap-3">
                                <label for="radiusRange" class="text-gray-600 whitespace-nowrap">Radius</label>
                                <input id="radiusRange" type="range" min="1" max="20" value="5" class="w-full">
                            </div>
                            <div class="text-right"><span id="radiusLabel" class="font-medium text-gray-800">5 km</span></div>
                        </div>
                    </div>
                    <div id="resultsList" class="results-scroll divide-y divide-gray-100">
                        <!-- Results injected here -->
                    </div>
                </aside>

                <!-- Right: Map -->
                <section class="lg:col-span-2">
                    <div id="productsMap" class="map-container bg-gray-100"></div>
                </section>
            </div>

            <!-- GRID VIEW (index-style) -->
            <div id="gridSection" class="hidden">
              <section class="product-main">
                <div class="container">
                  <h2 id="productsHeading" class="title">Semua Produk</h2>
                  <div class="product-grid" id="productsGrid"></div>
                </div>
              </section>
            </div>

            <!-- Product Detail -->
            <section id="productDetail" class="mt-10 hidden">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 id="detailTitle" class="text-2xl font-bold text-gray-800">Detail Produk</h2>
                            <p class="text-gray-600">Informasi lengkap produk pilihan Anda</p>
                        </div>
                        <button id="closeDetail" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times mr-2"></i>Tutup
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <div class="mb-4 rounded-lg overflow-hidden">
                                <img id="detailImage" src="" alt="Produk" class="w-full h-96 object-cover">
                            </div>
                            <div class="grid grid-cols-4 gap-2" id="detailThumbnails">
                                <!-- Thumbnails injected here -->
                            </div>
                        </div>

                        <div>
                            <div class="flex items-center mb-4">
                                <div id="detailRating" class="flex text-yellow-400 mr-2"></div>
                                <span id="detailRatingValue" class="text-gray-600"></span>
                            </div>

                            <div class="mb-6">
                                <span id="detailPrice" class="text-3xl font-bold text-green-600">Rp 0</span>
                                <span id="detailOriginalPrice" class="text-lg text-gray-500 line-through ml-2"></span>
                                <span class="ml-2 px-2 py-1 bg-red-100 text-red-600 text-sm rounded-full" id="detailDiscount"></span>
                            </div>

                            <div class="mb-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-2">Deskripsi</h3>
                                <p id="detailDescription" class="text-gray-600 leading-relaxed">
                                    Pilih produk untuk melihat deskripsi lengkap.
                                </p>
                            </div>

                            <div class="mb-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-2">Spesifikasi</h3>
                                <div class="grid grid-cols-2 gap-2 text-sm text-gray-600" id="detailSpecs">
                                    <!-- Specs injected here -->
                                </div>
                            </div>

                            <div class="flex flex-wrap gap-4">
                                <div class="flex items-center border border-gray-300 rounded-lg">
                                    <button class="px-4 py-2 text-gray-600 hover:text-gray-800" id="qtyMinus">-</button>
                                    <span id="detailQuantity" class="px-4 py-2">1</span>
                                    <button class="px-4 py-2 text-gray-600 hover:text-gray-800" id="qtyPlus">+</button>
                                </div>
                                
                                <button class="flex-1 min-w-[200px] bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-medium">
                                    <i class="fas fa-shopping-cart mr-2"></i>Tambah ke Keranjang
                                </button>
                                
                                <button class="p-3 border border-gray-300 rounded-lg text-gray-600 hover:text-red-500">
                                    <i class="fas fa-heart"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

    <!-- Mobile Bottom Navigation -->
    <nav class="fixed bottom-0 inset-x-0 bg-white border-t border-gray-200 z-40 md:hidden">
        <div class="flex justify-around py-2 text-xs">
            <a data-nav href="dashboard-home.html" class="flex flex-col items-center text-gray-600 hover:text-green-600">
                <i class="fas fa-home text-base"></i>
                <span>Home</span>
            </a>
            <a data-nav href="dashboard-products.html" class="flex flex-col items-center text-gray-600 hover:text-green-600">
                <i class="fas fa-tags text-base"></i>
                <span>Produk</span>
            </a>
            <a data-nav href="dashboard-orders.html" class="flex flex-col items-center text-gray-600 hover:text-green-600">
                <i class="fas fa-shopping-bag text-base"></i>
                <span>Pesanan</span>
            </a>
            <a data-nav href="dashboard-tracking.html" class="flex flex-col items-center text-gray-600 hover:text-green-600">
                <i class="fas fa-map-marker-alt text-base"></i>
                <span>Lacak</span>
            </a>
            <a data-nav href="dashboard-profile.html" class="flex flex-col items-center text-gray-600 hover:text-green-600">
                <i class="fas fa-user text-base"></i>
                <span>Profil</span>
            </a>
        </div>
    </nav>

    <script src="./assets/js/cart.js"></script>
    <script src="./assets/js/notify.js"></script>
    <script src="./assets/js/wishlist.js"></script>
    <!-- Ionicons for index-style UI -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <script>
        // Wishlist badge persistence
        (function(){
            const KEY = 'tm_wishlist_count';
            function update(){
                const c = parseInt(localStorage.getItem(KEY)||'0',10)||0;
                document.querySelectorAll('.wish-count').forEach(b=>{
                    if (c>0){ b.textContent = String(c); b.style.display=''; }
                    else { b.textContent='0'; b.style.display='none'; }
                });
            }
            document.addEventListener('DOMContentLoaded', update);
            window.TMWishlist = Object.assign(window.TMWishlist||{}, {
                set(n){ localStorage.setItem(KEY, String(Math.max(0, Number(n)||0))); update(); },
                increment(){ const v=(parseInt(localStorage.getItem(KEY)||'0',10)||0)+1; localStorage.setItem(KEY, String(v)); update(); },
                decrement(){ const v=Math.max(0,(parseInt(localStorage.getItem(KEY)||'0',10)||0)-1); localStorage.setItem(KEY, String(v)); update(); }
            });
        })();
        // Global menu dropdown & bottom nav active
        (function(){
            const btn = document.getElementById('globalMenuBtn');
            const menu = document.getElementById('globalMenu');
            if (btn && menu) {
                btn.addEventListener('click', () => {
                    const expanded = btn.getAttribute('aria-expanded') === 'true';
                    btn.setAttribute('aria-expanded', String(!expanded));
                    menu.classList.toggle('hidden');
                });
                document.addEventListener('click', (e) => {
                    if (!menu.contains(e.target) && e.target !== btn && !btn.contains(e.target)) {
                        menu.classList.add('hidden');
                        btn.setAttribute('aria-expanded', 'false');
                    }
                });
                // Initial sync of badges
                try {
                  const orders = parseInt(localStorage.getItem('tm_orders_count')||'0',10);
                  const wishList = JSON.parse(localStorage.getItem('tm_wishlist')||'[]');
                  const wCount = Array.isArray(wishList)? wishList.length : 0;
                  const oEl = menu.querySelector('.orders-count');
                  const wEl = menu.querySelector('.wish-count');
                  if (oEl) { if (orders>0){ oEl.style.display='inline-block'; oEl.textContent=String(orders);} else {oEl.style.display='none';} }
                  if (wEl) { if (wCount>0){ wEl.style.display='inline-block'; wEl.textContent=String(wCount);} else {wEl.style.display='none';} }
                } catch {}
            }
            document.querySelectorAll('a[data-nav]').forEach(a => {
                const href = a.getAttribute('href') || '';
                if (location.pathname.endsWith(href)) a.classList.add('text-green-600');
            });
        })();

        // View toggle
        const mapSection = document.getElementById('mapSection');
        const gridSection = document.getElementById('gridSection');
        const btnMapView = document.getElementById('btnMapView');
        const btnGridView = document.getElementById('btnGridView');
        function setToggleActive(active) {
            const activeClasses = ['border-green-600','text-green-700','bg-green-50'];
            const baseClasses = ['border','border-gray-300','text-gray-700','bg-white'];
            [btnMapView, btnGridView].forEach(btn => {
                btn.classList.remove(...activeClasses);
                if (!btn.classList.contains('border')) btn.classList.add(...baseClasses);
            });
            active.classList.add(...activeClasses);
        }
        btnMapView.addEventListener('click', () => {
            mapSection.classList.remove('hidden');
            gridSection.classList.add('hidden');
            setToggleActive(btnMapView);
            setTimeout(() => productsMap && productsMap.invalidateSize(), 200);
        });
        btnGridView.addEventListener('click', () => {
            gridSection.classList.remove('hidden');
            mapSection.classList.add('hidden');
            setToggleActive(btnGridView);
        });
        // Set initial active state
        setToggleActive(btnMapView);

                // Global header search -> filter grid
                (function(){
                    const input = document.getElementById('globalSearch');
                    const btn = document.getElementById('globalSearchBtn');
                    function doSearch(){
                        if (!input) return;
                        const q = input.value || '';
                        // Switch to grid view for search results
                        if (btnGridView) btnGridView.click();
                        renderProducts(q);
                        const h = document.getElementById('productsHeading');
                        if (h) h.textContent = q ? `Hasil: ${q}` : 'Semua Produk';
                        renderFilterPills(q ? [q] : []);
                    }
                    if (btn) btn.addEventListener('click', (e)=>{ e.preventDefault(); doSearch(); });
                    if (input) input.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { e.preventDefault(); doSearch(); } });
                })();

                        // Make header dropdown categories filter the grid
                        (function(){
                            const panel = document.querySelector('.dropdown-panel');
                            if (!panel) return;
                            panel.addEventListener('click', (e)=>{
                                const a = e.target.closest('a');
                                if (!a) return;
                                const txt = (a.textContent || '').trim();
                                if (!txt) return;
                                // prevent following image/banner links
                                e.preventDefault();
                                if (btnGridView) btnGridView.click();
                                const keywords = getFilterKeywords(txt);
                                renderProducts(keywords);
                                const h = document.getElementById('productsHeading');
                                if (h) h.textContent = `Kategori: ${txt}`;
                                renderFilterPills([txt]);
                            });
                        })();

        const productsGrid = document.getElementById('productsGrid');
        const productDetail = document.getElementById('productDetail');
        const detailTitle = document.getElementById('detailTitle');
        const detailImage = document.getElementById('detailImage');
        const detailThumbnails = document.getElementById('detailThumbnails');
        const detailRating = document.getElementById('detailRating');
        const detailRatingValue = document.getElementById('detailRatingValue');
        const detailPrice = document.getElementById('detailPrice');
        const detailOriginalPrice = document.getElementById('detailOriginalPrice');
        const detailDiscount = document.getElementById('detailDiscount');
        const detailDescription = document.getElementById('detailDescription');
        const detailSpecs = document.getElementById('detailSpecs');
        const detailQuantity = document.getElementById('detailQuantity');
        const closeDetail = document.getElementById('closeDetail');
        const qtyMinus = document.getElementById('qtyMinus');
        const qtyPlus = document.getElementById('qtyPlus');

    let currentQuantity = 1;

        const sampleProducts = [
            {
                id: 1,
                name: "Jaket Kulit Pria",
                price: 72000,
                originalPrice: 85000,
                image: "./assets/images/products/jacket-3.jpg",
                gallery: [
                    "./assets/images/products/jacket-3.jpg",
                    "./assets/images/products/jacket-4.jpg",
                    "./assets/images/products/jacket-5.jpg",
                    "./assets/images/products/jacket-6.jpg"
                ],
                category: "Pria",
                condition: "Sangat Baik",
                rating: 4.5,
                description: "Jaket kulit pria berkualitas tinggi dengan desain klasik yang timeless. Cocok untuk musim dingin dengan bahan yang hangat dan nyaman. Kondisi masih sangat baik dengan sedikit tanda pakai.",
                specs: [
                    { label: "Kondisi", value: "Sangat Baik" },
                    { label: "Brand", value: "Vintage Co." },
                    { label: "Bahan", value: "Kulit Asli" },
                    { label: "Warna", value: "Coklat" },
                    { label: "Ukuran", value: "L" },
                    { label: "Stok", value: "1 pcs" }
                ]
            },
            {
                id: 2,
                name: "Kemeja Katun Premium",
                price: 45000,
                originalPrice: 56000,
                image: "./assets/images/products/shirt-1.jpg",
                gallery: [
                    "./assets/images/products/shirt-1.jpg",
                    "./assets/images/products/clothes-4.jpg",
                    "./assets/images/products/clothes-5.jpg"
                ],
                category: "Pria",
                condition: "Baik",
                rating: 4.2,
                description: "Kemeja katun premium dengan tekstur halus dan nyaman dipakai sepanjang hari. Cutting slim fit membuat penampilan lebih rapi.",
                specs: [
                    { label: "Kondisi", value: "Baik" },
                    { label: "Brand", value: "Urban Threads" },
                    { label: "Bahan", value: "Katun" },
                    { label: "Warna", value: "Putih" },
                    { label: "Ukuran", value: "M" },
                    { label: "Stok", value: "2 pcs" }
                ]
            },
            {
                id: 3,
                name: "Dress Floral Midi",
                price: 55000,
                originalPrice: 70000,
                image: "./assets/images/products/clothes-3.jpg",
                gallery: [
                    "./assets/images/products/clothes-3.jpg",
                    "./assets/images/products/clothes-1.jpg",
                    "./assets/images/products/clothes-2.jpg"
                ],
                category: "Wanita",
                condition: "Seperti Baru",
                rating: 4.8,
                description: "Dress floral midi yang feminin dengan bahan adem dan jatuh. Cocok untuk acara semi formal maupun casual brunch.",
                specs: [
                    { label: "Kondisi", value: "Seperti Baru" },
                    { label: "Brand", value: "Bloom & Co." },
                    { label: "Bahan", value: "Rayon" },
                    { label: "Warna", value: "Navy Floral" },
                    { label: "Ukuran", value: "M" },
                    { label: "Stok", value: "1 pcs" }
                ]
            },
            {
                id: 4,
                name: "Tas Mini Wanita",
                price: 42000,
                originalPrice: 55000,
                image: "./assets/images/products/party-wear-1.jpg",
                gallery: [
                    "./assets/images/products/party-wear-1.jpg",
                    "./assets/images/products/party-wear-2.jpg"
                ],
                category: "Aksesoris",
                condition: "Baik",
                rating: 4.3,
                description: "Tas mini wanita dengan desain chic yang mudah dipadupadankan. Tersedia tali panjang dan pendek sekaligus.",
                specs: [
                    { label: "Kondisi", value: "Baik" },
                    { label: "Brand", value: "Minimalist" },
                    { label: "Bahan", value: "Kulit Sintetis" },
                    { label: "Warna", value: "Hitam" },
                    { label: "Ukuran", value: "20 x 15 cm" },
                    { label: "Stok", value: "3 pcs" }
                ]
            },
            {
                id: 5,
                name: "Sepatu Sneakers",
                price: 88000,
                originalPrice: 120000,
                image: "./assets/images/products/shoes-1.jpg",
                gallery: [
                    "./assets/images/products/shoes-1.jpg",
                    "./assets/images/products/shoes-2.jpg",
                    "./assets/images/products/shoes-3.jpg"
                ],
                category: "Sepatu",
                condition: "Cukup",
                rating: 4.0,
                description: "Sneakers kasual yang nyaman untuk aktivitas sehari-hari. Sol masih tebal dan upper dalam kondisi baik.",
                specs: [
                    { label: "Kondisi", value: "Cukup" },
                    { label: "Brand", value: "Street Step" },
                    { label: "Bahan", value: "Canvas" },
                    { label: "Warna", value: "Putih" },
                    { label: "Ukuran", value: "42" },
                    { label: "Stok", value: "1 pasang" }
                ]
            },
            {
                id: 6,
                name: "Sweater Hoodie",
                price: 48000,
                originalPrice: 65000,
                image: "./assets/images/products/jacket-1.jpg",
                gallery: [
                    "./assets/images/products/jacket-1.jpg",
                    "./assets/images/products/jacket-2.jpg"
                ],
                category: "Unisex",
                condition: "Baik",
                rating: 4.6,
                description: "Sweater hoodie unisex dengan bahan fleece lembut yang hangat namun tetap ringan dipakai.",
                specs: [
                    { label: "Kondisi", value: "Baik" },
                    { label: "Brand", value: "Cozy Club" },
                    { label: "Bahan", value: "Fleece" },
                    { label: "Warna", value: "Hijau Sage" },
                    { label: "Ukuran", value: "Free Size" },
                    { label: "Stok", value: "2 pcs" }
                ]
            }
        ];

        function renderProducts(filterInput) {
            productsGrid.innerHTML = '';
            let filtered = sampleProducts.slice();
            // Build keyword list from filterInput if provided
            if (filterInput && typeof filterInput === 'string') {
                const keywords = getFilterKeywords(filterInput);
                filtered = filtered.filter(p => matchProduct(p, keywords));
            } else if (Array.isArray(filterInput)) {
                filtered = filtered.filter(p => matchProduct(p, filterInput));
            }

                        filtered.forEach(product => {
                            const card = document.createElement('div');
                            card.className = 'showcase';
                            const condClass = (product.condition === 'Seperti Baru' || product.condition === 'Sangat Baik') ? 'condition-excellent' : (product.condition === 'Baik' ? 'condition-good' : 'condition-fair');
                            card.innerHTML = `
                                <div class="showcase-banner">
                                    <img src="${product.image}" alt="${product.name}" class="product-img default" width="300">
                                    <div class="showcase-actions">
                                        <button class="btn-action" type="button" data-wish-id="${product.id}" data-wish-name="${product.name}" aria-label="Wishlist ${product.name}">
                                            <ion-icon name="heart-outline"></ion-icon>
                                        </button>
                                        <button class="btn-action" type="button" data-view-detail="${product.id}" aria-label="Lihat ${product.name}">
                                            <ion-icon name="eye-outline"></ion-icon>
                                        </button>
                                        <button class="btn-action" type="button" data-add-cart data-id="${product.id}" data-name="${product.name}" data-price="${product.price}" data-image="${product.image}" aria-label="Tambah ke keranjang: ${product.name}">
                                            <ion-icon name="bag-add-outline"></ion-icon>
                                        </button>
                                    </div>
                                </div>
                                <div class="showcase-content">
                                    <a href="#" class="showcase-category">${product.category}</a>
                                    <a href="#"><h3 class="showcase-title">${product.name}</h3></a>
                                    <span class="condition-badge ${condClass}" style="margin:8px 0; display:inline-block;">${product.condition}</span>
                                    <div class="price-box">
                                        <p class="price">Rp ${product.price.toLocaleString('id-ID')}</p>
                                        <del>Rp ${product.originalPrice.toLocaleString('id-ID')}</del>
                                    </div>
                                </div>
                            `;
                            // Card click navigates to detail when clicking content area
                            card.addEventListener('click', (e) => {
                                if (e.target.closest('.btn-action') || e.target.closest('[data-add-cart]')) return;
                                location.href = `dashboard-product.html?id=${product.id}`;
                            });
                            // Prevent bubbling on action buttons
                            card.querySelectorAll('.btn-action,[data-add-cart]').forEach(btn => btn.addEventListener('click', (e)=> e.stopPropagation()));
                            // Initialize wishlist icon state
                            const wishBtn = card.querySelector('[data-wish-id]');
                            try {
                                const active = window.TMWishlist?.has?.(String(product.id));
                                const icon = wishBtn?.querySelector('ion-icon');
                                if (icon) icon.setAttribute('name', active ? 'heart' : 'heart-outline');
                            } catch {}
                            productsGrid.appendChild(card);
                        });
        }

        function matchProduct(product, keywords){
            if (!keywords || keywords.length === 0) return true;
            const hay = (product.name + ' ' + product.category + ' ' + product.condition).toLowerCase();
            return keywords.some(k => hay.includes(k.toLowerCase()));
        }

        function getFilterKeywords(cat){
            if (!cat) return [];
            const map = {
                'Pakaian Wanita': ['Wanita'],
                'Pakaian Pria': ['Pria'],
                'Anak & Bayi': ['Anak','Bayi'],
                'Barang & Peralatan': ['Elektronik','Peralatan','Buku','Rumah'],
                'Dress & Rok': ['Dress','Rok'],
                'Atasan': ['Atasan','Kemeja','Kaos','T-shirt'],
                'Celana': ['Celana'],
                'Jaket & Sweater': ['Jaket','Sweater','Hoodie'],
                'Sepatu': ['Sepatu'],
                'Aksesoris': ['Aksesoris','Tas','Topi','Gelang','Kalung'],
                'Kemeja': ['Kemeja'],
                'Jaket': ['Jaket'],
                'Pakaian Bayi': ['Bayi'],
                'Peralatan Bayi': ['Bayi','Peralatan'],
                'Pakaian Anak': ['Anak'],
                'Sepatu Anak': ['Sepatu','Anak'],
                'Mainan': ['Mainan'],
                'Buku': ['Buku'],
                'Peralatan Rumah Tangga': ['Peralatan','Rumah'],
                'Peralatan Dapur': ['Dapur','Peralatan'],
                'Alat Tulis Kantor': ['Alat Tulis','Kantor'],
                'Elektronik': ['Elektronik'],
                'Barang Lain': ['Barang']
            };
            return map[cat] || cat.split(/\s*&\s*|\s+/g).filter(Boolean);
        }

        function showProductDetail(product) {
            detailTitle.textContent = product.name;
            detailImage.src = product.image;
            detailRating.innerHTML = '<i class="fas fa-star"></i>'.repeat(Math.floor(product.rating)) + (product.rating % 1 !== 0 ? '<i class="fas fa-star-half-alt"></i>' : '');
            detailRatingValue.textContent = `${product.rating.toFixed(1)} (ulasan pelanggan)`;
            detailPrice.textContent = `Rp ${product.price.toLocaleString('id-ID')}`;
            detailOriginalPrice.textContent = `Rp ${product.originalPrice.toLocaleString('id-ID')}`;
            const discountPercent = Math.round((1 - product.price / product.originalPrice) * 100);
            detailDiscount.textContent = `${discountPercent}% OFF`;
            detailDescription.textContent = product.description;
            detailSpecs.innerHTML = product.specs.map(spec => `<div><span class="font-medium">${spec.label}:</span> ${spec.value}</div>`).join('');
            detailThumbnails.innerHTML = product.gallery.map((image, index) => `
                <img src="${image}" alt="${product.name}" class="h-20 object-cover rounded-lg cursor-pointer ${index === 0 ? 'border-2 border-green-500' : ''}">
            `).join('');
            currentQuantity = 1;
            detailQuantity.textContent = currentQuantity;
            productDetail.classList.remove('hidden');
        }

        detailThumbnails.addEventListener('click', (event) => {
            if (event.target.tagName === 'IMG') {
                detailThumbnails.querySelectorAll('img').forEach(img => img.classList.remove('border-2', 'border-green-500'));
                event.target.classList.add('border-2', 'border-green-500');
                detailImage.src = event.target.src;
            }
        });

        closeDetail.addEventListener('click', () => {
            productDetail.classList.add('hidden');
        });

        qtyMinus.addEventListener('click', () => {
            if (currentQuantity > 1) {
                currentQuantity -= 1;
                detailQuantity.textContent = currentQuantity;
            }
        });

        qtyPlus.addEventListener('click', () => {
            currentQuantity += 1;
            detailQuantity.textContent = currentQuantity;
        });

    renderProducts();

        // =======================
        // Map View Implementation
        // =======================
        let productsMap;
        let userMarker;
        let radiusCircle;
        let markersLayer;
        const resultsList = document.getElementById('resultsList');
        const searchInput = document.getElementById('searchInput');
        const radiusRange = document.getElementById('radiusRange');
        const radiusLabel = document.getElementById('radiusLabel');
        const btnUseLocation = document.getElementById('btnUseLocation');
        const geoStatus = document.getElementById('geoStatus');

        let userLatLng = null;

        function kmToDegLat(km){ return km/110.574; }
        function kmToDegLng(km, lat){ return km/(111.320*Math.cos(lat*Math.PI/180)); }

        function haversineDistance(lat1, lon1, lat2, lon2) {
            function toRad(x){ return x * Math.PI / 180; }
            const R = 6371; // km
            const dLat = toRad(lat2-lat1);
            const dLon = toRad(lon2-lon1);
            const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function ensureProductCoords(center){
            // Assign random coords around center when missing
            sampleProducts.forEach((p, idx) => {
                if (!p.lat || !p.lng) {
                    const rKm = 1 + (idx % 5) * 0.8; // 1km..4km
                    const latOff = kmToDegLat((Math.random()-0.5)*2*rKm);
                    const lngOff = kmToDegLng((Math.random()-0.5)*2*rKm, center.lat);
                    p.lat = center.lat + latOff;
                    p.lng = center.lng + lngOff;
                }
            });
        }

        function renderMarkersAndList() {
            const query = (searchInput.value || '').toLowerCase();
            const radiusKm = parseInt(radiusRange.value, 10);
            radiusLabel.textContent = radiusKm + ' km';

            if (!markersLayer) { markersLayer = L.layerGroup().addTo(productsMap); }
            markersLayer.clearLayers();
            resultsList.innerHTML = '';

            // Draw radius circle
            if (radiusCircle) { productsMap.removeLayer(radiusCircle); }
            if (userLatLng) {
                radiusCircle = L.circle(userLatLng, { radius: radiusKm * 1000, color: '#10b981', fillColor: '#10b981', fillOpacity: 0.08 }).addTo(productsMap);
            }

            const filtered = sampleProducts
                .map(p => {
                    const distance = userLatLng ? haversineDistance(userLatLng.lat, userLatLng.lng, p.lat, p.lng) : null;
                    return { ...p, distance };
                })
                .filter(p => {
                    const textMatch = !query || (p.name + ' ' + p.category + ' ' + p.condition).toLowerCase().includes(query);
                    const radiusMatch = userLatLng ? (p.distance !== null && p.distance <= parseInt(radiusRange.value,10)) : true;
                    return textMatch && radiusMatch;
                })
                .sort((a,b) => (a.distance ?? 1e9) - (b.distance ?? 1e9));

            if (filtered.length === 0) {
                resultsList.innerHTML = '<div class="p-4 text-sm text-gray-500">Tidak ada produk dalam radius ini. Perbesar radius atau ubah pencarian.</div>';
            }

            const listItems = [];
            const markerById = {};
            filtered.forEach(product => {
                const marker = L.marker([product.lat, product.lng]).addTo(markersLayer);
                marker.bindPopup(`
                    <div class='min-w-[240px]'>
                        <div class='flex items-center gap-3'>
                            <img src='${product.image}' class='w-12 h-12 object-cover rounded-lg flex-shrink-0' alt='${product.name}'/>
                            <div class='min-w-0'>
                                <div class='font-semibold text-gray-800 truncate'>${product.name}</div>
                                <div class='text-green-600 font-bold leading-tight'>Rp ${product.price.toLocaleString('id-ID')}</div>
                                ${product.distance!==null?`<div class='text-xs text-gray-500 mt-0.5'>${product.distance.toFixed(2)} km dari Anda</div>`:''}
                            </div>
                        </div>
                        <a class='tm-btn tm-btn-primary tm-btn-full mt-3' href='dashboard-product.html?id=${product.id}' data-view-detail='${product.id}'>
                          <i class="fas fa-eye"></i>
                          Lihat Detail
                        </a>
                    </div>
                `);

                markerById[product.id] = marker;

                const item = document.createElement('div');
                item.className = 'p-4 hover:bg-gray-50 cursor-pointer';
                item.innerHTML = `
                    <div class='flex gap-3'>
                        <img src='${product.image}' class='w-16 h-16 object-cover rounded-lg' alt='${product.name}'/>
                        <div class='flex-1'>
                            <div class='flex items-center justify-between'>
                                <p class='font-semibold text-gray-800'>${product.name}</p>
                                <span class='px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full'>${product.condition}</span>
                            </div>
                            <div class='text-sm text-gray-500'>${product.category} • ${product.rating.toFixed(1)}★</div>
                            <div class='flex items-center justify-between mt-1'>
                                <div>
                                    <span class='text-green-600 font-bold'>Rp ${product.price.toLocaleString('id-ID')}</span>
                                    <span class='text-gray-400 text-xs line-through ml-2'>Rp ${product.originalPrice.toLocaleString('id-ID')}</span>
                                </div>
                                ${product.distance!==null?`<span class='text-xs text-gray-600'>${product.distance.toFixed(2)} km</span>`:''}
                            </div>
                        </div>
                    </div>`;
                item.addEventListener('click', () => {
                    productsMap.setView([product.lat, product.lng], Math.max(productsMap.getZoom(), 14));
                    marker.openPopup();
                    highlightSelected(item);
                });
                resultsList.appendChild(item);
                listItems.push(item);

                marker.on('click', () => {
                    const idx = listItems.findIndex(li => li.contains(item.querySelector('img')));
                    if (idx > -1) highlightSelected(listItems[idx]);
                });
            });

            // No need to delegate click; anchor navigates to the new detail page

            function highlightSelected(el){
                resultsList.querySelectorAll('.bg-green-50').forEach(n => n.classList.remove('bg-green-50'));
                el.classList.add('bg-green-50');
            }
        }

        function initMap(center){
            if (!productsMap) {
                productsMap = L.map('productsMap').setView([center.lat, center.lng], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(productsMap);
            } else {
                productsMap.setView([center.lat, center.lng], 12);
            }

            // user marker
            if (userMarker) { productsMap.removeLayer(userMarker); }
            userMarker = L.marker([center.lat, center.lng], { title: 'Lokasi Anda' }).addTo(productsMap);
            userMarker.bindPopup('Lokasi Anda');

            ensureProductCoords(center);
            renderMarkersAndList();
        }

        function locateUser() {
            if (!navigator.geolocation) {
                geoStatus.textContent = 'Geolocation tidak didukung browser ini.';
                geoStatus.classList.remove('text-gray-500');
                geoStatus.classList.add('text-red-500');
                // fallback to Malang
                userLatLng = { lat: -7.981894, lng: 112.626503 };
                initMap(userLatLng);
                return;
            }
            geoStatus.textContent = 'Mencari lokasi Anda…';
            geoStatus.classList.remove('text-red-500');
            geoStatus.classList.add('text-gray-500');
            navigator.geolocation.getCurrentPosition((pos) => {
                userLatLng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                geoStatus.textContent = 'Lokasi ditemukan';
                geoStatus.classList.remove('text-gray-500');
                geoStatus.classList.add('text-green-600');
                initMap(userLatLng);
            }, (err) => {
                geoStatus.textContent = 'Tidak bisa akses lokasi, gunakan fallback (Malang).';
                geoStatus.classList.remove('text-gray-500');
                geoStatus.classList.add('text-orange-600');
                userLatLng = { lat: -7.981894, lng: 112.626503 }; // Malang
                initMap(userLatLng);
            }, { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 });
        }

        // Events
        btnUseLocation.addEventListener('click', locateUser);
        radiusRange.addEventListener('input', () => renderMarkersAndList());
        searchInput.addEventListener('input', () => renderMarkersAndList());

        // Initialize map view on load
        document.addEventListener('DOMContentLoaded', () => {
            // Apply category filter from URL if present
            const params = new URLSearchParams(location.search);
            const categoryParam = params.get('category');
            if (categoryParam) {
                const keywords = getFilterKeywords(categoryParam);
                const heading = document.getElementById('productsHeading');
                if (heading) heading.textContent = `Kategori: ${categoryParam}`;
                // Set search for Map view and re-render markers
                if (typeof searchInput !== 'undefined' && searchInput) {
                    searchInput.value = keywords.join(' ');
                }
                // Switch to Grid view for a more list-friendly UX
                if (btnGridView) btnGridView.click();
                renderProducts(keywords);
                // Render filter pill
                renderFilterPills([categoryParam]);
            }
            locateUser();
        });

                // Action buttons delegation
                document.addEventListener('click', (e) => {
                    // View detail (eye button)
                    const viewBtn = e.target.closest('[data-view-detail]');
                    if (viewBtn) {
                        e.stopPropagation();
                        const id = viewBtn.getAttribute('data-view-detail');
                        if (id) location.href = `dashboard-product.html?id=${id}`;
                        return;
                    }
                });

                // Wishlist toggle delegation (grid/list hearts)
                document.addEventListener('click', (e) => {
                        const btn = e.target.closest('[data-wish-id]');
                        if (!btn) return;
                        e.stopPropagation();
                        const id = btn.getAttribute('data-wish-id');
                        const name = btn.getAttribute('data-wish-name') || 'Produk';
                        try {
                                const active = window.TMWishlist?.toggle?.(id, name);
                                const icon = btn.querySelector('ion-icon');
                                if (icon) icon.setAttribute('name', active ? 'heart' : 'heart-outline');
                        } catch {}
                });

        function renderFilterPills(filters){
            const wrap = document.getElementById('activeFilters');
            if (!wrap) return;
            if (!filters || filters.length === 0){ wrap.classList.add('hidden'); wrap.innerHTML = ''; return; }
            wrap.classList.remove('hidden');
            wrap.innerHTML = filters.map(f => `
              <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm border border-green-300 bg-green-50 text-green-700">
                 <i class="fas fa-filter"></i>${f}
              </span>
            `).join('') + `
              <button id="btnClearFilters" class="px-3 py-1 text-sm text-gray-600 hover:text-gray-800">Bersihkan</button>
            `;
            const clearBtn = document.getElementById('btnClearFilters');
            if (clearBtn){
                clearBtn.addEventListener('click', () => {
                    const url = new URL(location.href);
                    url.searchParams.delete('category');
                    location.href = url.toString();
                });
            }
        }
    </script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Ionicons for index-style UI -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
</body>
</html>
