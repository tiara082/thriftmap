<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil - ThriftMap</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Index page global styles to match navbar -->
    <link rel="stylesheet" href="./assets/css/style-prefix.css">

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com"> 
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: #f8fafc;
        }
        
        .sidebar {
            transition: all 0.3s ease;
        }
        
        .sidebar-collapsed {
            width: 70px;
        }
        
        .sidebar-collapsed .sidebar-text {
            display: none;
        }
        
        .main-content {
            transition: all 0.3s ease;
        }
        
        .main-content-expanded {
            margin-left: 70px;
        }

        * {
            outline: none !important;
        }
        
        button:focus,
        button:hover,
        button:active {
            outline: none !important;
        }

        html.modal-lock,
        body.modal-lock {
            overflow: hidden;
        }

        .address-modal-scroll {
            max-height: 90vh;
            overflow-y: auto;
            overscroll-behavior: contain;
            scrollbar-width: thin;
            scrollbar-color: #16a34a #f0fdf4;
        }

        .address-modal-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .address-modal-scroll::-webkit-scrollbar-track {
            background: #f0fdf4;
            border-radius: 9999px;
            box-shadow: inset 0 0 0 1px rgba(22, 163, 74, 0.08);
        }

        .address-modal-scroll::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #34d399, #16a34a);
            border-radius: 9999px;
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.6);
        }

        .address-modal-scroll::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #22c55e, #15803d);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Sidebar -->
    <div class="sidebar fixed inset-y-0 left-0 z-50 w-64 bg-green-800 text-white sidebar-collapsed hidden">
        <div class="flex items-center justify-between p-4 border-b border-green-700">
            <div class="flex items-center space-x-3">
                <img src="./assets/images/logo/logo.svg" alt="ThriftMap" class="h-8 w-8">
            </div>
            <button id="toggleSidebar" class="text-white hover:text-green-200">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        
        <nav class="mt-6">
            <div class="px-4 space-y-2">
                <a href="dashboard-home.html" class="nav-item block py-2 px-4 rounded-lg hover:bg-green-700 text-green-100">
                    <i class="fas fa-home mr-3"></i>
                    <span class="sidebar-text">Dashboard</span>
                </a>
                
                <a href="dashboard-profile.html" class="nav-item block py-2 px-4 rounded-lg bg-green-700 text-white">
                    <i class="fas fa-user mr-3"></i>
                    <span class="sidebar-text">Profil</span>
                </a>
                
                <a href="dashboard-products.html" class="nav-item block py-2 px-4 rounded-lg hover:bg-green-700 text-green-100">
                    <i class="fas fa-tshirt mr-3"></i>
                    <span class="sidebar-text">Produk</span>
                </a>
                
                <a href="dashboard-orders.html" class="nav-item block py-2 px-4 rounded-lg hover:bg-green-700 text-green-100">
                    <i class="fas fa-shopping-bag mr-3"></i>
                    <span class="sidebar-text">Pesanan</span>
                </a>
                
                <a href="dashboard-tracking.html" class="nav-item block py-2 px-4 rounded-lg hover:bg-green-700 text-green-100">
                    <i class="fas fa-map-marker-alt mr-3"></i>
                    <span class="sidebar-text">Lacak Pesanan</span>
                </a>
                
                <a href="dashboard-payment.html" class="nav-item block py-2 px-4 rounded-lg hover:bg-green-700 text-green-100">
                    <i class="fas fa-credit-card mr-3"></i>
                    <span class="sidebar-text">Pembayaran</span>
                </a>
                
                <a href="dashboard-settings.html" class="nav-item block py-2 px-4 rounded-lg hover:bg-green-700 text-green-100">
                    <i class="fas fa-cog mr-3"></i>
                    <span class="sidebar-text">Pengaturan</span>
                </a>
            </div>
        </nav>
        
        <div class="absolute bottom-0 w-full p-4 border-t border-green-700">
            <a href="index.html" class="flex items-center space-x-3 text-green-100 hover:text-white">
                <i class="fas fa-sign-out-alt"></i>
                <span class="sidebar-text">Keluar</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content ml-0">
                <!-- Index-style Header/Navbar -->
                <header style="position:sticky;top:0;z-index:1300;background:#fff">
                    <div class="header-main">
                        <div class="container">
                            <a href="dashboard-home.html" class="header-logo">
                                <img src="./assets/images/logo/logo.svg" alt="ThriftMap logo" width="120" height="36">
                            </a>
                            <div class="header-search-container">
                                <input id="globalSearch" type="search" name="search" class="search-field" placeholder="Cari pesanan, alamat, pengaturan...">
                                <button class="search-btn" id="globalSearchBtn">
                                    <ion-icon name="search-outline"></ion-icon>
                                </button>
                            </div>
                                                        <div class="header-user-actions" style="margin-left:auto">
                                <a href="dashboard-profile.html" class="action-btn" title="Akun">
                                    <ion-icon name="person-outline"></ion-icon>
                                </a>
                                <a href="dashboard-cart.html" class="action-btn" title="Keranjang">
                                    <ion-icon name="bag-handle-outline"></ion-icon>
                                                                        <span class="count cart-count" style="display:none">0</span>
                                                                </a>
                                <a href="dashboard-wishlist.html" class="action-btn" title="Wishlist">
                                    <ion-icon name="heart-outline"></ion-icon>
                                                                        <span class="count wish-count" style="display:none">0</span>
                                                                </a>
                                                                <div class="tm-nav-dropdown">
                                                                    <button class="action-btn" id="globalMenuBtn" aria-haspopup="true" aria-expanded="false" title="Menu">
                                    <ion-icon name="menu-outline"></ion-icon>
                                                                    </button>
                                                                    <div class="tm-dropdown-panel hidden" id="globalMenu">
                                    <a href="dashboard-home.html"><span class="label"><ion-icon name="home-outline"></ion-icon> Beranda</span></a>
                                    <a href="dashboard-products.html"><span class="label"><ion-icon name="storefront-outline"></ion-icon> Produk</span></a>
                                    <a href="dashboard-orders.html"><span class="label"><ion-icon name="bag-check-outline"></ion-icon> Pesanan</span><span class="badge orders-count" style="display:none">0</span></a>
                                    <a href="dashboard-tracking.html"><span class="label"><ion-icon name="location-outline"></ion-icon> Lacak</span></a>
                                    <a href="dashboard-payment.html"><span class="label"><ion-icon name="card-outline"></ion-icon> Pembayaran</span></a>
                                    <a href="dashboard-settings.html"><span class="label"><ion-icon name="settings-outline"></ion-icon> Pengaturan</span></a>
                                                                    </div>
                                                                </div>
                                                        </div>
                        </div>
                    </div>
                                
                </header>

        <!-- Page Content -->
        <main class="max-w-7xl mx-auto px-4 py-6 pb-24 mt-3">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Profil Saya</h2>
                    
                    <div class="flex items-center space-x-6 mb-8">
                        <div class="relative">
                            <img src="https://ui-avatars.com/api/?name=User+ThriftMap&background=10b981&color=fff&size=120" 
                                 alt="Profile" class="w-24 h-24 rounded-full">
                            <button class="absolute bottom-0 right-0 bg-green-600 text-white p-2 rounded-full hover:bg-green-700">
                                <i class="fas fa-camera text-sm"></i>
                            </button>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">User ThriftMap</h3>
                            <p class="text-gray-600">user@thriftmap.id</p>
                            <p class="text-gray-500 text-sm">Bergabung sejak Jan 2024</p>
                        </div>
                    </div>
                    
                    <div id="tmProfileAlert" class="hidden mb-6 rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-700">
                        Lengkapi tanggal lahir kamu agar kami bisa menyesuaikan pengalaman belanja dan badge yang diterima.
                    </div>

                    <form id="profileForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                <input id="profileName" type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" 
                                       value="User ThriftMap" autocomplete="name">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                <input id="profileEmail" type="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" 
                                       value="user@thriftmap.id" autocomplete="email">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Telepon</label>
                                <input id="profilePhone" type="tel" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" 
                                       value="08123456789" autocomplete="tel">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Lahir</label>
                                <input id="profileBirthdate" type="date" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" autocomplete="bday">
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-4">
                            <button id="profileResetBtn" type="button" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                                Batal
                            </button>
                            <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                Simpan Perubahan
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Gamification / Level Section -->
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Level & Dampak Lingkungan</h2>
                        <span id="tmLevelBadge" class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800">
                            <i class="fas fa-leaf"></i>
                            <span>Level</span>
                        </span>
                    </div>
                    <p id="tmLevelTitle" class="text-gray-700 mb-3">Mulai jadi pahlawan lingkungan dengan belanja thrifting 🌱</p>
                    <div class="w-full bg-gray-100 rounded-full h-3 mb-2">
                        <div id="tmLevelProgress" class="bg-green-600 h-3 rounded-full" style="width:0%"></div>
                    </div>
                    <div class="flex justify-between text-sm text-gray-600">
                        <span id="tmXPInfo">0 / 100 XP</span>
                        <span id="tmNextInfo">100 XP ke level selanjutnya</span>
                    </div>
                    <div class="mt-6 grid gap-6 lg:grid-cols-2">
                        <div id="tmBadgeHighlight" class="relative flex flex-col items-center justify-center overflow-hidden rounded-2xl border border-sky-100 bg-gradient-to-br from-sky-50 via-white to-blue-50 p-6 text-center shadow-sm">
                            <div class="text-xs font-semibold uppercase tracking-[0.2em] text-sky-500">Badge Aktif</div>
                            <div class="mt-4 flex w-full flex-col items-center gap-4">
                                <div class="flex h-24 w-24 items-center justify-center rounded-2xl bg-white shadow-inner">
                                    <span id="tmBadgeIcon" class="text-4xl">🏅</span>
                                </div>
                                <div class="space-y-2">
                                    <h3 id="tmBadgeName" class="text-2xl font-bold text-gray-800">Belum Ada Badge</h3>
                                    <p id="tmBadgeDesc" class="text-sm text-gray-600">Kumpulkan XP untuk membuka badge level pertama.</p>
                                    <span id="tmBadgeMeta" class="inline-flex items-center rounded-full bg-white/80 px-4 py-1 text-xs font-semibold text-sky-700 shadow-sm">Level 0 / 5</span>
                                </div>
                            </div>
                            <div class="mt-6 w-full max-w-md">
                                <div class="text-xs font-medium uppercase tracking-wide text-gray-500">Progres Menuju Level Berikutnya</div>
                                <div class="mt-2 h-2 w-full rounded-full bg-white/70">
                                    <div id="tmBadgeHighlightProgress" class="h-2 rounded-full bg-sky-500" style="width:0%"></div>
                                </div>
                                <div id="tmBadgeHighlightFooter" class="mt-2 text-xs text-gray-600">Tambahkan XP untuk membuka level selanjutnya.</div>
                            </div>
                        </div>
                        <div class="rounded-2xl border border-gray-200 bg-gray-50 p-6">
                            <h3 class="text-lg font-semibold text-gray-800">XP per Kondisi Produk</h3>
                            <p class="mt-2 text-sm text-gray-600">Setiap transaksi memberikan XP berdasarkan kondisi produk yang kamu beli.</p>
                            <ul id="tmXpList" class="mt-4 space-y-3 text-sm text-gray-700">
                                <li class="flex items-center justify-between rounded-xl bg-white px-4 py-3 shadow-sm">
                                    <span>Cukup</span>
                                    <span class="font-semibold text-gray-900">+10 XP</span>
                                </li>
                                <li class="flex items-center justify-between rounded-xl bg-white px-4 py-3 shadow-sm">
                                    <span>Baik</span>
                                    <span class="font-semibold text-gray-900">+20 XP</span>
                                </li>
                                <li class="flex items-center justify-between rounded-xl bg-white px-4 py-3 shadow-sm">
                                    <span>Sangat Baik</span>
                                    <span class="font-semibold text-gray-900">+30 XP</span>
                                </li>
                                <li class="flex items-center justify-between rounded-xl bg-white px-4 py-3 shadow-sm">
                                    <span>Seperti Baru</span>
                                    <span class="font-semibold text-gray-900">+40 XP</span>
                                </li>
                            </ul>
                            <div class="mt-5 rounded-xl bg-white px-4 py-3 text-xs text-gray-500 shadow-inner">
                                XP dihitung otomatis setiap pesanan selesai. Semakin baik kondisi produk, semakin besar bonus yang kamu dapat!
                            </div>
                        </div>
                    </div>
                    <div class="mt-6">
                        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                            <h3 class="text-lg font-semibold text-gray-800">Koleksi Badge Level</h3>
                            <span class="text-xs font-medium uppercase tracking-wide text-gray-500">5 tingkat pencapaian</span>
                        </div>
                        <div id="tmBadgeGrid" class="mt-4 grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5">
                            <!-- Badge cards injected by script -->
                        </div>
                    </div>
                </div>

                <!-- Address Section -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Alamat Saya</h2>
                        <button id="addAddressBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            <i class="fas fa-plus mr-2"></i>Tambah Alamat
                        </button>
                    </div>
                    
                    <div class="space-y-4" id="addressList">
                        <!-- Address cards will be dynamically added here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="fixed bottom-0 inset-x-0 bg-white border-t border-gray-200 z-40 md:hidden">
        <div class="flex justify-around py-2 text-xs">
            <a data-nav href="dashboard-home.html" class="flex flex-col items-center text-gray-600 hover:text-green-600">
                <i class="fas fa-home text-base"></i>
                <span>Home</span>
            </a>
            <a data-nav href="dashboard-products.html" class="flex flex-col items-center text-gray-600 hover:text-green-600">
                <i class="fas fa-tags text-base"></i>
                <span>Produk</span>
            </a>
            <a data-nav href="dashboard-orders.html" class="flex flex-col items-center text-gray-600 hover:text-green-600">
                <i class="fas fa-shopping-bag text-base"></i>
                <span>Pesanan</span>
            </a>
            <a data-nav href="dashboard-tracking.html" class="flex flex-col items-center text-gray-600 hover:text-green-600">
                <i class="fas fa-map-marker-alt text-base"></i>
                <span>Lacak</span>
            </a>
            <a data-nav href="dashboard-profile.html" class="flex flex-col items-center text-gray-600 hover:text-green-600">
                <i class="fas fa-user text-base"></i>
                <span>Profil</span>
            </a>
        </div>
    </nav>

    <!-- Address Modal -->
    <div id="addressModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 w-full max-w-md address-modal-scroll">
            <div class="flex justify-between items-center mb-4">
                <h3 id="addressModalTitle" class="text-xl font-bold text-gray-800">Tambah Alamat Baru</h3>
                <button id="closeAddressModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="addressForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Label Alamat</label>
                    <input id="addressLabel" type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" 
                           placeholder="Contoh: Rumah, Kantor">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Alamat Lengkap</label>
                    <textarea id="addressFull" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" 
                              rows="3" placeholder="Nama jalan, nomor rumah, patokan penting"></textarea>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kota</label>
                        <input id="addressCity" type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Kota/Kabupaten">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Provinsi</label>
                        <input id="addressProvince" type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Provinsi">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kecamatan</label>
                        <input id="addressDistrict" type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Kecamatan">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kelurahan/Desa</label>
                        <input id="addressSubDistrict" type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Kelurahan/Desa">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kode Pos</label>
                        <input id="addressPostal" type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Kode Pos">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Telepon Penerima</label>
                        <input id="addressPhone" type="tel" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Nomor aktif untuk kurir">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Catatan untuk Kurir</label>
                    <textarea id="addressNotes" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" rows="2" placeholder="Contoh: Gerbang hitam, titip ke satpam"></textarea>
                </div>
                
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="cancelAddress" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Batal
                    </button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Simpan Alamat
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="./assets/js/products-data.js"></script>
    <script src="./assets/js/notify.js"></script>
    <script src="./assets/js/gamification.js"></script>
    <script>
        // Global menu dropdown & bottom nav active
        (function(){
            const btn = document.getElementById('globalMenuBtn');
            const menu = document.getElementById('globalMenu');
            if (btn && menu) {
                btn.addEventListener('click', () => {
                    const expanded = btn.getAttribute('aria-expanded') === 'true';
                    btn.setAttribute('aria-expanded', String(!expanded));
                    menu.classList.toggle('hidden');
                });
                document.addEventListener('click', (e) => {
                    if (!menu.contains(e.target) && e.target !== btn && !btn.contains(e.target)) {
                        menu.classList.add('hidden');
                        btn.setAttribute('aria-expanded', 'false');
                    }
                });
            }
            document.querySelectorAll('a[data-nav]').forEach(a => {
                const href = a.getAttribute('href') || '';
                if (location.pathname.endsWith(href)) a.classList.add('text-green-600');
            });
        })();

        const PROFILE_STORAGE_KEY = 'tm_profile_data';
        const ADDRESS_STORAGE_KEY = 'tm_profile_addresses';

        const defaultProfile = {
            name: 'User ThriftMap',
            email: 'user@thriftmap.id',
            phone: '08123456789',
            birthdate: ''
        };

        const defaultAddresses = [
            {
                id: 1,
                label: 'Rumah',
                detail: 'Jl. Thrift No. 123, Jakarta Selatan',
                city: 'Jakarta Selatan',
                province: 'DKI Jakarta',
                district: 'Kebayoran Baru',
                subDistrict: 'Senopati',
                postalCode: '12345',
                phone: '08123456789',
                notes: 'Gerbang hitam, rumah kedua dari kanan',
                isPrimary: true
            },
            {
                id: 2,
                label: 'Kantor',
                detail: 'Gedung ThriftMap Lt. 5, Jl. Sustainable No. 456',
                city: 'Jakarta Pusat',
                province: 'DKI Jakarta',
                district: 'Tanah Abang',
                subDistrict: 'Kebon Melati',
                postalCode: '10230',
                phone: '0211234567',
                notes: 'Tunjukkan kartu identitas di lobi',
                isPrimary: false
            }
        ];

        function loadProfileFromStorage(){
            try {
                const raw = localStorage.getItem(PROFILE_STORAGE_KEY);
                if (!raw) return { ...defaultProfile };
                const parsed = JSON.parse(raw);
                return { ...defaultProfile, ...parsed };
            } catch {
                return { ...defaultProfile };
            }
        }

        function saveProfileToStorage(profile){
            try {
                localStorage.setItem(PROFILE_STORAGE_KEY, JSON.stringify(profile));
            } catch {}
        }

        function loadAddressesFromStorage(){
            try {
                const raw = localStorage.getItem(ADDRESS_STORAGE_KEY);
                if (!raw) return [...defaultAddresses];
                const parsed = JSON.parse(raw);
                if (!Array.isArray(parsed) || parsed.length === 0) return [...defaultAddresses];
                return parsed;
            } catch {
                return [...defaultAddresses];
            }
        }

        function saveAddressesToStorage(list){
            try {
                localStorage.setItem(ADDRESS_STORAGE_KEY, JSON.stringify(list));
            } catch {}
        }

        let addressBook = loadAddressesFromStorage();

        // Address Management
        const addressModal = document.getElementById('addressModal');
    const addAddressBtn = document.getElementById('addAddressBtn');
    const closeAddressModal = document.getElementById('closeAddressModal');
    const cancelAddress = document.getElementById('cancelAddress');
    const addressForm = document.getElementById('addressForm');
    const addressList = document.getElementById('addressList');
        const addressModalTitle = document.getElementById('addressModalTitle');
    const addressLabelInput = document.getElementById('addressLabel');
    const addressFullInput = document.getElementById('addressFull');
    const addressCityInput = document.getElementById('addressCity');
    const addressProvinceInput = document.getElementById('addressProvince');
    const addressDistrictInput = document.getElementById('addressDistrict');
    const addressSubDistrictInput = document.getElementById('addressSubDistrict');
    const addressPostalInput = document.getElementById('addressPostal');
    const addressPhoneInput = document.getElementById('addressPhone');
    const addressNotesInput = document.getElementById('addressNotes');
        let editingAddressId = null;

        function populateAddressForm(address){
            if (!address) return;
            if (addressLabelInput) addressLabelInput.value = address.label || '';
            if (addressFullInput) addressFullInput.value = address.detail || address.address || '';
            if (addressCityInput) addressCityInput.value = address.city || '';
            if (addressProvinceInput) addressProvinceInput.value = address.province || '';
            if (addressDistrictInput) addressDistrictInput.value = address.district || '';
            if (addressSubDistrictInput) addressSubDistrictInput.value = address.subDistrict || '';
            if (addressPostalInput) addressPostalInput.value = address.postalCode || '';
            if (addressPhoneInput) addressPhoneInput.value = address.phone || '';
            if (addressNotesInput) addressNotesInput.value = address.notes || '';
        }

        function renderAddresses() {
            addressList.innerHTML = '';
            if (!Array.isArray(addressBook) || addressBook.length === 0) {
                addressList.innerHTML = '<div class="rounded-lg border border-dashed border-gray-300 bg-gray-50 p-6 text-center text-sm text-gray-500">Belum ada alamat tersimpan. Tambahkan alamat untuk mempercepat checkout.</div>';
                return;
            }

            addressBook.forEach(address => {
                const addressCard = document.createElement('div');
                addressCard.className = 'border border-gray-200 rounded-lg p-4 shadow-sm';
                addressCard.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="font-medium text-gray-800">${address.label}</span>
                            ${address.isPrimary ? '<span class="ml-2 px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Utama</span>' : ''}
                        </div>
                        <div class="flex space-x-2">
                            <button type="button" class="text-blue-600 hover:text-blue-800 text-sm" data-action="edit" data-id="${address.id}">Edit</button>
                            ${!address.isPrimary ? `<button type="button" class="text-red-600 hover:text-red-800 text-sm" data-action="delete" data-id="${address.id}">Hapus</button>` : ''}
                        </div>
                    </div>
                    <p class="text-gray-600 text-sm mb-2">${address.detail || address.address || '-'}</p>
                    <p class="text-gray-500 text-sm">${[address.subDistrict, address.district, address.city, address.province].filter(Boolean).join(', ')}</p>
                    <p class="text-gray-500 text-sm">Kode Pos ${address.postalCode || '-'}</p>
                    <div class="mt-3 flex flex-wrap items-center gap-x-4 gap-y-2 text-xs text-gray-500">
                        ${address.phone ? `<span><i class="fas fa-phone mr-1"></i>${address.phone}</span>` : ''}
                        ${address.notes ? `<span class="inline-flex items-center gap-1 rounded-full bg-gray-100 px-3 py-1 text-gray-600"><i class="fas fa-sticky-note"></i><span>${address.notes}</span></span>` : ''}
                    </div>
                    ${!address.isPrimary ? `
                    <div class="mt-3">
                        <button type="button" class="text-green-600 hover:text-green-800 text-sm font-medium" data-action="set-primary" data-id="${address.id}">
                            Jadikan Alamat Utama
                        </button>
                    </div>
                    ` : ''}
                `;
                addressList.appendChild(addressCard);
            });
        }

        const LEVEL_ICON_MAP = {
            1: '🌱',
            2: '🌿',
            3: '♻️',
            4: '🛡️',
            5: '🏆'
        };

        function toTitleCase(str) {
            return String(str || '')
                .split(/\s+/)
                .map(word => word ? word.charAt(0).toUpperCase() + word.slice(1) : '')
                .join(' ')
                .trim();
        }

        function renderXpList() {
            const xpListEl = document.getElementById('tmXpList');
            const xpMap = window.TMGami?.XP_MAP;
            if (!xpListEl || !xpMap) return;
            xpListEl.innerHTML = Object.entries(xpMap).map(([label, value]) => (
                `<li class="flex items-center justify-between rounded-xl bg-white px-4 py-3 shadow-sm">
                    <span>${toTitleCase(label)}</span>
                    <span class="font-semibold text-gray-900">+${Number(value || 0).toLocaleString('id-ID')} XP</span>
                </li>`
            )).join('');
        }

        function renderBadgeOverview(progressData) {
            const gami = window.TMGami;
            if (!gami) return;
            const data = progressData || gami.progressToNext?.();
            if (!data) return;
            const total = typeof data.total === 'number' ? data.total : gami.getXP();
            const level = data.level || gami.getLevel(total);

            const iconEl = document.getElementById('tmBadgeIcon');
            if (iconEl) iconEl.textContent = LEVEL_ICON_MAP[level?.id] || '🏅';

            const nameEl = document.getElementById('tmBadgeName');
            if (nameEl) nameEl.textContent = level?.name || 'Level';

            const descEl = document.getElementById('tmBadgeDesc');
            if (descEl && level) {
                const range = level.xpMax === Number.POSITIVE_INFINITY
                    ? `${level.xpMin.toLocaleString('id-ID')}+ XP`
                    : `${level.xpMin.toLocaleString('id-ID')} – ${level.xpMax.toLocaleString('id-ID')} XP`;
                descEl.textContent = `Rentang XP: ${range}`;
            }

            const metaEl = document.getElementById('tmBadgeMeta');
            if (metaEl && level) {
                metaEl.textContent = `Level ${level.id} dari ${gami.LEVELS.length} • ${total.toLocaleString('id-ID')} XP`;
            }

            const barEl = document.getElementById('tmBadgeHighlightProgress');
            if (barEl) {
                const percent = Math.max(0, Math.min(100, Number(data.percent) || 0));
                barEl.style.width = `${percent}%`;
            }

            const footerEl = document.getElementById('tmBadgeHighlightFooter');
            if (footerEl) {
                if ((data.remaining || 0) > 0 && data.nextLevel) {
                    footerEl.textContent = `${data.remaining.toLocaleString('id-ID')} XP lagi menuju ${data.nextLevel.name}`;
                } else {
                    footerEl.textContent = 'Kamu sudah mencapai level tertinggi. Pertahankan!';
                }
            }
        }

        function renderBadgeGrid(totalXP) {
            const gridEl = document.getElementById('tmBadgeGrid');
            const gami = window.TMGami;
            if (!gridEl || !gami) return;

            const xp = typeof totalXP === 'number' ? totalXP : gami.getXP();
            const levels = Array.isArray(gami.LEVELS) ? gami.LEVELS : [];

            gridEl.innerHTML = '';
            levels.forEach((level) => {
                const unlocked = xp >= level.xpMin;
                const isCurrent = unlocked && xp <= level.xpMax;
                const rangeLabel = level.xpMax === Number.POSITIVE_INFINITY
                    ? `${level.xpMin.toLocaleString('id-ID')}+ XP`
                    : `${level.xpMin.toLocaleString('id-ID')} – ${level.xpMax.toLocaleString('id-ID')} XP`;

                let percent;
                if (xp >= level.xpMin) {
                    if (level.xpMax === Number.POSITIVE_INFINITY) {
                        percent = 100;
                    } else {
                        const clamped = Math.min(xp, level.xpMax);
                        const span = Math.max(1, level.xpMax - level.xpMin);
                        percent = Math.round(((clamped - level.xpMin) / span) * 100);
                    }
                } else {
                    percent = level.xpMin === 0 ? 0 : Math.round((xp / level.xpMin) * 100);
                }
                percent = Math.max(0, Math.min(100, percent));

                const remaining = xp >= level.xpMin ? 0 : level.xpMin - xp;

                const statusLabel = unlocked ? (isCurrent ? 'Sedang Aktif' : 'Sudah Dibuka') : 'Terkunci';
                const statusClass = unlocked
                    ? (isCurrent ? 'bg-sky-500 text-white' : 'bg-emerald-500 text-white')
                    : 'bg-gray-200 text-gray-600';

                const card = document.createElement('div');
                card.className = `relative flex flex-col items-center justify-between gap-4 overflow-hidden rounded-3xl border ${unlocked ? 'border-sky-200 bg-white shadow-lg shadow-sky-100/40' : 'border-dashed border-gray-200 bg-white/70'} p-5 text-center transition-transform duration-150 hover:-translate-y-1`;
                card.innerHTML = `
                    <span class="rounded-full px-3 py-1 text-xs font-semibold ${statusClass}">${statusLabel}</span>
                    <div class="flex h-16 w-16 items-center justify-center rounded-2xl bg-gradient-to-br ${unlocked ? 'from-sky-50 via-white to-emerald-50' : 'from-gray-100 via-white to-gray-100'} shadow-inner">
                        <span class="text-3xl">${LEVEL_ICON_MAP[level.id] || '🏅'}</span>
                    </div>
                    <div class="space-y-1">
                        <p class="text-sm font-semibold text-gray-800">${level.name}</p>
                        <p class="text-xs text-gray-500">Level ${level.id} • ${rangeLabel}</p>
                    </div>
                    <div class="w-full max-w-[140px] h-2 rounded-full bg-gray-100">
                        <div class="h-2 rounded-full ${unlocked ? 'bg-emerald-500' : 'bg-gray-300'}" style="width:${percent}%"></div>
                    </div>
                    <p class="text-xs text-gray-500">${remaining > 0
                        ? `${remaining.toLocaleString('id-ID')} XP lagi untuk membuka level ini`
                        : (isCurrent ? 'Terus kumpulkan XP untuk mencapai level berikutnya.' : 'Level ini sudah kamu lewati.')}</p>
                `;

                gridEl.appendChild(card);
            });
        }

        const profileForm = document.getElementById('profileForm');
        const profileAlert = document.getElementById('tmProfileAlert');
        const profileNameInput = document.getElementById('profileName');
        const profileEmailInput = document.getElementById('profileEmail');
        const profilePhoneInput = document.getElementById('profilePhone');
        const profileBirthdateInput = document.getElementById('profileBirthdate');
        const profileResetBtn = document.getElementById('profileResetBtn');

        function hydrateProfileForm(profile){
            if (profileNameInput) profileNameInput.value = profile.name || '';
            if (profileEmailInput) profileEmailInput.value = profile.email || '';
            if (profilePhoneInput) profilePhoneInput.value = profile.phone || '';
            if (profileBirthdateInput) profileBirthdateInput.value = profile.birthdate || '';
            handleBirthdateWarning(!profile.birthdate);
        }

        function handleBirthdateWarning(show){
            if (profileAlert) profileAlert.classList.toggle('hidden', !show);
            if (profileBirthdateInput) {
                if (show) {
                    profileBirthdateInput.classList.add('ring-2', 'ring-amber-400');
                } else {
                    profileBirthdateInput.classList.remove('ring-2', 'ring-amber-400');
                }
            }
        }

        function openAddressModal(address){
            if (!addressModal) return;
            if (addressForm) addressForm.reset();
            if (address) {
                editingAddressId = address.id;
                populateAddressForm(address);
                if (addressModalTitle) addressModalTitle.textContent = 'Edit Alamat';
            } else {
                editingAddressId = null;
                if (addressModalTitle) addressModalTitle.textContent = 'Tambah Alamat Baru';
            }
            addressModal.classList.remove('hidden');
            document.body.classList.add('modal-lock');
            document.documentElement.classList.add('modal-lock');
        }

        function closeAddressModalFn(){
            if (!addressModal) return;
            addressModal.classList.add('hidden');
            document.body.classList.remove('modal-lock');
            document.documentElement.classList.remove('modal-lock');
            editingAddressId = null;
            if (addressForm) addressForm.reset();
            if (addressModalTitle) addressModalTitle.textContent = 'Tambah Alamat Baru';
        }

        if (addAddressBtn) {
            addAddressBtn.addEventListener('click', () => openAddressModal());
        }

        if (closeAddressModal) {
            closeAddressModal.addEventListener('click', closeAddressModalFn);
        }

        if (cancelAddress) {
            cancelAddress.addEventListener('click', closeAddressModalFn);
        }

        if (addressForm) {
            addressForm.addEventListener('submit', (e) => {
                e.preventDefault();

                const payload = {
                    id: editingAddressId || Date.now(),
                    label: addressLabelInput?.value?.trim() || '',
                    detail: addressFullInput?.value?.trim() || '',
                    city: addressCityInput?.value?.trim() || '',
                    province: addressProvinceInput?.value?.trim() || '',
                    district: addressDistrictInput?.value?.trim() || '',
                    subDistrict: addressSubDistrictInput?.value?.trim() || '',
                    postalCode: addressPostalInput?.value?.trim() || '',
                    phone: addressPhoneInput?.value?.trim() || '',
                    notes: addressNotesInput?.value?.trim() || ''
                };

                const requiredMissing = [];
                if (!payload.label) requiredMissing.push('label alamat');
                if (!payload.detail) requiredMissing.push('alamat lengkap');
                if (!payload.city) requiredMissing.push('kota');
                if (!payload.province) requiredMissing.push('provinsi');
                if (!payload.postalCode) requiredMissing.push('kode pos');

                if (requiredMissing.length > 0){
                    if (window.Notify?.toastWarn) {
                        Notify.toastWarn(`Lengkapi ${requiredMissing.join(', ')} terlebih dahulu`);
                    }
                    return;
                }

                const isEditMode = Boolean(editingAddressId);

                if (editingAddressId){
                    addressBook = addressBook.map(addr => addr.id === editingAddressId ? { ...addr, ...payload, isPrimary: addr.isPrimary } : addr);
                } else {
                    const isPrimary = addressBook.length === 0;
                    if (isPrimary){
                        addressBook = addressBook.map(addr => ({ ...addr, isPrimary: false }));
                    }
                    addressBook.push({ ...payload, isPrimary });
                }
                saveAddressesToStorage(addressBook);
                renderAddresses();
                closeAddressModalFn();
                if (window.Notify?.toastSuccess) {
                    Notify.toastSuccess(isEditMode ? 'Alamat berhasil diperbarui' : 'Alamat baru berhasil disimpan');
                }
            });
        }

        if (addressList) {
            addressList.addEventListener('click', async (event) => {
                const btn = event.target.closest('button[data-action]');
                if (!btn) return;
                const action = btn.dataset.action;
                const id = Number(btn.dataset.id);
                if (!id) return;

                if (action === 'set-primary') {
                    addressBook = addressBook.map(addr => ({ ...addr, isPrimary: addr.id === id }));
                    saveAddressesToStorage(addressBook);
                    renderAddresses();
                    if (window.Notify?.toastSuccess) {
                        Notify.toastSuccess('Alamat utama diperbarui');
                    }
                } else if (action === 'delete') {
                    let confirmed = true;
                    if (window.Notify?.confirm) {
                        const result = await Notify.confirm('Hapus alamat ini?', 'Alamat akan dihapus dari daftar', 'Hapus');
                        confirmed = Boolean(result?.isConfirmed);
                    } else {
                        confirmed = window.confirm('Hapus alamat ini?');
                    }
                    if (!confirmed) return;
                    const removed = addressBook.find(addr => addr.id === id);
                    addressBook = addressBook.filter(addr => addr.id !== id);
                    if (removed?.isPrimary && addressBook.length > 0) {
                        addressBook = addressBook.map((addr, idx) => ({ ...addr, isPrimary: idx === 0 }));
                    }
                    saveAddressesToStorage(addressBook);
                    renderAddresses();
                    if (window.Notify?.toastSuccess) {
                        Notify.toastSuccess('Alamat berhasil dihapus');
                    }
                } else if (action === 'edit') {
                    const target = addressBook.find(addr => addr.id === id);
                    if (target) openAddressModal(target);
                }
            });
        }

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === addressModal) {
                closeAddressModalFn();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const profileData = loadProfileFromStorage();
            hydrateProfileForm(profileData);

            addressBook = loadAddressesFromStorage();
            renderAddresses();
            renderXpList();

            let prog;
            try {
                prog = window.TMGami?.progressToNext?.();
                if (prog){
                    const badge = document.getElementById('tmLevelBadge');
                    if (badge) {
                        const levelSpan = badge.querySelector('span:last-child');
                        if (levelSpan) levelSpan.textContent = prog.level?.name || 'Level';
                    }

                    const title = document.getElementById('tmLevelTitle');
                    if (title){
                        title.textContent = prog.level?.id === 5
                            ? 'Top 1% Penyelamat Lingkungan — kamu di puncak! 🌟'
                            : `Level saat ini: ${prog.level?.name}`;
                    }

                    const bar = document.getElementById('tmLevelProgress');
                    if (bar) bar.style.width = `${Math.max(0, Math.min(100, Number(prog.percent) || 0))}%`;

                    const xpInfo = document.getElementById('tmXPInfo');
                    if (xpInfo){
                        const span = Math.max(1, (prog.nextStart - prog.start));
                        const curInLevel = Math.max(0, prog.total - prog.start);
                        xpInfo.textContent = `${curInLevel.toLocaleString('id-ID')} / ${span.toLocaleString('id-ID')} XP`;
                    }

                    const nextInfo = document.getElementById('tmNextInfo');
                    if (nextInfo){
                        if (prog.level?.id === 5){
                            nextInfo.textContent = 'Kamu sudah di level tertinggi!';
                        } else {
                            nextInfo.textContent = `${prog.remaining.toLocaleString('id-ID')} XP ke level selanjutnya`;
                        }
                    }
                }
            } catch {}

            renderBadgeOverview(prog);
            renderBadgeGrid(prog?.total);

            if (profileBirthdateInput){
                profileBirthdateInput.addEventListener('input', () => {
                    handleBirthdateWarning(!profileBirthdateInput.value);
                });
            }

            if (profileForm){
                profileForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const payload = {
                        name: profileNameInput?.value?.trim() || '',
                        email: profileEmailInput?.value?.trim() || '',
                        phone: profilePhoneInput?.value?.trim() || '',
                        birthdate: profileBirthdateInput?.value || ''
                    };

                    if (!payload.birthdate){
                        handleBirthdateWarning(true);
                        profileBirthdateInput?.focus();
                        if (window.Notify?.toastWarn) {
                            Notify.toastWarn('Lengkapi tanggal lahir dulu, ya!');
                        }
                        return;
                    }

                    saveProfileToStorage(payload);
                    handleBirthdateWarning(false);
                    if (window.Notify?.toastSuccess) {
                        Notify.toastSuccess('Profil berhasil disimpan');
                    }
                });
            }

            if (profileResetBtn){
                profileResetBtn.addEventListener('click', () => {
                    const stored = loadProfileFromStorage();
                    hydrateProfileForm(stored);
                    if (window.Notify?.toastInfo) {
                        Notify.toastInfo('Data profil dikembalikan ke versi tersimpan');
                    }
                });
            }
        });
    </script>
    <!-- Ionicons for index-style UI -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
        <script>
            // Orders badge sync
            (function(){
                const KEY='tm_orders_count';
                function update(){
                    const c = parseInt(localStorage.getItem(KEY)||'0',10)||0;
                    document.querySelectorAll('.orders-count').forEach(el=>{
                        if (c>0){ el.textContent=String(c); el.style.display=''; }
                        else { el.textContent='0'; el.style.display='none'; }
                    });
                }
                document.addEventListener('DOMContentLoaded', update);
                window.TMOrdersBadge = {
                    set(n){ localStorage.setItem(KEY, String(Math.max(0, Number(n)||0))); update(); },
                    get(){ return parseInt(localStorage.getItem(KEY)||'0',10)||0; }
                };
            })();
        </script>
        <script>
            // Orders badge sync
            (function(){
                const KEY='tm_orders_count';
                function update(){
                    const c = parseInt(localStorage.getItem(KEY)||'0',10)||0;
                    document.querySelectorAll('.orders-count').forEach(el=>{
                        if (c>0){ el.textContent=String(c); el.style.display=''; }
                        else { el.textContent='0'; el.style.display='none'; }
                    });
                }
                document.addEventListener('DOMContentLoaded', update);
                window.TMOrdersBadge = {
                    set(n){ localStorage.setItem(KEY, String(Math.max(0, Number(n)||0))); update(); },
                    get(){ return parseInt(localStorage.getItem(KEY)||'0',10)||0; }
                };
            })();
        </script>
</body>
</html>
