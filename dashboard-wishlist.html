<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wishlist - ThriftMap</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkfB+BeIVHeY5x9JyvqB+1bpkfz0QG8T5nUrpHK7aC+7pCwT6U2Q==" crossorigin="anonymous" referrerpolicy="no-referrer">
  <link rel="stylesheet" href="./assets/css/style-prefix.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background: #f8fafc; }
    .btn { transition: all .25s ease; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 18px rgba(16, 185, 129, 0.25); }
    .wishlist-card { transition: transform .2s ease, box-shadow .2s ease; }
    .wishlist-card:hover { transform: translateY(-3px); box-shadow: 0 14px 32px rgba(15, 118, 110, 0.12); }
    .wishlist-thumb { background: linear-gradient(145deg, rgba(236, 253, 245, 0.9), rgba(209, 250, 229, 0.7)); }
    .line-clamp-3 { display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 3; line-clamp: 3; overflow: hidden; }
  </style>
</head>
<body class="bg-gray-50">
  <header style="position:sticky;top:0;z-index:1300;background:#fff">
    <div class="header-main">
      <div class="container">
        <a href="dashboard-home.html" class="header-logo">
          <img src="./assets/images/logo/logo.svg" alt="ThriftMap logo" width="120" height="36">
        </a>
        <div class="header-search-container">
          <input id="wishlistSearch" type="search" name="search" class="search-field" placeholder="Cari di wishlist...">
          <button class="search-btn" id="wishlistSearchBtn">
            <ion-icon name="search-outline"></ion-icon>
          </button>
        </div>
        <div class="header-user-actions" style="margin-left:auto">
          <a href="dashboard-profile.html" class="action-btn" title="Akun">
            <ion-icon name="person-outline"></ion-icon>
          </a>
          <a href="dashboard-cart.html" class="action-btn" title="Keranjang">
            <ion-icon name="bag-handle-outline"></ion-icon>
            <span class="count cart-count" style="display:none">0</span>
          </a>
          <button type="button" class="action-btn" data-open-wishlist title="Wishlist Panel">
            <ion-icon name="heart-outline"></ion-icon>
            <span class="count wish-count" style="display:none">0</span>
          </button>
          <div class="tm-nav-dropdown">
            <button class="action-btn" id="globalMenuBtn" aria-haspopup="true" aria-expanded="false" title="Menu">
              <ion-icon name="menu-outline"></ion-icon>
            </button>
            <div class="tm-dropdown-panel hidden" id="globalMenu">
              <a href="dashboard-home.html"><span class="label"><ion-icon name="home-outline"></ion-icon> Beranda</span></a>
              <a href="dashboard-products.html"><span class="label"><ion-icon name="storefront-outline"></ion-icon> Produk</span></a>
              <a href="dashboard-orders.html"><span class="label"><ion-icon name="bag-check-outline"></ion-icon> Pesanan</span><span class="badge orders-count" style="display:none">0</span></a>
              <a href="dashboard-tracking.html"><span class="label"><ion-icon name="location-outline"></ion-icon> Lacak</span></a>
              <a href="dashboard-payment.html"><span class="label"><ion-icon name="card-outline"></ion-icon> Pembayaran</span></a>
              <a href="dashboard-settings.html"><span class="label"><ion-icon name="settings-outline"></ion-icon> Pengaturan</span></a>
              <a href="dashboard-wishlist.html" class="is-active"><span class="label"><ion-icon name="heart-outline"></ion-icon> Wishlist</span><span class="badge wish-count" style="display:none">0</span></a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 pb-24 mt-3">
    <div class="flex flex-col gap-2 mb-8">
      <div class="inline-flex items-center gap-2 text-sm text-emerald-600 font-semibold">
        <i class="fa-solid fa-heart-circle-check"></i>
        <span id="wishlistCount">Wishlist kamu</span>
      </div>
      <h1 class="text-3xl font-bold text-gray-900">Produk Favorit</h1>
      <p class="text-sm text-gray-500">Kelola produk yang kamu simpan. Tambahkan ke keranjang atau hapus dari wishlist kapan pun.</p>
    </div>

    <section id="wishlistEmpty" class="hidden bg-white border border-dashed border-emerald-200 rounded-3xl p-10 text-center shadow-sm">
      <div class="mx-auto mb-4 flex h-20 w-20 items-center justify-center rounded-full bg-emerald-50 text-emerald-500 shadow-inner">
        <i class="fa-solid fa-heart-crack text-3xl"></i>
      </div>
      <h2 class="text-lg font-semibold text-gray-800 mb-1">Wishlist masih kosong</h2>
      <p class="text-sm text-gray-500 mb-5">Temukan produk preloved terbaik dan simpan untuk dibeli nanti.</p>
      <a href="dashboard-products.html" class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg btn"><i class="fa-solid fa-compass"></i> Jelajahi Produk</a>
    </section>

    <section id="wishlistListWrapper" class="hidden">
      <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
        <div class="flex items-center gap-2 text-sm text-gray-500">
          <i class="fa-solid fa-info-circle"></i>
          <span>Tekan tombol keranjang untuk langsung menambahkan produk.</span>
        </div>
        <button id="btnClearWishlist" class="text-sm font-medium text-red-500 hover:text-red-600">Hapus Semua</button>
      </div>
      <div id="wishlistGrid" class="grid grid-cols-1 gap-5 md:grid-cols-2 xl:grid-cols-3"></div>
    </section>
  </main>

  <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t z-30">
    <div class="max-w-5xl mx-auto grid grid-cols-4 text-center">
      <a href="dashboard-home.html" class="py-2 text-gray-500"><i class="fa-solid fa-house"></i><div class="text-[10px]">Home</div></a>
      <a href="dashboard-products.html" class="py-2 text-gray-500"><i class="fa-solid fa-store"></i><div class="text-[10px]">Produk</div></a>
      <a href="dashboard-cart.html" class="py-2 text-gray-500 relative"><i class="fa-solid fa-cart-shopping"></i><span class="cart-count hidden absolute left-1/2 -translate-x-1/2 -top-1.5 bg-red-500 text-white text-[10px] px-1 rounded-full">0</span><div class="text-[10px]">Cart</div></a>
      <a href="dashboard-wishlist.html" class="py-2 text-emerald-600"><i class="fa-solid fa-heart"></i><div class="text-[10px]">Wishlist</div></a>
    </div>
  </nav>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.7/dist/sweetalert2.all.min.js"></script>
  <script src="./assets/js/notify.js"></script>
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
  <script src="./assets/js/wishlist.js"></script>
  <script src="./assets/js/cart.js"></script>
  <script src="./assets/js/products-data.js"></script>
  <script src="./assets/js/wishlist-panel.js"></script>
  <script>
    (function(){
      const KEY = 'tm_orders_count';
      function syncing(){
        const value = parseInt(localStorage.getItem(KEY) || '0', 10) || 0;
        document.querySelectorAll('.orders-count').forEach(el => {
          if (value > 0){
            el.textContent = String(value);
            el.style.display = '';
          } else {
            el.textContent = '0';
            el.style.display = 'none';
          }
        });
      }
      document.addEventListener('DOMContentLoaded', syncing);
      window.TMOrdersBadge = {
        set(n){ localStorage.setItem(KEY, String(Math.max(0, Number(n) || 0))); syncing(); },
        get(){ return parseInt(localStorage.getItem(KEY) || '0', 10) || 0; }
      };
    })();
  </script>
  <script>
    (function(){
      const btn = document.getElementById('globalMenuBtn');
      const menu = document.getElementById('globalMenu');
      if (!btn || !menu) return;
      btn.addEventListener('click', (event) => {
        event.stopPropagation();
        const expanded = btn.getAttribute('aria-expanded') === 'true';
        btn.setAttribute('aria-expanded', String(!expanded));
        menu.classList.toggle('hidden');
      });
      document.addEventListener('click', (event) => {
        if (!menu.contains(event.target) && event.target !== btn && !btn.contains(event.target)){
          menu.classList.add('hidden');
          btn.setAttribute('aria-expanded', 'false');
        }
      });
      try {
        const orders = parseInt(localStorage.getItem('tm_orders_count') || '0', 10);
        const wishList = JSON.parse(localStorage.getItem('tm_wishlist_items') || '[]');
        const wishCount = Array.isArray(wishList) ? wishList.length : 0;
        const ordersBadge = menu.querySelector('.orders-count');
        const wishlistBadge = menu.querySelectorAll('.wish-count');
        if (ordersBadge){
          if (orders > 0){ ordersBadge.style.display = 'inline-block'; ordersBadge.textContent = String(orders); }
          else { ordersBadge.style.display = 'none'; }
        }
        wishlistBadge.forEach(el => {
          if (wishCount > 0){ el.style.display = 'inline-block'; el.textContent = String(wishCount); }
          else { el.style.display = 'none'; }
        });
      } catch {}
    })();
  </script>
  <script>
    (function(){
      const FALLBACK_IMAGE = './assets/images/logo/logo.svg';
      const wishlistGrid = document.getElementById('wishlistGrid');
      const wishlistEmpty = document.getElementById('wishlistEmpty');
      const wishlistListWrapper = document.getElementById('wishlistListWrapper');
      const wishlistCount = document.getElementById('wishlistCount');
      const btnClear = document.getElementById('btnClearWishlist');
      const searchInput = document.getElementById('wishlistSearch');
      const searchBtn = document.getElementById('wishlistSearchBtn');

      function formatPrice(value){
        try {
          return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(Number(value) || 0);
        } catch {
          return `Rp ${(Number(value)||0).toLocaleString('id-ID')}`;
        }
      }

      function mapWishlistProducts(){
        const ids = window.TMWishlist?.get?.() || [];
        const products = Array.isArray(window.TM_PRODUCTS) ? window.TM_PRODUCTS : [];
        const map = new Map(products.map(item => [String(item.id), item]));
        return ids.map(id => {
          const key = String(id);
          const product = map.get(key);
          if (product) return product;
          return { id: key, name: `Produk #${key}`, price: 0, image: FALLBACK_IMAGE, condition: '', description: '' };
        });
      }

      function filterProducts(products, query){
        if (!query) return products;
        const term = query.trim().toLowerCase();
        if (!term) return products;
        return products.filter(item => {
          const name = String(item.name || '').toLowerCase();
          const condition = String(item.condition || '').toLowerCase();
          return name.includes(term) || condition.includes(term);
        });
      }

      function renderWishlist(query){
        const products = filterProducts(mapWishlistProducts(), query);
        const hasItems = products.length > 0;

        wishlistCount.textContent = hasItems ? `${products.length} produk favorit` : 'Belum ada produk di wishlist';
        wishlistEmpty.classList.toggle('hidden', hasItems);
        wishlistListWrapper.classList.toggle('hidden', !hasItems);

        if (!hasItems){
          wishlistGrid.innerHTML = '';
          return;
        }

        wishlistGrid.innerHTML = products.map(product => {
          const priceLabel = formatPrice(product.price);
          const conditionLabel = product.condition ? String(product.condition) : 'Kondisi tidak tersedia';
          const description = product.description ? String(product.description) : '';
          const link = `dashboard-product.html?id=${encodeURIComponent(product.id)}`;
          return `
            <article class="wishlist-card bg-white border border-gray-100 rounded-3xl p-5 flex flex-col gap-4" data-id="${product.id}">
              <div class="flex gap-4">
                <div class="wishlist-thumb w-28 h-28 rounded-2xl flex items-center justify-center overflow-hidden">
                  <img src="${product.image || FALLBACK_IMAGE}" alt="${product.name}" class="h-full w-full object-contain">
                </div>
                <div class="flex-1 min-w-0">
                  <h3 class="text-lg font-semibold text-gray-900 truncate">${product.name}</h3>
                  <p class="text-xs text-emerald-600 font-medium uppercase tracking-[0.18em] mt-1">${conditionLabel}</p>
                  ${description ? `<p class="mt-2 text-sm text-gray-500 line-clamp-3">${description}</p>` : ''}
                </div>
              </div>
              <div class="flex items-end justify-between gap-3">
                <div>
                  <p class="text-sm text-gray-400">Harga sekarang</p>
                  <p class="text-xl font-bold text-green-600">${priceLabel}</p>
                </div>
                <a href="${link}" class="text-sm font-medium text-emerald-600 hover:text-emerald-700">Lihat Detail</a>
              </div>
              <div class="flex flex-wrap gap-2">
                <button type="button" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-green-600 text-white text-sm font-semibold btn" data-addcart="${product.id}">
                  <i class="fa-solid fa-cart-plus"></i> Tambah ke Keranjang
                </button>
                <button type="button" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-rose-100 text-rose-600 text-sm font-semibold hover:bg-rose-200 transition" data-remove="${product.id}">
                  <i class="fa-solid fa-trash"></i> Hapus
                </button>
              </div>
            </article>
          `;
        }).join('');
      }

      function handleSearch(){
        renderWishlist(searchInput.value);
      }

      document.addEventListener('click', (event) => {
        const removeBtn = event.target.closest('[data-remove]');
        if (removeBtn){
          const id = removeBtn.getAttribute('data-remove');
          window.TMWishlist?.remove?.(id);
          renderWishlist(searchInput.value);
          return;
        }
        const addCartBtn = event.target.closest('[data-addcart]');
        if (addCartBtn){
          const id = addCartBtn.getAttribute('data-addcart');
          const products = mapWishlistProducts();
          const product = products.find(item => String(item.id) === String(id));
          if (product){
            window.TMCart?.addItem?.({ id: product.id, name: product.name, price: product.price, image: product.image }, 1);
            try {
              Notify?.toastSuccess?.(`${product.name} ditambahkan ke keranjang`);
            } catch {}
          }
          return;
        }
      });

      btnClear?.addEventListener('click', async () => {
        if (!window.TMWishlist?.count?.()) return;
        let confirmed = true;
        if (window.Notify?.confirm){
          const res = await Notify.confirm('Hapus Wishlist', 'Yakin ingin menghapus semua produk dari wishlist?', 'Ya, hapus');
          confirmed = Boolean(res?.isConfirmed);
        } else {
          confirmed = window.confirm('Hapus semua produk dari wishlist?');
        }
        if (!confirmed) return;
        window.TMWishlist?.clear?.();
        renderWishlist(searchInput.value);
      });

      searchBtn.addEventListener('click', (event) => {
        event.preventDefault();
        handleSearch();
      });

      searchInput.addEventListener('keyup', (event) => {
        if (event.key === 'Enter'){
          handleSearch();
        }
      });

      window.addEventListener('tmWishlist:changed', () => {
        renderWishlist(searchInput.value);
      });
      window.addEventListener('storage', (event) => {
        if (event.key === 'tm_wishlist_items'){
          renderWishlist(searchInput.value);
        }
      });

      if (document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', () => renderWishlist(''));
      } else {
        renderWishlist('');
      }
    })();
  </script>
</body>
</html>
